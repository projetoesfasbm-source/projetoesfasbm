{% extends "base.html" %}

{% block title %}Quadro Hor치rio{% endblock %}

{% block content %}
<div class="horario-header-container">
    
    {% if priority_active %}
    <div class="alert alert-danger d-flex flex-column mb-3 shadow-sm border-danger" role="alert">
        <div class="d-flex align-items-center mb-2">
            <div class="me-3 bg-danger text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                <i class="fas fa-lock fa-lg"></i>
            </div>
            <div>
                <h5 class="alert-heading mb-0 fw-bold">Modo de Agendamento Priorit치rio Ativo</h5>
                <small>O quadro desta semana est치 <strong>bloqueado</strong>. Apenas as disciplinas selecionadas abaixo podem realizar agendamentos (em qualquer turma).</small>
            </div>
        </div>
        
        {% if priority_allowed_names %}
        <div class="mt-2 ms-5 ps-2">
            <strong>Disciplinas Permitidas:</strong>
            <ul class="mb-0 mt-1">
                {% for nome in priority_allowed_names %}
                    <li>{{ nome }}</li>
                {% else %}
                    <li><em>Nenhuma disciplina selecionada.</em></li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div class="page-title-with-controls">
        <div class="title-group">
            <h1>Quadro Hor치rio</h1>
            <p>Selecione um pelot칚o, ciclo e semana para visualizar o hor치rio correspondente.</p>
        </div>
        
        <div class="controls-group d-flex gap-2 flex-wrap justify-content-end align-items-center">
            
            {% if turma_atual and current_user.is_sens %}
                <button type="button" class="btn btn-info text-white shadow-sm fw-bold" data-bs-toggle="modal" data-bs-target="#modalDataFormatura">
                    <i class="fas fa-graduation-cap me-1"></i> 
                    {% if turma_atual.data_formatura %}
                        Formatura: {{ turma_atual.data_formatura.strftime('%d/%m/%Y') }}
                    {% else %}
                        Definir Data Formatura
                    {% endif %}
                </button>
            {% endif %}

            {% if current_user.is_sens %}
                <a href="{{ url_for('semana.gerenciar_semanas') }}" class="btn btn-dark shadow-sm fw-bold">
                    <i class="fas fa-calendar-plus me-1"></i> Gerenciar Semanas / Ciclos
                </a>
            {% endif %}

            {% if semana_selecionada %}
                {% if current_user.is_sens %}
                    <button type="button" class="btn {% if priority_active %}btn-danger text-white{% else %}btn-warning{% endif %} fw-bold shadow-sm" 
                            data-bs-toggle="modal" data-bs-target="#priorityModal">
                        <i class="fas fa-star me-1"></i> 
                        {% if priority_active %}Prioridade ATIVA{% else %}Configurar Prioridade{% endif %}
                    </button>

                    <a href="{{ url_for('horario.exportar_pdf', pelotao=pelotao_selecionado, semana_id=semana_selecionada.id) }}" class="btn btn-danger" target="_blank">
                        <i class="fas fa-file-pdf me-1"></i> PDF
                    </a>
                {% endif %}
                
                {% if can_schedule_in_this_turma or current_user.is_sens %}
                    <a href="{{ url_for('horario.editar_horario_grid', pelotao=pelotao_selecionado, semana_id=semana_selecionada.id, ciclo_id=ciclo_selecionado) }}" class="btn btn-primary">
                        <i class="fas fa-edit me-1"></i> Agendar/Desmarcar Aulas
                    </a>
                {% else %}
                    {% if current_user.role == 'instrutor' %}
                        <button class="btn btn-secondary" disabled title="Voc칡 n칚o tem permiss칚o nesta turma ou o modo prioridade est치 ativo para outras disciplinas.">
                            <i class="fas fa-lock"></i> Agendamento Bloqueado
                        </button>
                    {% endif %}
                {% endif %}
            {% endif %}
        </div>
    </div>

    <div class="filters-bar card p-3 mb-4 shadow-sm">
        <form method="GET" action="{{ url_for('horario.index') }}" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="ciclo_id" class="form-label fw-bold">Ciclo</label>
                <select name="ciclo" id="ciclo_id" class="form-select" onchange="this.form.submit()">
                    {% for ciclo in ciclos %}
                    <option value="{{ ciclo.id }}" {% if ciclo.id == ciclo_selecionado %}selected{% endif %}>{{ ciclo.nome }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-4">
                <label for="semana_id" class="form-label fw-bold">Semana</label>
                <select name="semana_id" id="semana_id" class="form-select" onchange="this.form.submit()">
                    {% for semana in todas_as_semanas %}
                    <option value="{{ semana.id }}" {% if semana_selecionada and semana.id == semana_selecionada.id %}selected{% endif %}>
                        {{ semana.nome }} ({{ semana.data_inicio.strftime('%d/%m') }} a {{ semana.data_fim.strftime('%d/%m') }})
                        {% if semana.priority_active %} 游 {% endif %}
                    </option>
                    {% else %}
                        <option value="">Nenhuma semana dispon칤vel</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label for="pelotao" class="form-label fw-bold">Pelot칚o</label>
                <select name="pelotao" id="pelotao" class="form-select" onchange="this.form.submit()">
                    {% for turma in todas_as_turmas %}
                    <option value="{{ turma.nome }}" {% if turma.nome == pelotao_selecionado %}selected{% endif %}>{{ turma.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-2">
               <button type="submit" class="btn btn-primary w-100"><i class="fas fa-sync-alt"></i> Atualizar</button>
            </div>
        </form>
    </div>
</div>

<div class="horario-content">
    {% if not horario_matrix %}
        <div class="empty-state">
            <div class="empty-icon">游늰</div>
            <h3>Nenhum hor치rio para exibir</h3>
            
            {% if current_user.is_sens and not todas_as_semanas %}
                <p class="text-danger">N칚o h치 semanas cadastradas neste ciclo.</p>
                <a href="{{ url_for('semana.gerenciar_semanas') }}" class="btn btn-primary mt-3 btn-lg">
                    <i class="fas fa-plus-circle"></i> Criar Primeira Semana
                </a>
            {% else %}
                <p>Selecione um pelot칚o e uma semana v치lida para carregar a grade hor치ria.</p>
            {% endif %}
        </div>
    {% else %}
        <div class="table-wrapper">
            <table class="horario-table-new">
                <thead>
                    <tr>
                        <th class="header-tempo">Hor치rio</th>
                        <th class="header-dia">Segunda-feira <br><small>({{ datas_semana.segunda }})</small></th>
                        <th class="header-dia">Ter칞a-feira <br><small>({{ datas_semana.terca }})</small></th>
                        <th class="header-dia">Quarta-feira <br><small>({{ datas_semana.quarta }})</small></th>
                        <th class="header-dia">Quinta-feira <br><small>({{ datas_semana.quinta }})</small></th>
                        <th class="header-dia">Sexta-feira <br><small>({{ datas_semana.sexta }})</small></th>
                    </tr>
                </thead>
                <tbody>
                    {% for row_idx in range(15) %}
                        {% set periodo_num = row_idx + 1 %}
                        {% if (periodo_num <= 12) or 
                              (periodo_num == 13 and semana_selecionada.mostrar_periodo_13) or
                              (periodo_num == 14 and semana_selecionada.mostrar_periodo_14) or
                              (periodo_num == 15 and semana_selecionada.mostrar_periodo_15) %}
                        
                        <tr class="periodo-row">
                            <td class="cell-tempo"><strong>{{ tempos[row_idx][0] }}</strong><span>{{ tempos[row_idx][1] }}</span></td>
                            {% for col_idx in range(5) %}
                                {% set aula = horario_matrix[row_idx][col_idx] %}
                                
                                {% if aula %}
                                    {% include 'partials/_horario_slot_view.html' %}
                                {% else %}
                                    <td class="schedule-slot free {% if priority_active and not can_schedule_in_this_turma %}blocked-slot{% endif %}"></td>
                                {% endif %}
                                
                            {% endfor %}
                        </tr>
                        
                        {% if row_idx == 2 %}<tr><td colspan="6" class="bg-secondary text-white py-1 text-center small fw-bold text-uppercase">{{ intervalos.intervalo_1 }}</td></tr>{% endif %}
                        {% if row_idx == 5 %}<tr><td colspan="6" class="bg-secondary text-white py-1 text-center small fw-bold text-uppercase">{{ intervalos.almoco }}</td></tr>{% endif %}
                        {% if row_idx == 8 %}<tr><td colspan="6" class="bg-secondary text-white py-1 text-center small fw-bold text-uppercase">{{ intervalos.intervalo_2 }}</td></tr>{% endif %}
                        
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if semana_selecionada.mostrar_sabado or semana_selecionada.mostrar_domingo %}
        <button class="weekend-toggle-btn" id="weekend-toggle">
            <span>Fim de Semana</span>
        </button>
        
        <div class="weekend-panel" id="weekend-panel">
            <div class="table-wrapper">
                <table class="horario-table-new weekend-table">
                    <thead>
                        <tr>
                            <th class="header-tempo">Hor치rio</th>
                            {% if semana_selecionada.mostrar_sabado %}<th class="header-dia weekend">S치bado <br><small>({{ datas_semana.sabado }})</small></th>{% endif %}
                            {% if semana_selecionada.mostrar_domingo %}<th class="header-dia weekend">Domingo <br><small>({{ datas_semana.domingo }})</small></th>{% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row_idx in range(15) %}
                            {% if (semana_selecionada.mostrar_sabado and loop.index <= semana_selecionada.periodos_sabado) or
                                  (semana_selecionada.mostrar_domingo and loop.index <= semana_selecionada.periodos_domingo) %}
                            <tr class="periodo-row">
                                <td class="cell-tempo"><strong>{{ tempos[row_idx][0] }}</strong><span>{{ tempos[row_idx][1] }}</span></td>
                                
                                {% if semana_selecionada.mostrar_sabado %}
                                    {% set aula = horario_matrix[row_idx][5] %}
                                    {% if aula %}
                                        {% include 'partials/_horario_slot_view.html' %}
                                    {% else %}
                                        <td class="schedule-slot free weekend-slot {% if priority_active and not can_schedule_in_this_turma %}blocked-slot{% endif %}"></td>
                                    {% endif %}
                                {% endif %}
                                
                                {% if semana_selecionada.mostrar_domingo %}
                                    {% set aula = horario_matrix[row_idx][6] %}
                                    {% if aula %}
                                        {% include 'partials/_horario_slot_view.html' %}
                                    {% else %}
                                        <td class="schedule-slot free weekend-slot {% if priority_active and not can_schedule_in_this_turma %}blocked-slot{% endif %}"></td>
                                    {% endif %}
                                {% endif %}
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block modals %}
{% if turma_atual %}
<div class="modal fade" id="modalDataFormatura" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-graduation-cap"></i> Data de Formatura - {{ turma_atual.nome }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('horario.salvar_data_formatura') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="turma_id" value="{{ turma_atual.id }}">
                    <div class="mb-3">
                        <label for="data_formatura" class="form-label fw-bold">Selecione a Data:</label>
                        <input type="date" class="form-control" id="data_formatura" name="data_formatura" 
                               value="{{ turma_atual.data_formatura.strftime('%Y-%m-%d') if turma_atual.data_formatura else '' }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-info text-white fw-bold">Salvar Data</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% if semana_selecionada and current_user.is_sens %}
<div class="modal fade" id="priorityModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title fw-bold">
          <i class="fas fa-star text-warning"></i> Configurar Prioridade (Disciplinas + Bloqueios)
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <div class="d-flex align-items-center justify-content-between p-3 bg-light border rounded mb-3">
          <div>
            <label class="form-check-label fw-bold mb-0 text-dark" for="priorityActive">
              Ativar Modo Prioridade
            </label>
            <div class="small text-muted">
              Bloqueia agendamentos de n칚o listados E permite bloquear per칤odos espec칤ficos.
            </div>
          </div>
          <div class="form-check form-switch m-0">
            <input class="form-check-input scale-125" type="checkbox" id="priorityActive"
                   {% if priority_active %}checked{% endif %}>
          </div>
        </div>

        <h6 class="fw-bold mb-2">1) Disciplinas Permitidas</h6>
        <div class="border rounded p-2 bg-white mb-4" style="max-height: 250px; overflow-y: auto;">
          {% for materia_nome in all_materias_names %}
          <div class="form-check border-bottom py-2">
            <input class="form-check-input priority-disc-check" 
                   type="checkbox" 
                   value="{{ materia_nome }}" 
                   id="disc-{{ loop.index }}"
                   {% if materia_nome in priority_allowed_names %}checked{% endif %}>
            <label class="form-check-label w-100" for="disc-{{ loop.index }}">
              {{ materia_nome }}
            </label>
          </div>
          {% endfor %}
        </div>

        <h6 class="fw-bold mb-2">2) Bloquear Per칤odos por Turma</h6>
        <p class="small text-muted">
          Marque os per칤odos que <strong>ficar칚o BLOQUEADOS</strong> quando o modo prioridade estiver ativo.
        </p>

        <div class="mb-3">
          <label for="turmaPrioritySelect" class="form-label fw-bold">Selecionar Turma:</label>
          <select id="turmaPrioritySelect" class="form-select">
            {% for turma in todas_as_turmas %}
            <option value="{{ turma.nome }}">{{ turma.nome }}</option>
            {% endfor %}
          </select>
        </div>

        {% for turma in todas_as_turmas %}
        <div class="card mb-3 priority-turma-card" data-turma-card="{{ turma.nome }}">
          <div class="card-header bg-light fw-bold">
            {{ turma.nome }}
          </div>
          <div class="card-body p-2">
            
            <table class="table table-sm table-bordered text-center align-middle">
              <thead>
                <tr>
                  <th>Per칤odo</th>
                  <th>Seg</th><th>Ter</th><th>Qua</th><th>Qui</th><th>Sex</th>
                </tr>
              </thead>
              <tbody>
                {% for p in range(1,16) %}
                <tr>
                  <td class="fw-bold">P{{ p }}</td>
                  {% for dia in ['segunda','terca','quarta','quinta','sexta'] %}
                  <td>
                    <input type="checkbox" 
                           class="block-check" 
                           data-turma="{{ turma.nome }}" 
                           data-dia="{{ dia }}"
                           data-periodo="P{{ p }}">
                  </td>
                  {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>

          </div>
        </div>
        {% endfor %}

      </div>

      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success fw-bold px-4" onclick="savePriorityConfig()">
          <i class="fas fa-save me-1"></i> Salvar Altera칞칫es
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script>
function savePriorityConfig() {
  const active = document.getElementById('priorityActive').checked;
  
  const names = Array.from(
    document.querySelectorAll('.priority-disc-check:checked')
  ).map(c => c.value);

  let bloqueios = {};

  document.querySelectorAll('.block-check:checked').forEach(ch => {
    const t = ch.dataset.turma;
    const d = ch.dataset.dia;
    const p = ch.dataset.periodo;

    if (!bloqueios[t]) bloqueios[t] = {};
    if (!bloqueios[t][d]) bloqueios[t][d] = [];
    bloqueios[t][d].push(p);
  });

  const btn = document.querySelector('#priorityModal .btn-success');
  const originalText = btn.innerHTML;
  btn.innerHTML = 'Salvando...';
  btn.disabled = true;

  fetch('/semana/{{ semana_selecionada.id }}/salvar-prioridade', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token() }}'
    },
    body: JSON.stringify({
      status: active,
      disciplinas: names,
      bloqueios: bloqueios
    })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert('Erro: ' + (data.message || 'desconhecido'));
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  })
  .catch(err => {
    console.error(err);
    alert('Erro de conex칚o.');
    btn.innerHTML = originalText;
    btn.disabled = false;
  });
}

// NOVA L칍GICA DE FILTRO POR TURMA
document.addEventListener('DOMContentLoaded', function() {
  const select = document.getElementById('turmaPrioritySelect');
  const cards = document.querySelectorAll('.priority-turma-card');

  function filtrarTurma() {
    const escolhida = select.value;
    
    cards.forEach(card => {
      if (card.dataset.turmaCard === escolhida) {
        card.style.display = 'block';
      } else {
        card.style.display = 'none';
      }
    });
  }

  if (select) {
    filtrarTurma(); // aplica ao abrir o modal
    select.addEventListener('change', filtrarTurma);
  }
});
</script>

<style>
.scale-125 { transform: scale(1.4); cursor: pointer; }
.blocked-slot { background-color: #fee2e2 !important; cursor: not-allowed; }
</style>

{% endblock %}