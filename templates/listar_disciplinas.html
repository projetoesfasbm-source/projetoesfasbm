{% extends "base.html" %}

{% block title %}Lista de Disciplinas{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    {# --- CABEÇALHO FLEX: Título à esquerda, Botões à direita --- #}
    <div class="content-header d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-primary fw-bold mb-0">
                <i class="fas fa-book me-2"></i>Disciplinas
            </h2>
            <p class="text-muted mb-0">Gerencie as matérias e acompanhe o andamento pelo Quadro de Horários.</p>
        </div>

        <div class="d-flex gap-2">
            {# --- BOTÃO NOVO DASHBOARD --- #}
            <a href="{{ url_for('disciplina.dashboard_disciplinas', ciclo_id=ciclo_selecionado_id) }}" class="btn btn-warning text-dark shadow-sm">
                <i class="fas fa-chart-line me-2"></i>Dashboard Inteligente
            </a>

            {# --- BOTÕES DE AÇÃO (Visíveis para Admins) --- #}
            {% if current_user.is_sens or current_user.role in ['programador', 'admin_escola'] %}
            <a href="{{ url_for('disciplina.adicionar_disciplina') }}" class="btn btn-primary shadow-sm">
                <i class="fas fa-plus me-1"></i> Adicionar Disciplina
            </a>
            <a href="{{ url_for('vinculo.gerenciar_vinculos') }}" class="btn btn-info text-white shadow-sm">
                <i class="fas fa-link me-1"></i> Vínculos
            </a>
            {% endif %}
        </div>
    </div>

    {# --- ÁREA DE FILTROS --- #}
    <div class="card shadow-sm border-0 mb-4 bg-light">
        <div class="card-body py-3">
            <form method="GET" action="{{ url_for('disciplina.listar_disciplinas') }}" id="filter-form" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="ciclo_select" class="form-label fw-bold text-secondary small text-uppercase">Ciclo</label>
                    <select name="ciclo_id" id="ciclo_select" class="form-select shadow-sm" onchange="this.form.submit()">
                        <option value="">Todos os Ciclos</option>
                        {% for c in ciclos %}
                        <option value="{{ c.id }}" {% if ciclo_selecionado_id == c.id %}selected{% endif %}>{{ c.nome }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-4">
                    <label for="turma_select" class="form-label fw-bold text-secondary small text-uppercase">Turma</label>
                    <select name="turma_id" id="turma_select" class="form-select shadow-sm" onchange="this.form.submit()">
                        <option value="">-- Selecione uma Turma --</option>
                        {% for t in turmas %}
                        {# Detecta a turma selecionada na URL ou pega a primeira disponível se nada selecionado #}
                        {% set is_selected = (request.args.get('turma_id')|int == t.id) %}
                        <option value="{{ t.id }}" {% if is_selected %}selected{% endif %}>{{ t.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>
    </div>

    {# --- CONTEÚDO PRINCIPAL (TABELA) --- #}
    {# Verifica se tem disciplinas para listar (independente se filtrou turma específica ou não) #}
    {% if disciplinas %}
        <div class="card shadow-sm border-0">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped align-middle mb-0">
                        <thead class="bg-light text-uppercase text-secondary small fw-bold">
                            <tr>
                                <th style="width: 30%;" class="ps-4 py-3">Matéria / Turma</th>
                                <th style="width: 10%;" class="text-center">Meta</th>
                                <th style="width: 40%;">Progresso (Quadro Horário)</th>
                                {% if current_user.is_sens or current_user.role in ['programador', 'admin_escola'] %}
                                <th style="width: 20%;" class="text-end pe-4">Ações</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for disciplina in disciplinas %}
                            <tr>
                                <td class="ps-4">
                                    <div class="d-flex flex-column">
                                        <a href="{{ url_for('disciplina.detalhes_disciplina', disciplina_id=disciplina.id) }}" class="fw-bold text-dark text-decoration-none hover-link" style="font-size: 1.05rem;">
                                            {{ disciplina.materia }} <i class="fas fa-search-plus small ms-1 text-primary opacity-50"></i>
                                        </a>
                                        <div class="d-flex gap-2 mt-1">
                                            <span class="badge bg-light text-dark border border-secondary fw-normal">
                                                <i class="fas fa-users me-1 text-muted"></i> {{ disciplina.turma.nome if disciplina.turma else 'Sem Turma' }}
                                            </span>
                                            {% if disciplina.ciclo %}
                                            <span class="badge bg-light text-dark border fw-normal text-muted">
                                                {{ disciplina.ciclo.nome }}
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-dark rounded-pill fs-6">{{ disciplina.carga_horaria_prevista }}h</span>
                                </td>
                                <td class="py-3">
                                    {# CÁLCULOS DE PROGRESSO INLINE (Para manter leveza sem backend pesado aqui) #}
                                    {% set realizado = disciplina.carga_horaria_cumprida %}
                                    {% set total = disciplina.carga_horaria_prevista %}
                                    {% set pct_realizado = (realizado / total * 100)|round|int if total > 0 else 0 %}
                                    {# Agendado futuro seria ideal vir do backend, mas aqui usamos o realizado como base #}
                                    
                                    <div class="d-flex flex-column gap-1 w-100 pe-3">
                                        <div class="progress" style="height: 20px; border-radius: 6px; background-color: #e9ecef; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);">
                                            {# Barra VERDE: Realizado #}
                                            <div class="progress-bar bg-success" role="progressbar" 
                                                 style="width: {{ pct_realizado }}%;" 
                                                 title="Realizado: {{ realizado }}h">
                                                 {% if pct_realizado > 10 %}{{ realizado }}h{% endif %}
                                            </div>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between small px-1 text-muted fw-bold" style="font-size: 0.75rem;">
                                            <span class="text-success">
                                                <i class="fas fa-check-circle me-1"></i>{{ pct_realizado }}% Concluído
                                            </span>
                                            
                                            {% set restante = total - realizado %}
                                            {% if restante > 0 %}
                                                <span class="text-danger">
                                                    <i class="fas fa-hourglass-half me-1"></i>Restam: {{ restante }}h
                                                </span>
                                            {% else %}
                                                <span class="text-primary">
                                                    <i class="fas fa-thumbs-up me-1"></i>Completo
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                
                                {% if current_user.is_sens or current_user.role in ['programador', 'admin_escola'] %}
                                <td class="text-end pe-4 align-middle">
                                    <div class="btn-group shadow-sm">
                                        <a href="{{ url_for('disciplina.editar_disciplina', disciplina_id=disciplina.id) }}" 
                                           class="btn btn-sm btn-outline-warning text-dark fw-bold" 
                                           title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                onclick="if(confirm('Tem certeza que deseja excluir {{ disciplina.materia }}?')) document.getElementById('delete-form-{{ disciplina.id }}').submit();"
                                                title="Excluir">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    
                                    <form id="delete-form-{{ disciplina.id }}" action="{{ url_for('disciplina.excluir_disciplina', disciplina_id=disciplina.id) }}" method="POST" style="display: none;">
                                        {{ delete_form.hidden_tag() }}
                                    </form>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% else %}
        <div class="alert alert-info mt-4 shadow-sm text-center p-5 rounded-3 border-0 bg-white">
            <div class="mb-3 text-info opacity-50 display-4"><i class="fas fa-folder-open"></i></div>
            <h4 class="fw-bold text-dark">Nenhuma Disciplina Encontrada</h4>
            <p class="text-muted mb-4">Utilize os filtros acima ou cadastre uma nova disciplina.</p>
            {% if current_user.is_sens or current_user.role in ['programador', 'admin_escola'] %}
            <a href="{{ url_for('disciplina.adicionar_disciplina') }}" class="btn btn-primary btn-lg shadow-sm">
                <i class="fas fa-plus me-2"></i>Cadastrar Agora
            </a>
            {% endif %}
        </div>
    {% endif %}
</div>

<style>
.hover-link:hover { 
    text-decoration: underline !important; 
    color: #0d6efd !important; 
}
.table-hover tbody tr:hover {
    background-color: rgba(0,0,0,0.02);
}
</style>
{% endblock %}