{% extends "base.html" %}

{% block content %}
<style>
    /* ESTILO DOS BOTÕES (ABAS SÓLIDAS) */
    .nav-pills .nav-link {
        background-color: #6c757d; /* Cinza (Inativo) */
        color: white !important;
        font-weight: bold;
        margin-right: 10px;
        border-radius: 8px;
        border: 1px solid #5a6268;
    }
    
    .nav-pills .nav-link:hover {
        background-color: #5a6268;
    }

    .nav-pills .nav-link.active {
        background-color: #0d6efd !important; /* Azul (Ativo) */
        border-color: #0a58ca;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    /* CONTAINER DA ASSINATURA RESPONSIVO */
    .signature-wrapper {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 50%; /* Proporção 2:1 (Retângulo agradável) */
        border: 2px solid #0d6efd; /* Borda azul para destacar a área */
        background-color: #ffffff;
        border-radius: 8px;
        touch-action: none; /* IMPEDE O SCROLL DA TELA AO DESENHAR */
    }

    /* CANVAS PREENCHENDO O CONTAINER */
    #signaturePad {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        border-radius: 6px;
    }

    /* AJUSTE PARA TELAS MUITO PEQUENAS */
    @media (max-width: 576px) {
        .signature-wrapper {
            padding-bottom: 65%; /* Um pouco mais alto no celular para facilitar o dedo */
        }
    }
</style>

<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-file-contract me-2"></i>Validar Diário de Classe</h4>
        </div>
        <div class="card-body">
            
            <div class="alert alert-secondary border-0 shadow-sm text-dark mb-4">
                <div class="row">
                    <div class="col-md-6">
                        <strong><i class="far fa-calendar-alt me-1"></i> Data:</strong> {{ diario.data_aula.strftime('%d/%m/%Y') }}<br>
                        <strong><i class="fas fa-users me-1"></i> Turma:</strong> {{ diario.turma.nome }}<br>
                        <strong><i class="fas fa-book me-1"></i> Disciplina:</strong> {{ diario.disciplina.materia }}
                    </div>
                    <div class="col-md-6 text-md-end mt-2 mt-md-0">
                        <strong><i class="fas fa-user-tie me-1"></i> Instrutor:</strong><br>
                        {{ current_user.posto_graduacao }} {{ current_user.nome_de_guerra }}
                    </div>
                </div>
            </div>

            {% if diario.periodo_resumo %}
            <div class="alert alert-info border-0 shadow-sm d-flex align-items-center mb-4">
                <i class="fas fa-info-circle fa-2x me-3"></i>
                <div>
                    <strong>Validação em Bloco:</strong><br>
                    Você está editando e assinando <strong>{{ diario.total_aulas_bloco }} aulas</strong> consecutivas ({{ diario.periodo_resumo }}).
                </div>
            </div>
            {% endif %}

            <form method="POST" enctype="multipart/form-data" id="formAssinatura">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="tipo_assinatura" id="tipo_assinatura" value="">
                <input type="hidden" name="assinatura_base64" id="assinatura_base64">

                <div class="mb-4">
                    <label for="conteudo_ministrado" class="form-label text-muted fw-bold">Conteúdo Ministrado:</label>
                    <textarea class="form-control shadow-sm" id="conteudo_ministrado" name="conteudo_ministrado" rows="5" required>{{ diario.conteudo_ministrado }}</textarea>
                    <div class="form-text">Você pode ajustar o conteúdo ministrado antes de assinar.</div>
                </div>

                <div class="mb-4">
                    <label for="observacoes" class="form-label text-muted fw-bold">Observações:</label>
                    <textarea class="form-control shadow-sm" id="observacoes" name="observacoes" rows="3">{{ diario.observacoes }}</textarea>
                    <div class="form-text">Registre ocorrências ou detalhes relevantes da aula.</div>
                </div>

                <hr class="my-4">

                <h5 class="mb-3"><i class="fas fa-pen-nib me-2"></i>Assinatura do Instrutor</h5>
                
                <ul class="nav nav-pills mb-3" id="signTab" role="tablist">
                    {% if instrutor.assinatura_padrao_path %}
                    <li class="nav-item">
                        <button class="nav-link active" id="saved-tab" data-bs-toggle="pill" data-bs-target="#saved" type="button" onclick="setTipo('padrao')">
                            <i class="fas fa-save me-2"></i> Usar Salva
                        </button>
                    </li>
                    {% endif %}
                    
                    <li class="nav-item">
                        <button class="nav-link {% if not instrutor.assinatura_padrao_path %}active{% endif %}" id="draw-tab" data-bs-toggle="pill" data-bs-target="#draw" type="button" onclick="setTipo('canvas')">
                            <i class="fas fa-pen me-2"></i> Desenhar
                        </button>
                    </li>
                    
                    <li class="nav-item">
                        <button class="nav-link" id="upload-tab" data-bs-toggle="pill" data-bs-target="#upload" type="button" onclick="setTipo('upload')">
                            <i class="fas fa-upload me-2"></i> Upload
                        </button>
                    </li>
                </ul>

                <div class="tab-content p-3 border rounded bg-white shadow-sm">
                    
                    {% if instrutor.assinatura_padrao_path %}
                    <div class="tab-pane fade show active" id="saved" role="tabpanel">
                        <div class="text-center py-3">
                            <p class="text-muted fw-bold">Sua assinatura salva será utilizada:</p>
                            <div class="d-inline-block border p-2 bg-white rounded">
                                <img src="{{ url_for('static', filename=instrutor.assinatura_padrao_path) }}" class="img-fluid" style="max-height: 120px;">
                            </div>
                            <div class="mt-3 text-success fw-bold">
                                <i class="fas fa-check-circle fa-lg"></i> Pronta para uso
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="tab-pane fade {% if not instrutor.assinatura_padrao_path %}show active{% endif %}" id="draw" role="tabpanel">
                        <div class="text-center">
                            <p class="small text-muted mb-2"><i class="fas fa-hand-pointer"></i> Assine na caixa abaixo:</p>
                            
                            <div class="signature-wrapper mb-2">
                                <canvas id="signaturePad"></canvas>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <button type="button" class="btn btn-secondary btn-sm" onclick="clearPad()">
                                    <i class="fas fa-eraser"></i> Limpar Tela
                                </button>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="saveCanvas" name="salvar_padrao">
                                    <label class="form-check-label fw-bold" for="saveCanvas">Salvar como Padrão</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="upload" role="tabpanel">
                        <div class="py-3">
                            <label class="form-label fw-bold">Selecione uma imagem (PNG/JPG):</label>
                            <input class="form-control mb-3" type="file" name="assinatura_upload" accept="image/png, image/jpeg, image/jpg">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="saveUpload" name="salvar_padrao">
                                <label class="form-check-label fw-bold" for="saveUpload">Salvar como Padrão</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-success btn-lg fw-bold shadow" onclick="prepareSubmit(event)">
                        <i class="fas fa-check-double me-2"></i> Confirmar Validação
                    </button>
                    <a href="{{ url_for('diario.listar_pendentes') }}" class="btn btn-outline-danger fw-bold">
                        Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script>
    var canvas = document.getElementById('signaturePad');
    // Inicialização básica
    var signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(0, 0, 0)',
        minWidth: 1.5, // Linha um pouco mais grossa para visibilidade mobile
        maxWidth: 3.5
    });

    // FUNÇÃO CRÍTICA PARA MOBILE: Ajusta a resolução interna do canvas
    function resizeCanvas() {
        // Pega o elemento pai para saber a largura real disponível na tela
        var parentWidth = canvas.parentElement.offsetWidth;
        var parentHeight = canvas.parentElement.offsetHeight;

        // Ratio corrige a densidade de pixels (Retina display, etc)
        var ratio = Math.max(window.devicePixelRatio || 1, 1);

        // Define o tamanho visual (CSS)
        canvas.width = parentWidth * ratio;
        canvas.height = parentHeight * ratio;
        
        // Escala o contexto do canvas para desenhar corretamente
        canvas.getContext("2d").scale(ratio, ratio);

        // Limpa (necessário após redimensionar) e mantém dados se houver (opcional, aqui limpamos)
        signaturePad.clear(); 
    }

    // Chama no carregamento
    window.addEventListener("load", resizeCanvas);
    // Chama se o usuário girar o celular
    window.addEventListener("resize", resizeCanvas);
    // Chama quando a aba "Desenhar" for clicada (para garantir renderização correta se estava oculta)
    document.getElementById('draw-tab').addEventListener('shown.bs.tab', resizeCanvas);

    function clearPad() { 
        signaturePad.clear(); 
    }

    // Lógica de Tabs e Submit (Mantida)
    var hasSaved = {{ 'true' if instrutor.assinatura_padrao_path else 'false' }};
    document.getElementById('tipo_assinatura').value = hasSaved ? 'padrao' : 'canvas';

    function setTipo(tipo) {
        document.getElementById('tipo_assinatura').value = tipo;
        if(tipo === 'padrao') {
            document.querySelectorAll('input[name="salvar_padrao"]').forEach(el => el.checked = false);
        }
        // Se clicar em desenhar, força um resize rápido para garantir coordenadas
        if(tipo === 'canvas') {
            setTimeout(resizeCanvas, 100);
        }
    }

    function prepareSubmit(e) {
        var tipo = document.getElementById('tipo_assinatura').value;
        
        if (tipo === 'canvas') {
            if (signaturePad.isEmpty()) {
                e.preventDefault();
                alert('Por favor, faça sua assinatura.');
                return;
            }
            document.getElementById('assinatura_base64').value = signaturePad.toDataURL();
        } 
        else if (tipo === 'upload') {
            var fileInput = document.querySelector('input[name="assinatura_upload"]');
            if (!fileInput.files.length) {
                e.preventDefault();
                alert('Selecione um arquivo.');
                return;
            }
        }
    }
</script>
{% endblock %}