{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="fas fa-signature me-2"></i>Validação de Diários</h2>
        {% if is_admin %}
        <span class="badge bg-danger">Modo Administrador</span>
        {% endif %}
    </div>
    
    <div class="card shadow-sm mb-4 bg-light">
        <div class="card-body py-3">
            <form method="GET" action="{{ url_for('diario.listar_pendentes') }}" class="row g-3 align-items-end">
                
                <div class="col-md-5">
                    <label class="fw-bold small text-muted"><i class="fas fa-users me-1"></i> Turma</label>
                    <select name="turma_id" class="form-select" onchange="this.form.submit()">
                        <option value="">-- Todas as Turmas --</option>
                        {% for t in turmas %}
                        <option value="{{ t.id }}" {% if sel_turma == t.id %}selected{% endif %}>
                            {{ t.nome }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-5">
                    <label class="fw-bold small text-muted"><i class="fas fa-book me-1"></i> Disciplina</label>
                    <select name="disciplina_id" class="form-select" onchange="this.form.submit()">
                        <option value="">-- Todas as Disciplinas --</option>
                        {% for d in disciplinas %}
                        <option value="{{ d.id }}" {% if sel_disciplina == d.id %}selected{% endif %}>
                            {{ d.materia }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    {% if sel_turma or sel_disciplina %}
                    <a href="{{ url_for('diario.listar_pendentes') }}" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-times me-1"></i> Limpar
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    {% if diarios %}
    <div class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Data</th>
                        <th>Turma</th>
                        <th>Disciplina</th>
                        <th>Período</th>
                        <th>Instrutor (Titular)</th>
                        <th>Status</th>
                        <th class="text-end">Ação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for diario in diarios %}
                    <tr>
                        <td>{{ diario.data_aula.strftime('%d/%m/%Y') }}</td>
                        <td><span class="fw-bold text-primary">{{ diario.turma.nome }}</span></td>
                        <td>{{ diario.disciplina.materia }}</td>
                        <td>{{ diario.periodo }}º</td>
                        <td>
                            {# Busca dinâmica do instrutor titular no template para conferência do admin #}
                            {% set aula = diario.horario_ref if diario.horario_ref else None %} 
                            {# Nota: como não temos o obj horario direto no diario sem join,
                               usamos uma lógica simplificada ou apenas exibimos o logado.
                               Para o Admin, seria ideal ver quem deve assinar.
                               Mas para simplificar visualmente agora: #}
                            <span class="small text-muted">Ver no detalhe</span>
                        </td>
                        <td><span class="badge bg-warning text-dark">Pendente</span></td>
                        <td class="text-end">
                            <a href="{{ url_for('diario.assinar', diario_id=diario.id) }}" class="btn btn-primary btn-sm shadow-sm">
                                <i class="fas fa-pen-nib me-1"></i> Analisar
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="mt-2 text-end text-muted small">
        Total de pendências encontradas: {{ diarios|length }}
    </div>
    {% else %}
    <div class="alert alert-success mt-3 text-center p-4">
        <i class="fas fa-check-circle fa-3x mb-3 text-success opacity-50"></i>
        <h5>Tudo em dia!</h5>
        <p class="text-muted mb-0">Nenhum diário pendente encontrado com os filtros selecionados.</p>
    </div>
    {% endif %}
</div>
{% endblock %}