{% extends "base.html" %}

{% block title %}Editar Aluno - {{ aluno.user.nome_completo }}{% endblock %}

{% block content %}
<div class="content-header">
    <h1>Editar Perfil do Aluno: <br> {{ aluno.user.nome_completo }}</h1>
</div>

<div class="turma-details-grid">
    <div class="auth-container" style="grid-column: 1 / -1;">
        <div class="auth-card" style="max-width: 800px;">
            <form method="POST" action="{{ url_for('aluno.editar_aluno', aluno_id=aluno.id) }}">
                {{ form.hidden_tag() }}
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.nome_completo.label(class="form-label") }}
                            {{ form.nome_completo(class="form-control") }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.email.label(class="form-label") }}
                            {{ form.email(class="form-control") }}
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="matricula">Matrícula</label>
                    <input type="text" id="matricula" name="matricula" class="form-control" value="{{ aluno.user.matricula }}" readonly>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.posto_categoria.label(class="form-label") }}
                            {{ form.posto_categoria(class="form-control", id="posto_categoria") }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.posto_graduacao.label(class="form-label") }}
                            {{ form.posto_graduacao(class="form-control", id="posto_graduacao") }}
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.turma_id.label(class="form-label") }}
                            {{ form.turma_id(class="form-control") }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            {{ form.opm.label(class="form-label") }}
                            {{ form.opm(class="form-control") }}
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <a href="{{ url_for('aluno.listar_alunos') }}" class="btn btn-secondary">Cancelar</a>
                    {{ form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>

    <div class="details-section" style="grid-column: 1 / -1;">
        <div class="section-header">
            <h3>Função de Escola</h3>
        </div>
        <div class="cargo-item">
            <label>Função Atual</label>
            <div class="cargo-assignee">
                {% if aluno.funcao_atual %}
                    {{ aluno.funcao_atual }}
                {% else %}
                    <span class="text-muted">-- Nenhuma --</span>
                {% endif %}
            </div>
            <button class="btn btn-sm btn-secondary" onclick="openFuncaoModal('{{ aluno.funcao_atual or '' }}')">Gerenciar</button>
        </div>
    </div>
</div>

<style>
.turma-details-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
.details-section { background: var(--color-white); border-radius: var(--border-radius); padding: 2rem; box-shadow: var(--shadow-soft); border: 1px solid var(--color-border); }
.section-header { padding-bottom: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--color-border); }
.section-header h3 { font-size: 1.5rem; font-weight: 700; margin: 0; }
.cargo-item { display: grid; grid-template-columns: 1fr auto auto; align-items: center; gap: 1rem; padding: 0.75rem; border-radius: 8px; background-color: #f8fafc; border: 1px solid #e2e8f0; }
.cargo-item label { font-weight: 600; }
.cargo-assignee { text-align: right; font-size: 0.9rem; color: #333; }
</style>
{% endblock %}

{% block modals %}
<div class="modal-overlay" id="funcaoModal">
    <div class="modal-content">
        <form id="funcaoForm" method="POST" action="{{ url_for('aluno.editar_funcao_aluno', aluno_id=aluno.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <h3>Gerenciar Função de Escola</h3>
            <div class="form-group">
                <label for="modalFuncaoSelect">Selecione a Função</label>
                <select id="modalFuncaoSelect" name="funcao_atual" class="form-control" onchange="updateDateLabelFuncao(this)">
                    <option value="">-- Remover da Função (Nenhuma) --</option>
                    {% for choice in form.funcao_atual.choices %}
                        {% if choice[0] %}
                        <option value="{{ choice[0] }}">{{ choice[1] }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="modalDataEventoFuncao" id="modalDataLabelFuncao">Data</label>
                <input type="date" id="modalDataEventoFuncao" name="data_evento" class="form-control" required>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeFuncaoModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Salvar Alteração</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const postosData = {{ postos_data | tojson }};
    const categoriaSelect = document.getElementById('posto_categoria');
    const postoSelect = document.getElementById('posto_graduacao');
    
    function updatePostoOptions() {
        const selectedCategoria = categoriaSelect.value;
        const postos = postosData[selectedCategoria] || [];
        const currentPostoValue = postoSelect.value;
        
        postoSelect.innerHTML = '';
        postos.forEach(posto => {
            const option = new Option(posto, posto);
            postoSelect.add(option);
        });

        if (postos.includes(currentPostoValue)) {
            postoSelect.value = currentPostoValue;
        }
    }

    categoriaSelect.addEventListener('change', updatePostoOptions);
    updatePostoOptions(); // Run on page load
});

const funcaoModal = document.getElementById('funcaoModal');
const modalFuncaoSelect = document.getElementById('modalFuncaoSelect');
const modalDataLabelFuncao = document.getElementById('modalDataLabelFuncao');
const modalDataEventoFuncao = document.getElementById('modalDataEventoFuncao');

function updateDateLabelFuncao(selectElement) {
    if (selectElement.value === "") {
        modalDataLabelFuncao.textContent = "Data de Fim da Função";
    } else {
        modalDataLabelFuncao.textContent = "Data de Início da Função";
    }
}

function openFuncaoModal(funcaoAtual) {
    modalFuncaoSelect.value = funcaoAtual;
    modalDataEventoFuncao.valueAsDate = new Date();
    updateDateLabelFuncao(modalFuncaoSelect);
    funcaoModal.classList.add('visible');
    document.body.style.overflow = 'hidden';
}

function closeFuncaoModal() {
    funcaoModal.classList.remove('visible');
    document.body.style.overflow = '';
}

window.onclick = function(event) {
    if (event.target == funcaoModal) {
        closeFuncaoModal();
    }
}
</script>
{% endblock %}