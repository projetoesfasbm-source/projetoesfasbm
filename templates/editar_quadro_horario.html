{% extends "base.html" %}

{% block title %}Editar Quadro Horário{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-0">
                {% if is_admin %}
                Editando: <span class="text-primary">{{ pelotao_selecionado }}</span>
                {% else %}
                Agendamento: <span class="text-primary">{{ pelotao_selecionado }}</span>
                {% endif %}
            </h2>
            <p class="text-muted">
                Semana: <strong>{{ semana_selecionada.nome }}</strong> ({{ semana_selecionada.data_inicio.strftime('%d/%m') }} a {{ semana_selecionada.data_fim.strftime('%d/%m') }})
            </p>
        </div>
        <div>
            <button type="button" class="btn btn-secondary me-2" onclick="window.history.back()">Voltar</button>
            <button type="button" class="btn btn-info me-2" data-bs-toggle="modal" data-bs-target="#ajudaModal">
                <i class="fas fa-question-circle"></i> Ajuda
            </button>
        </div>
    </div>

    <div class="card mb-3 shadow-sm" style="border: 1px solid #000;">
        <div class="card-body py-2">
            <div class="d-flex gap-4 align-items-center flex-wrap">
                <span class="badge bg-white text-dark border border-dark"><i class="fas fa-plus me-1"></i> Disponível</span>
                <span class="badge bg-success border border-dark">Confirmado (Seu/Admin)</span>
                <span class="badge bg-warning text-dark border border-dark">Pendente (Aguardando)</span>
                <span class="badge bg-danger border border-dark">Bloqueado (Outro Instrutor)</span>
            </div>
        </div>
    </div>

    {% set max_periodo_semana = 12 %}
    {% if semana_selecionada.mostrar_periodo_15 %}
        {% set max_periodo_semana = 15 %}
    {% elif semana_selecionada.mostrar_periodo_14 %}
        {% set max_periodo_semana = 14 %}
    {% elif semana_selecionada.mostrar_periodo_13 %}
        {% set max_periodo_semana = 13 %}
    {% endif %}

    <div class="table-responsive">
        <table class="table table-bordered table-bordered-black text-center align-middle horario-grid-editor">
            <thead class="table-dark">
                <tr>
                    <th style="width: 100px; border: 1px solid #fff;">Horário</th>
                    {% for dia in datas_semana %}
                    <th style="border: 1px solid #fff;">
                        {{ dia|capitalize }}
                        <br>
                        <small class="text-white-50">{{ datas_semana[dia] }}</small>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row_idx in range(15) %}
                
                {% set periodo_atual = row_idx + 1 %}
                {% if periodo_atual <= max_periodo_semana %}
                
                <tr>
                    <td class="bg-light fw-bold text-dark">
                        <div class="small">{{ tempos[row_idx][0] }}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">{{ tempos[row_idx][1] }}</div>
                    </td>

                    {% for col_idx in range(7) %} {% set aula = horario_matrix[row_idx][col_idx] %}
                        
                        {% if aula == 'SKIP' %}
                            <td style="display: none;"></td>
                        
                        {% else %}
                            {% set cell_class = '' %}
                            {% set cell_onclick = '' %}
                            {% set cell_content = '' %}
                            {% set rowspan_val = aula.duracao %}

                            {% if aula.is_disposicao %}
                                {% set cell_class = 'cell-disponivel' %}
                                {% set cell_onclick = "openAgendarModal('" ~ pelotao_selecionado ~ "', " ~ semana_selecionada.id ~ ", '" ~ ['segunda','terca','quarta','quinta','sexta','sabado','domingo'][col_idx] ~ "', " ~ (row_idx + 1) ~ ")" %}
                                {% set cell_content = '<i class="fas fa-plus fa-lg text-secondary"></i>' %}
                            
                            {% else %}
                                {% if aula.can_edit %}
                                    {% if aula.status == 'pendente' %}
                                        {% set cell_class = 'cell-pendente' %}
                                        {% set cell_content = aula.materia ~ '<br><small>(Pendente)</small>' %}
                                    {% else %}
                                        {% set cell_class = 'cell-confirmada' %}
                                        {% set cell_content = aula.materia %}
                                    {% endif %}
                                    {% set cell_onclick = "openEditarModal(" ~ aula.id ~ ", '" ~ aula.materia ~ "', " ~ aula.duracao ~ ", '" ~ aula.status ~ "')" %}
                                
                                {% else %}
                                    {% set cell_class = 'cell-bloqueada' %}
                                    {% set cell_content = aula.materia ~ '<br><small class="text-dark-50">' ~ (aula.instrutor or 'Outro') ~ '</small>' %}
                                {% endif %}
                            {% endif %}

                            <td rowspan="{{ rowspan_val }}" 
                                class="{{ cell_class }}" 
                                onclick="{{ cell_onclick }}"
                                style="cursor: pointer; height: 50px;">
                                <div class="cell-content">
                                    {{ cell_content|safe }}
                                </div>
                            </td>
                        {% endif %}
                    {% endfor %}
                </tr>
                
                {% if row_idx == 2 or row_idx == 5 or row_idx == 8 %}
                <tr class="intervalo-row">
                    <td colspan="8" class="bg-secondary text-white py-1 border-black" style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; font-weight: bold;">
                        {% if row_idx == 2 %}Intervalo Manhã ({{ intervalos.intervalo_1 }}){% endif %}
                        {% if row_idx == 5 %}Almoço ({{ intervalos.almoco }}){% endif %}
                        {% if row_idx == 8 %}Intervalo Tarde ({{ intervalos.intervalo_2 }}){% endif %}
                    </td>
                </tr>
                {% endif %}
                
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% include '_horario_modal.html' %}

<div class="modal fade" id="ajudaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Como usar o Agendador</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul>
                    <li><strong>Agendar:</strong> Clique no símbolo <i class="fas fa-plus"></i> para adicionar uma aula.</li>
                    <li><strong>Editar/Remover:</strong> Clique em uma célula colorida que você tenha permissão.</li>
                    <li><strong>Blocos:</strong> Ao selecionar mais de 1 período, o sistema agrupa automaticamente.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
    /* ESTILOS DE BORDA FORTE PARA VISUALIZAÇÃO E IMPRESSÃO */
    .table-bordered-black, 
    .table-bordered-black th, 
    .table-bordered-black td {
        border: 1px solid #000 !important; /* Borda PRETA Sólida */
    }
    
    .horario-grid-editor th, .horario-grid-editor td {
        vertical-align: middle;
        position: relative;
    }
    
    /* Cores das Células */
    .cell-disponivel { background-color: #fff; } /* Branco limpo */
    .cell-disponivel:hover { background-color: #f0f0f0; }
    
    .cell-confirmada { background-color: #d1e7dd; color: #0f5132; }
    .cell-pendente { background-color: #fff3cd; color: #664d03; }
    .cell-bloqueada { background-color: #f8d7da; color: #842029; opacity: 0.9; }

    /* Centralização do conteúdo */
    .cell-content {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        width: 100%;
        min-height: 40px;
        font-weight: 500;
    }
    
    /* Destaque para o separador de intervalo */
    .intervalo-row td {
        border-top: 2px solid #000 !important;
        border-bottom: 2px solid #000 !important;
        background-color: #6c757d !important;
        color: #fff !important;
    }
</style>

<script>
    // Variáveis globais de controle
    let modalAula = null;
    let formAula = null;
    let instrutorSelect = null;
    let btnRemover = null;
    let modalTitle = null;

    // Configuração vinda do Backend
    const isAdmin = {{ 'true' if is_admin else 'false' }};
    const pelotaoAtual = "{{ pelotao_selecionado }}";
    const MAX_PERIODO_SEMANA = {{ max_periodo_semana }};

    document.addEventListener('DOMContentLoaded', function() {
        const modalElement = document.getElementById('aulaModal');
        if (modalElement) {
            document.body.appendChild(modalElement);
            modalAula = new bootstrap.Modal(modalElement, {
                backdrop: 'static',
                keyboard: false
            });
        }
        formAula = document.getElementById('formAula');
        btnRemover = document.getElementById('btnRemover');
        modalTitle = document.getElementById('aulaModalLabel');
        instrutorSelect = document.getElementById('instrutor_id');
    });

    function atualizarOpcoesDuracao(periodoInicial) {
        const selectDuracao = document.getElementById('duracao');
        if (!selectDuracao) return; 

        const options = selectDuracao.options;
        const maxDuracaoPossivel = (MAX_PERIODO_SEMANA - periodoInicial) + 1;

        for (let i = 0; i < options.length; i++) {
            const valor = parseInt(options[i].value);
            if (valor > maxDuracaoPossivel) {
                options[i].style.display = 'none'; 
                options[i].disabled = true;        
            } else {
                options[i].style.display = 'block';
                options[i].disabled = false;
            }
        }
        
        if (parseInt(selectDuracao.value) > maxDuracaoPossivel) {
            selectDuracao.value = "1";
        }
    }

    // Expondo funções globalmente
    window.openAgendarModal = function(pelotao, semanaId, dia, periodo) {
        if (!modalAula) { alert('Erro: Modal não carregado.'); return; }
        
        if(formAula) formAula.reset();
        
        const elHorarioId = document.getElementById('horario_id');
        const elPelotao = document.getElementById('pelotao');
        const elSemanaId = document.getElementById('semana_id');
        const elDia = document.getElementById('dia');
        const elPeriodo = document.getElementById('periodo');

        if(elHorarioId) elHorarioId.value = '';
        if(elPelotao) elPelotao.value = pelotao;
        if(elSemanaId) elSemanaId.value = semanaId;
        if(elDia) elDia.value = dia;
        if(elPeriodo) elPeriodo.value = periodo;

        atualizarOpcoesDuracao(periodo);

        if(modalTitle) modalTitle.innerText = 'Novo Agendamento';
        if(btnRemover) btnRemover.style.display = 'none';
        
        modalAula.show();
    }

    window.openEditarModal = function(id, materia, duracao, status) {
        if (!modalAula) return;

        fetch(`/horario/get-aula/${id}`)
            .then(r => r.json())
            .then(data => {
                if(data.success) {
                    const elHorarioId = document.getElementById('horario_id');
                    const elPelotao = document.getElementById('pelotao');
                    const elSemanaId = document.getElementById('semana_id');
                    const elDia = document.getElementById('dia');
                    const elPeriodo = document.getElementById('periodo');
                    const elDisciplina = document.getElementById('disciplina_id');
                    const elDuracao = document.getElementById('duracao');
                    const elObs = document.getElementById('observacao');

                    if(elHorarioId) elHorarioId.value = id;
                    if(elPelotao) elPelotao.value = "{{ pelotao_selecionado }}";
                    if(elSemanaId) elSemanaId.value = "{{ semana_selecionada.id }}";
                    if(elDia) elDia.value = ''; 
                    if(elPeriodo) elPeriodo.value = data.periodo; 

                    atualizarOpcoesDuracao(data.periodo);

                    if(elDisciplina) elDisciplina.value = data.disciplina_id;
                    if(elDuracao) elDuracao.value = data.duracao;
                    if(elObs) elObs.value = data.observacao || '';

                    if(isAdmin && instrutorSelect) {
                        verificarEAdicionarOpcaoInstrutor(data.instrutor_value, data.instrutor_nome);
                        instrutorSelect.value = data.instrutor_value;
                    }
                    
                    if(modalTitle) modalTitle.innerText = 'Editar Agendamento';
                    if(btnRemover) btnRemover.style.display = 'block';
                    modalAula.show();
                } else {
                    alert('Erro ao carregar dados da aula.');
                }
            });
    }

    window.verificarEAdicionarOpcaoInstrutor = function(value, text) {
        if (!instrutorSelect) return;
        let exists = false;
        for (let i = 0; i < instrutorSelect.options.length; i++) {
            if (instrutorSelect.options[i].value == value) {
                exists = true;
                break;
            }
        }
        if (!exists) {
            let opt = document.createElement('option');
            opt.value = value;
            opt.innerHTML = text; 
            instrutorSelect.appendChild(opt);
        }
    }

    window.carregarInstrutoresVinculados = function() {
        if (!isAdmin) return; 
        const elDisciplina = document.getElementById('disciplina_id');
        if (!elDisciplina || !elDisciplina.value) return;

        fetch(`/horario/api/instrutores-vinculados/${pelotaoAtual}/${elDisciplina.value}`)
            .then(r => r.json())
            .then(data => {
                if (data.length > 0 && instrutorSelect) {
                   data.forEach(item => {
                       verificarEAdicionarOpcaoInstrutor(item.id, item.nome);
                   });
                   instrutorSelect.value = data[data.length - 1].id; 
                }
            });
    }

    window.salvarAula = function() {
        if(!formAula) return;
        const formData = new FormData(formAula);
        const data = Object.fromEntries(formData.entries());
        data.semana_id = parseInt(data.semana_id);
        
        fetch('/horario/salvar-aula', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}'},
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                location.reload();
            } else {
                alert('Erro: ' + result.message);
            }
        })
        .catch(err => {
            console.error(err);
            alert('Erro ao comunicar com o servidor.');
        });
    }

    window.removerAula = function() {
        if(!confirm('Tem certeza que deseja remover esta aula?')) return;
        const elHorarioId = document.getElementById('horario_id');
        if(!elHorarioId) return;

        fetch('/horario/remover-aula', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}'},
            body: JSON.stringify({ horario_id: elHorarioId.value })
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) location.reload();
            else alert(result.message);
        });
    }
</script>
{% endblock %}