{% extends "base.html" %}

{% block title %}Editar Quadro Horário - {{ pelotao_selecionado }}{% endblock %}

{% block content %}
<div class="content-header">
    <h1>Editar Quadro Horário</h1>
    <p>Você está editando o horário para: <strong>{{ pelotao_selecionado }}</strong> na semana <strong>{{ semana_selecionada.nome }}</strong></p>
</div>

<div class="table-wrapper">
    <table class="horario-table-new editable fixed-layout" id="weekday-table">
        <thead>
            <tr>
                <th class="header-tempo" style="width: 70px;">Horário</th>
                <th class="header-dia">Segunda-feira <br><small>({{ datas_semana.segunda }})</small></th>
                <th class="header-dia">Terça-feira <br><small>({{ datas_semana.terca }})</small></th>
                <th class="header-dia">Quarta-feira <br><small>({{ datas_semana.quarta }})</small></th>
                <th class="header-dia">Quinta-feira <br><small>({{ datas_semana.quinta }})</small></th>
                <th class="header-dia">Sexta-feira <br><small>({{ datas_semana.sexta }})</small></th>
            </tr>
        </thead>
        <tbody>
            {% set dias = ['segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado', 'domingo'] %}

            {% for row_idx in range(15) %}
                {% set periodo_num = row_idx + 1 %}

                {% if (current_user.role in ['admin', 'programador', 'super_admin']) or
                      (periodo_num <= 12) or
                      (periodo_num == 13 and semana_selecionada.mostrar_periodo_13) or
                      (periodo_num == 14 and semana_selecionada.mostrar_periodo_14) or
                      (periodo_num == 15 and semana_selecionada.mostrar_periodo_15) %}
                
                <tr class="{% if periodo_num in [3, 6, 9] %}break-after{% endif %}" style="height: 1px;">
                    <td class="cell-tempo">
                        <strong>{{ tempos[row_idx][0] }}</strong>
                        <span>{{ tempos[row_idx][1] }}</span>
                    </td>
                    {% for col_idx in range(5) %}
                        {% set aula = horario_matrix[row_idx][col_idx] %}
                        {% set dia = dias[col_idx] %}
                        {% set periodo = row_idx + 1 %}
                        {% include 'partials/_horario_slot_edit.html' %}
                    {% endfor %}
                </tr>

                {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="form-actions">
    <a href="{{ url_for('horario.index', pelotao=pelotao_selecionado, semana_id=semana_selecionada.id, ciclo=semana_selecionada.ciclo_id) }}" class="btn btn-secondary">Voltar para Visualização</a>
</div>

<style>
/* --- CONFIGURAÇÃO DA TABELA FIXA --- */
.horario-table-new.fixed-layout {
    width: 100%;
    table-layout: fixed !important;
    border-collapse: collapse;
}

.horario-table-new td {
    overflow: hidden; 
}

/* --- ESTILOS DOS BOTÕES DE AÇÃO --- */
.slot-actions { display: flex; justify-content: center; gap: 4px; margin: 0 auto; pointer-events: auto; }
.slot-actions.approval { padding: 2px; background-color: rgba(255,255,255,0.95); border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.15); }

.slot-actions .btn-icon { 
    width: 24px; height: 24px; 
    border-radius: 4px; 
    font-size: 0.8rem; 
    font-weight: bold; 
    color: white; 
    display: flex; align-items: center; justify-content: center; 
    border: none; cursor: pointer; 
    transition: filter 0.2s ease;
    padding: 0;
}
.slot-actions .btn-icon:hover { filter: brightness(1.1); }

.slot-actions .btn-icon.approve { background-color: #10b981; }
.slot-actions .btn-icon.deny { background-color: #ef4444; }
.slot-actions .btn-icon.manage { background-color: #f59e0b; }

tr.break-after > td {
    border-bottom: 3px solid #fcd34d;
}

.tooltip-inner {
    max-width: 300px;
    text-align: left;
}
</style>

<div class="modal-overlay" id="horario-modal-overlay">
    <div class="modal-content">
        <h3 id="modal-title">Agendar Aula</h3>
        <form id="modal-form">
            <input type="hidden" id="modal-horario-id" name="horario_id">
            <input type="hidden" id="modal-dia" name="dia">
            <input type="hidden" id="modal-periodo" name="periodo">

            <div class="form-group">
                <label for="modal-disciplina">Disciplina</label>
                <select id="modal-disciplina" name="disciplina_id" class="form-control" required>
                    <option value="">Selecione a disciplina</option>
                </select>
            </div>

            <div class="form-group">
                <label for="modal-instrutor">Instrutor</label>
                <select id="modal-instrutor" name="instrutor_id" class="form-control" required>
                    <option value="">Selecione primeiro a disciplina</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="modal-duracao">Duração (períodos)</label>
                <input type="number" id="modal-duracao" name="duracao" class="form-control" value="1" min="1" max="8">
            </div>

            <div class="form-group">
                <label for="modal-observacao">Observação (Opcional)</label>
                <textarea id="modal-observacao" name="observacao" class="form-control" rows="2" placeholder="Ex: Avaliação, Aula Inaugural..."></textarea>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="modal-cancel">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="modal-confirm">Confirmar</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="approval-modal-overlay">
    <div class="modal-content">
        <h3 id="approval-modal-title">Gerenciar Aula Pendente</h3>
        <p id="approval-modal-info" class="text-muted"></p>
        <form id="approval-modal-form">
            <input type="hidden" id="approval-horario-id" name="horario_id">
            <div id="approval-periodos-container" class="form-group">
            </div>
            <div class="form-actions" style="justify-content: space-between; margin-top: 1.5rem; padding-top: 0;">
                <button type="button" class="btn btn-secondary" id="approval-modal-cancel">Cancelar</button>
                <div class="btn-group">
                    <button type="button" class="btn btn-danger" id="approval-negar">Negar Aula</button>
                    <button type="submit" class="btn btn-primary">Confirmar Aprovação</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    const PELOTAO_SELECIONADO = "{{ pelotao_selecionado }}";
    const SEMANA_ID = "{{ semana_selecionada.id }}";
    const IS_ADMIN = {{ is_admin | tojson }};
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializa Tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    const horarioModalOverlay = document.getElementById('horario-modal-overlay');
    const approvalModalOverlay = document.getElementById('approval-modal-overlay');
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const modalForm = document.getElementById('modal-form');
    const disciplinaSelect = document.getElementById('modal-disciplina');
    const instrutorSelect = document.getElementById('modal-instrutor');
    const disciplinasDisponiveis = {{ disciplinas_disponiveis | tojson }};

    function openModal(modalOverlay) {
        if (modalOverlay) {
            modalOverlay.classList.add('visible');
            document.body.style.overflow = 'hidden';
        }
    }

    function closeModal(modalOverlay) {
        if (modalOverlay) {
            modalOverlay.classList.remove('visible');
            document.body.style.overflow = '';
        }
    }

    async function openHorarioModal(config) {
        modalForm.reset();
        document.getElementById('modal-horario-id').value = config.horario_id || '';
        document.getElementById('modal-dia').value = config.dia;
        document.getElementById('modal-periodo').value = config.periodo;

        disciplinaSelect.innerHTML = '<option value="">Selecione a disciplina</option>';
        disciplinasDisponiveis.forEach(d => {
            const option = new Option(`${d.nome} (${d.restantes}h restantes)`, d.id);
            disciplinaSelect.add(option);
        });
        
        instrutorSelect.innerHTML = '<option value="">Selecione primeiro a disciplina</option>';
        instrutorSelect.disabled = true;

        if (config.horario_id) {
            document.getElementById('modal-title').textContent = 'Editar Aula';
            try {
                const res = await fetch(`/horario/get-aula/${config.horario_id}`);
                const data = await res.json();
                if(data.success) {
                    disciplinaSelect.value = data.disciplina_id;
                    await carregarInstrutores(data.disciplina_id, data.instrutor_value);
                    document.getElementById('modal-duracao').value = data.duracao;
                    document.getElementById('modal-observacao').value = data.observacao || '';
                }
            } catch (e) { console.error("Erro ao buscar detalhes da aula:", e); }
        } else {
            document.getElementById('modal-title').textContent = 'Agendar Aula';
        }
        openModal(horarioModalOverlay);
    }

    async function carregarInstrutores(disciplinaId, instrutorSelecionado = null) {
        if (!disciplinaId) return;
        instrutorSelect.innerHTML = '<option value="">Carregando...</option>';
        try {
            const res = await fetch(`/horario/api/instrutores-vinculados/${PELOTAO_SELECIONADO}/${disciplinaId}`);
            const instrutores = await res.json();
            instrutorSelect.innerHTML = '';
            if (instrutores.length > 0) {
                instrutores.forEach(i => {
                    const option = new Option(i.nome, i.id);
                    instrutorSelect.add(option);
                });
                instrutorSelect.disabled = false;
                if (instrutorSelecionado) instrutorSelect.value = instrutorSelecionado;
            } else {
                 instrutorSelect.innerHTML = '<option value="">Nenhum instrutor vinculado</option>';
                 instrutorSelect.disabled = true;
            }
        } catch(e) {
            console.error("Erro ao buscar instrutores:", e);
            instrutorSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            instrutorSelect.disabled = true;
        }
    }

    disciplinaSelect.addEventListener('change', function() { carregarInstrutores(this.value); });

    function sendFullApprovalAction(horarioId, action) {
        const confirmMessage = action === 'negar' ? 'Tem certeza que deseja NEGAR (remover) esta solicitação de aula?' : null;
        if (confirmMessage && !confirm(confirmMessage)) return;
        
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/horario/aprovar';
        const inputs = { 'csrf_token': csrfToken, 'horario_id': horarioId, 'action': action };
        for (const key in inputs) {
            const input = document.createElement('input');
            input.type = 'hidden'; input.name = key; input.value = inputs[key];
            form.appendChild(input);
        }
        document.body.appendChild(form);
        form.submit();
    }

    async function openApprovalModal(horarioId) {
        const form = document.getElementById('approval-modal-form');
        form.reset();
        document.getElementById('approval-horario-id').value = horarioId;
        const periodosContainer = document.getElementById('approval-periodos-container');
        periodosContainer.innerHTML = 'Carregando...';
        
        try {
            const res = await fetch(`/horario/get-aula/${horarioId}`);
            const data = await res.json();
            if (data.success) {
                document.getElementById('approval-modal-title').textContent = `Gerenciar Aula de ${data.materia}`;
                document.getElementById('approval-modal-info').textContent = `Solicitada por: ${data.instrutor_nome}`;
                periodosContainer.innerHTML = '<label class="form-label">Selecione os períodos para aprovar:</label>';
                for (let i = 0; i < data.duracao; i++) {
                    const periodo = data.periodo + i;
                    periodosContainer.innerHTML += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="periodos" value="${periodo}" id="periodo-${periodo}" checked>
                            <label class="form-check-label" for="periodo-${periodo}">${periodo}º Período</label>
                        </div>`;
                }
                openModal(approvalModalOverlay);
            } else { alert('Erro: ' + data.message); }
        } catch (error) { alert("Não foi possível carregar os detalhes da aula."); }
    }

    function handleTableClick(e) {
        const target = e.target.closest('button');
        if (!target) return;
        const action = target.dataset.action;
        const id = target.dataset.id;
        const slot = target.closest('.schedule-slot');

        if (action === 'add' && slot) openHorarioModal({ dia: slot.dataset.dia, periodo: slot.dataset.periodo });
        else if (action === 'edit' && slot) openHorarioModal({ horario_id: id, dia: slot.dataset.dia, periodo: slot.dataset.periodo });
        else if (action === 'delete') {
            if (confirm('Tem certeza que deseja remover esta aula?')) {
                fetch('/horario/remover-aula', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, body: JSON.stringify({ horario_id: id }) }).then(res => res.json()).then(data => { if (data.success) window.location.reload(); else alert('Erro: ' + data.message); });
            }
        } else if (action === 'approve_all') sendFullApprovalAction(id, 'aprovar');
        else if (action === 'manage_approval') openApprovalModal(id);
        else if (action === 'deny_aula') sendFullApprovalAction(id, 'negar');
    }

    document.querySelectorAll('.editable').forEach(table => table.addEventListener('click', handleTableClick));
    
    modalForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = {
            horario_id: document.getElementById('modal-horario-id').value,
            pelotao: PELOTAO_SELECIONADO,
            semana_id: SEMANA_ID,
            dia: document.getElementById('modal-dia').value,
            periodo: document.getElementById('modal-periodo').value,
            disciplina_id: disciplinaSelect.value,
            instrutor_id: instrutorSelect.value,
            duracao: document.getElementById('modal-duracao').value,
            observacao: document.getElementById('modal-observacao').value
        };
        fetch('/horario/salvar-aula', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, body: JSON.stringify(formData) }).then(res => res.json()).then(data => { if (data.success) window.location.reload(); else alert('Erro: ' + data.message); });
    });

    function sendPartialApproval(horarioId, periodos) {
        fetch('/horario/aprovar-parcial', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, body: JSON.stringify({ horario_id: horarioId, periodos: periodos }) }).then(res => res.json()).then(data => { if (data.success) window.location.reload(); else alert('Erro: ' + data.message); });
    }

    document.getElementById('approval-negar').addEventListener('click', function() {
        if (confirm('Tem certeza?')) sendPartialApproval(document.getElementById('approval-horario-id').value, []);
    });

    document.getElementById('approval-modal-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const selectedPeriodos = Array.from(document.querySelectorAll('#approval-periodos-container input:checked')).map(cb => parseInt(cb.value));
        sendPartialApproval(document.getElementById('approval-horario-id').value, selectedPeriodos);
    });
    
    document.getElementById('modal-cancel').addEventListener('click', () => closeModal(horarioModalOverlay));
    document.getElementById('approval-modal-cancel').addEventListener('click', () => closeModal(approvalModalOverlay));
    if (horarioModalOverlay) { horarioModalOverlay.addEventListener('click', (e) => { if (e.target === horarioModalOverlay) closeModal(horarioModalOverlay); }); }
    if (approvalModalOverlay) { approvalModalOverlay.addEventListener('click', (e) => { if (e.target === approvalModalOverlay) closeModal(approvalModalOverlay); }); }
});
</script>
{% endblock %}