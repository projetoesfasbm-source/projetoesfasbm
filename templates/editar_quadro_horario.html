{% extends "base.html" %}

{% block title %}Editar Quadro Hor√°rio - {{ pelotao_selecionado }}{% endblock %}

{% block content %}
<div class="content-header">
    <h1>Editar Quadro Hor√°rio</h1>
    <p>Voc√™ est√° editando o hor√°rio para: <strong>{{ pelotao_selecionado }}</strong> na semana <strong>{{ semana_selecionada.nome }}</strong></p>
    {% if not is_admin %}
    <p style="color: #10b981; font-weight: 600;">üìå Como instrutor, voc√™ pode agendar apenas suas pr√≥prias aulas.</p>
    {% endif %}
</div>

<div class="table-wrapper">
    <table class="horario-table-new editable" id="weekday-table">
        <thead>
            <tr>
                <th class="header-tempo">Hor√°rio</th>
                <th class="header-dia">Segunda-feira <br><small>({{ datas_semana.segunda }})</small></th>
                <th class="header-dia">Ter√ßa-feira <br><small>({{ datas_semana.terca }})</small></th>
                <th class="header-dia">Quarta-feira <br><small>({{ datas_semana.quarta }})</small></th>
                <th class="header-dia">Quinta-feira <br><small>({{ datas_semana.quinta }})</small></th>
                <th class="header-dia">Sexta-feira <br><small>({{ datas_semana.sexta }})</small></th>
            </tr>
        </thead>
        <tbody>
            {% set dias = ['segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado', 'domingo'] %}

            {% for row_idx in range(15) %}
                {% set periodo_num = row_idx + 1 %}

                {% if (current_user.role in ['admin', 'programador']) or
                      (periodo_num <= 12) or
                      (periodo_num == 13 and semana_selecionada.mostrar_periodo_13) or
                      (periodo_num == 14 and semana_selecionada.mostrar_periodo_14) or
                      (periodo_num == 15 and semana_selecionada.mostrar_periodo_15) %}
                <tr>
                    <td class="cell-tempo"><strong>{{ tempos[row_idx][0] }}</strong><span>{{ tempos[row_idx][1] }}</span></td>
                    {% for col_idx in range(5) %}
                        {% set aula = horario_matrix[row_idx][col_idx] %}
                        {% set dia = dias[col_idx] %}
                        {% set periodo = row_idx + 1 %}
                        {% include 'partials/_horario_slot_edit.html' %}
                    {% endfor %}
                </tr>

                {% if periodo_num == 3 %}
                <tr class="intervalo-row">
                    <td class="cell-tempo"><strong>INTERVALO</strong><span>{{ intervalos.intervalo_1 }}</span></td>
                    <td colspan="5">INTERVALO</td>
                </tr>
                {% endif %}

                {% if periodo_num == 6 %}
                <tr class="intervalo-row">
                    <td class="cell-tempo"><strong>ALMO√áO</strong><span>{{ intervalos.almoco }}</span></td>
                    <td colspan="5">INTERVALO DE ALMO√áO</td>
                </tr>
                {% endif %}

                {% if periodo_num == 9 %}
                <tr class="intervalo-row">
                    <td class="cell-tempo"><strong>INTERVALO</strong><span>{{ intervalos.intervalo_2 }}</span></td>
                    <td colspan="5">INTERVALO</td>
                </tr>
                {% endif %}

                {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="form-actions">
    <a href="{{ url_for('horario.index', pelotao=pelotao_selecionado, semana_id=semana_selecionada.id, ciclo=semana_selecionada.ciclo_id) }}" class="btn btn-secondary">Voltar para Visualiza√ß√£o</a>
</div>

<style>
/* --- ESTILOS DOS BOT√ïES DE A√á√ÉO --- */
.slot-content {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 100%;
    text-align: center;
    padding: 0.5rem;
}
.slot-info {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.slot-actions {
    flex-shrink: 0;
    margin: 4px auto 0 auto;
}
.slot-actions.approval {
    display: flex;
    gap: 0.75rem;
    padding: 4px;
    border-radius: 20px;
}
.slot-actions .btn-icon {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    font-size: 1.3rem;
    font-weight: bold;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    border: none;
    cursor: pointer;
    transition: transform 0.2s ease, background-color 0.2s ease;
}
.slot-actions .btn-icon:hover {
    transform: scale(1.1);
}
.slot-actions .btn-icon.approve { background-color: var(--color-success); }
.slot-actions .btn-icon.approve:hover { background-color: #0f9b6b; }
.slot-actions .btn-icon.deny { background-color: var(--color-danger); }
.slot-actions .btn-icon.deny:hover { background-color: #d93b3b; }
.slot-actions .btn-icon.manage { background-color: var(--color-warning); }
.slot-actions .btn-icon.manage:hover { background-color: #d97706; }

/* --- IN√çCIO DA CORRE√á√ÉO DE ALINHAMENTO --- */
#approval-modal-form .form-actions {
    justify-content: space-between;
    border-top: 1px solid var(--color-border);
    padding-top: 1.5rem;
    margin-top: 1.5rem;
}
#approval-periodos-container {
    max-height: 200px;
    overflow-y: auto;
    padding: 0.5rem;
}
#approval-periodos-container .form-check {
    padding: 0.75rem 1.25rem;
    background-color: #f8fafc;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    margin-bottom: 0.5rem;
    cursor: pointer;
    /* Novas propriedades para alinhamento */
    display: flex;
    align-items: center;
    gap: 0.75rem;
}
#approval-periodos-container .form-check:hover { background-color: #eef5ff; }
#approval-periodos-container .form-check label {
    margin-bottom: 0; /* Remove margem padr√£o */
    cursor: pointer;
}
/* --- FIM DA CORRE√á√ÉO DE ALINHAMENTO --- */

/* --- ESTILOS EXISTENTES --- */
.no-permission { color: #94a3b8; font-size: 1rem; cursor: not-allowed; }
.weekend-slot.disabled { background-color: #f1f5f9; cursor: not-allowed; }
.intervalo-row td {
    background-color: #fffbeb;
    color: #b45309;
    font-weight: bold;
    text-align: center;
    border-left: none;
    border-right: none;
}
</style>

<div class="modal-overlay" id="horario-modal-overlay">
    </div>

<div class="modal-overlay" id="approval-modal-overlay">
    <div class="modal-content">
        <h3 id="approval-modal-title">Gerenciar Aula Pendente</h3>
        <p id="approval-modal-info" class="text-muted"></p>
        <form id="approval-modal-form">
            <input type="hidden" id="approval-horario-id" name="horario_id">
            <div id="approval-periodos-container" class="form-group">
                </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="approval-modal-cancel">Cancelar</button>
                <div class="btn-group">
                    <button type="button" class="btn btn-danger" id="approval-negar">Negar Aula</button>
                    <button type="submit" class="btn btn-primary">Confirmar Aprova√ß√£o</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% if semana_selecionada.mostrar_sabado or semana_selecionada.mostrar_domingo %}
{% endif %}

<script>
    const PELOTAO_SELECIONADO = "{{ pelotao_selecionado }}";
    const SEMANA_ID = "{{ semana_selecionada.id }}";
    const IS_ADMIN = {{ is_admin | tojson }};
    const INSTRUTOR_LOGADO_ID = {{ instrutor_logado_id | tojson }};
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const horarioModalOverlay = document.getElementById('horario-modal-overlay');
    const approvalModalOverlay = document.getElementById('approval-modal-overlay');
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // Fun√ß√µes para controlar a visibilidade dos modais e o scroll da p√°gina
    function openModal(modalOverlay) {
        if (modalOverlay) {
            modalOverlay.classList.add('visible');
            document.body.style.overflow = 'hidden'; // Impede o scroll da p√°gina
        }
    }

    function closeModal(modalOverlay) {
        if (modalOverlay) {
            modalOverlay.classList.remove('visible');
            document.body.style.overflow = ''; // Libera o scroll
        }
    }

    // L√≥gica do Modal de Agendamento (sem altera√ß√µes funcionais)
    async function openHorarioModal(config) {
        // ... (c√≥digo que abre o modal de agendamento)
        openModal(horarioModalOverlay);
    }

    // L√≥gica do Modal de Aprova√ß√£o (aprimorada)
    async function openApprovalModal(horarioId) {
        const form = document.getElementById('approval-modal-form');
        form.reset();
        document.getElementById('approval-horario-id').value = horarioId;
        const modalTitle = document.getElementById('approval-modal-title');
        const infoP = document.getElementById('approval-modal-info');
        const periodosContainer = document.getElementById('approval-periodos-container');
        periodosContainer.innerHTML = 'Carregando...';
        
        try {
            const res = await fetch(`/horario/get-aula/${horarioId}`);
            const data = await res.json();
            
            if (data.success) {
                modalTitle.textContent = `Gerenciar Aula de ${data.materia}`;
                infoP.textContent = `Solicitada por: ${data.instrutor_nome}`;
                periodosContainer.innerHTML = '<label class="form-label">Selecione os per√≠odos para aprovar:</label>';
                for (let i = 0; i < data.duracao; i++) {
                    const periodo = data.periodo + i;
                    periodosContainer.innerHTML += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="periodos" value="${periodo}" id="periodo-${periodo}" checked>
                            <label class="form-check-label" for="periodo-${periodo}">${periodo}¬∫ Per√≠odo</label>
                        </div>`;
                }
                openModal(approvalModalOverlay);
            } else {
                alert('Erro: ' + data.message);
            }
        } catch (error) {
            alert("N√£o foi poss√≠vel carregar os detalhes da aula para aprova√ß√£o.");
        }
    }

    // --- L√ìGICA DO GERENCIADOR DE CLIQUES ATUALIZADA ---
    function handleTableClick(e) {
        const target = e.target.closest('button');
        if (!target) return;

        const action = target.dataset.action;
        const id = target.dataset.id;
        const slot = target.closest('.schedule-slot');

        if (!action || !id || !slot) return;

        // A√ß√µes de edi√ß√£o
        if (action === 'add') openHorarioModal({ dia: slot.dataset.dia, periodo: slot.dataset.periodo });
        if (action === 'edit') openHorarioModal({ horario_id: id, dia: slot.dataset.dia, periodo: slot.dataset.periodo });
        if (action === 'delete') {
            if (confirm('Tem certeza que deseja remover esta aula?')) {
                fetch('/horario/remover-aula', {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ horario_id: id })
                }).then(res => res.json()).then(data => {
                    if (data.success) window.location.reload(); else alert('Erro: ' + data.message);
                });
            }
        }

        // Novas A√ß√µes de Aprova√ß√£o
        if (action === 'approve_all') {
            const startPeriod = parseInt(target.dataset.periodo, 10);
            const duration = parseInt(target.dataset.duracao, 10);
            const allPeriods = Array.from({ length: duration }, (_, i) => startPeriod + i);
            sendApprovalRequest(id, allPeriods);
        }
        if (action === 'manage_approval') {
            openApprovalModal(id);
        }
        if (action === 'deny_aula') {
            if (confirm('Tem certeza que deseja negar (remover) esta solicita√ß√£o de aula?')) {
                sendApprovalRequest(id, []);
            }
        }
    }

    document.querySelectorAll('.editable').forEach(table => table.addEventListener('click', handleTableClick));
    
    // Submiss√£o do formul√°rio de aprova√ß√£o
    function sendApprovalRequest(horarioId, periodos) {
        fetch('/horario/aprovar-parcial', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ horario_id: horarioId, periodos: periodos })
        }).then(res => res.json()).then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert('Erro ao processar aprova√ß√£o: ' + data.message);
            }
        });
    }

    document.getElementById('approval-modal-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const horarioId = document.getElementById('approval-horario-id').value;
        const selectedPeriodos = Array.from(document.querySelectorAll('#approval-periodos-container input:checked')).map(cb => parseInt(cb.value, 10));
        sendApprovalRequest(horarioId, selectedPeriodos);
    });

    document.getElementById('approval-negar').addEventListener('click', function() {
        const horarioId = document.getElementById('approval-horario-id').value;
        sendApprovalRequest(horarioId, []);
    });

    // Fechar modais
    if (document.getElementById('modal-cancel')) {
        document.getElementById('modal-cancel').addEventListener('click', () => closeModal(horarioModalOverlay));
    }
    document.getElementById('approval-modal-cancel').addEventListener('click', () => closeModal(approvalModalOverlay));
    if (horarioModalOverlay) {
        horarioModalOverlay.addEventListener('click', (e) => { if (e.target === horarioModalOverlay) closeModal(horarioModalOverlay); });
    }
    if (approvalModalOverlay) {
        approvalModalOverlay.addEventListener('click', (e) => { if (e.target === approvalModalOverlay) closeModal(approvalModalOverlay); });
    }
});
</script>
{% endblock %}