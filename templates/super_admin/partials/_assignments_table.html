{% if assignments %}
<div class="table-responsive">
    <table class="table table-striped align-middle" id="assignments-table">
        <thead>
            <tr>
                <th scope="col">Posto/Grad.</th>
                <th scope="col">Nome Completo</th>
                <th scope="col">Matrícula</th>
                <th scope="col">Papel</th>
                <th scope="col">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for assignment in assignments %}
            {% set u = assignment.user %}
            {% set is_protected = (u.role in ['super_admin','programador']) or ((u.username or '') in ['super_admin','programador']) %}
            <tr>
                <td>{{ u.posto_graduacao or 'N/D' }}</td>
                <td>{{ u.nome_completo or u.username }}</td>
                <td>{{ u.matricula }}</td>
                <td>
                    <span class="badge bg-{{ 'secondary' if not u.is_active else 'primary' }}">{{ assignment.role }}</span>
                    {% if not u.is_active %}<span class="badge bg-warning text-dark">Pendente</span>{% endif %}
                </td>
                <td>
                    <div style="display: flex; flex-wrap: nowrap; gap: 0.5rem;">
                        <form class="m-0" method="POST"
                              action="{{ url_for('super_admin.reset_user_password', school_id=selected_school_id, filter=selected_filter) }}"
                              onsubmit="return confirm('Resetar a senha para \'{{ u.nome_completo or u.username }}\'?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="user_id" value="{{ u.id }}">
                            <button type="submit" class="btn btn-info btn-sm" {% if is_protected %}disabled{% endif %}>Resetar Senha</button>
                        </form>
                        <form class="m-0" method="POST"
                              action="{{ url_for('super_admin.manage_assignments', school_id=selected_school_id, filter=selected_filter) }}"
                              onsubmit="return confirm('Remover o vínculo de \'{{ u.nome_completo or u.username }}\' com a escola?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="remove">
                            <input type="hidden" name="user_id" value="{{ assignment.user_id }}">
                            <input type="hidden" name="school_id" value="{{ assignment.school_id }}">
                            <button type="submit" class="btn btn-warning btn-sm" {% if is_protected %}disabled{% endif %}>Remover Vínculo</button>
                        </form>
                        <form class="m-0" method="POST"
                              action="{{ url_for('super_admin.delete_user', user_id=u.id, school_id=selected_school_id, filter=selected_filter) }}"
                              onsubmit="return confirm('EXCLUIR PERMANENTEMENTE o usuário \'{{ u.nome_completo or u.username }}\'?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-danger btn-sm" {% if is_protected %}disabled{% endif %}>Excluir</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="text-center p-4">
    <p>Nenhum usuário encontrado com os filtros selecionados.</p>
</div>
{% endif %}