<div class="card process-card mb-3 status-{{ processo.status | lower | replace(' ', '-') | replace('ç', 'c') | replace('ã', 'a') }}">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <span class="status-badge status-{{ processo.status | lower | replace(' ', '-') | replace('ç', 'c') | replace('ã', 'a') }}">
                    {{ processo.status }}
                </span>
                <h5 class="process-title mt-2 mb-1">
                    {{ processo.aluno.user.posto_graduacao }} {{ processo.aluno.user.nome_completo }}
                </h5>
                <span class="process-id">ID Processo: {{ processo.id }} | Matrícula: {{ processo.aluno.user.matricula }}</span>
            </div>
            
            <div class="btn-group">
                {% if processo.status == 'Aguardando Ciência' %}
                <form action="{{ url_for('justica.deletar_processo', processo_id=processo.id) }}" method="POST" onsubmit="return confirm('Tem certeza que deseja excluir este processo? Esta ação não pode ser desfeita.');" class="ms-2">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir Processo">
                        <i class="fas fa-trash me-1"></i> Excluir
                    </button>
                </form>
                {% endif %}

                {% if processo.status in ['Aluno Notificado', 'Defesa Enviada'] %}
                <button class="btn btn-sm btn-success js-toggle-analise-form" 
                        data-target-form="#analise-form-{{ processo.id }}">
                    <i class="fas fa-gavel me-1"></i> 
                    <span class="js-toggle-text">Analisar</span>
                </button>
                {% endif %}
            </div>
        </div>

        <hr>

        <div class="process-detail">
            <span class="detail-label">Fato Constatado:</span>
            <p class="preserve-whitespace">{{ processo.fato_constatado }}</p>
        </div>
        <div class="process-detail">
            <span class="detail-label">Relator (Termo de Justificação):</span>
            <p class="preserve-whitespace">{{ processo.observacao or "N/A" }}</p>
            <small class="text-muted">Registrado por {{ processo.relator.nome_completo }} em {{ processo.data_ocorrencia.strftime('%d/%m/%Y às %H:%M') }}</small>
        </div>

        {% if processo.status in ['Aluno Notificado', 'Defesa Enviada'] %}
            <div class="process-detail bg-light p-3 rounded border mt-3">
                <span class="detail-label">Defesa do Aluno:</span>
                {% if processo.defesa %}
                    <p class="preserve-whitespace">{{ processo.defesa }}</p>
                    <small class="text-muted">Enviada em {{ processo.data_defesa.strftime('%d/%m/%Y às %H:%M') }}</small>
                {% else %}
                    <p class="text-muted fst-italic">Aluno ciente em {{ processo.data_ciente.strftime('%d/%m/%Y às %H:%M') if processo.data_ciente else 'N/A' }}.<br>Nenhuma defesa foi apresentada.</p>
                {% endif %}
            </div>
        {% endif %}

        {% if processo.status == 'Finalizado' %}
            <div class="process-detail bg-light p-3 rounded border border-2 mt-3">
                <span class="detail-label text-success">Decisão Final ({{ processo.decisao_final }}):</span>
                <p class="preserve-whitespace fw-bold">{{ processo.detalhes_sancao or "Sem detalhes adicionais." }}</p>
                <span class="detail-label">Fundamentação:</span>
                <p class="preserve-whitespace">{{ processo.fundamentacao }}</p>
                <small class="text-muted">Decisão em {{ processo.data_decisao.strftime('%d/%m/%Y às %H:%M') }}</small>
            </div>
        {% endif %}

        {% if processo.status in ['Aluno Notificado', 'Defesa Enviada'] %}
        <div class="analise-form-container border p-3 mt-3 rounded bg-light" id="analise-form-{{ processo.id }}" style="display: none;">
            
            <h5 class="mb-3">Finalizar Processo de {{ processo.aluno.user.nome_completo }}</h5>
            
            <form action="{{ url_for('justica.finalizar_processo', processo_id=processo.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <div class="mb-3">
                    <label class="form-label d-block"><strong>Fato:</strong> {{ processo.fato_constatado }}</label>
                    
                    {% if permite_pontuacao and processo.pontos and processo.pontos > 0 %}
                        <label class="form-label d-block text-danger"><strong>Pontuação Original da Infração:</strong> {{ processo.pontos }} pontos</label>
                    {% endif %}
                    </div>

                <div class="mb-3">
                    <label class="form-label d-block"><strong>Defesa:</strong> {{ processo.defesa or "Aluno não apresentou defesa." }}</label>
                </div>
                <hr>
                <div class="mb-3">
                    <label for="decisao_final-{{ processo.id }}" class="form-label">Decisão Final</label>
                    <select name="decisao_final" id="decisao_final-{{ processo.id }}" class="form-select" required>
                        <option value="" disabled selected>Selecione a decisão...</option>
                        
                        <option value="Justificado">Justificado (Sem Sanção)</option>
                        <option value="Advertência">Advertência (Com Sanção)</option>
                        <option value="Repreensão">Repreensão (Com Sanção)</option>
                        </select>
                </div>
                
                <div class="mb-3">
                    <label for="fundamentacao-{{ processo.id }}" class="form-label">Fundamentação da Decisão</label>
                    <textarea name="fundamentacao" id="fundamentacao-{{ processo.id }}" class="form-control" rows="5" placeholder="Descreva por que a defesa foi (ou não) aceita e a base para a decisão." required></textarea>
                </div>

                <div class="d-flex justify-content-end gap-2 mt-3">
                    <button type="button" class="btn btn-secondary js-toggle-analise-form" data-target-form="#analise-form-{{ processo.id }}">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar Decisão</button>
                </div>
            </form>
        </div>
        {% endif %}
        </div>
</div>