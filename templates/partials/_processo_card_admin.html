<div class="card process-card mb-3 status-{{ processo.status | string | lower | replace(' ', '-') | replace('ç', 'c') | replace('ã', 'a') }}">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <span class="status-badge status-{{ processo.status | string | lower | replace(' ', '-') | replace('ç', 'c') | replace('ã', 'a') }}">
                    {{ processo.status | string | replace('_', ' ') }}
                </span>
                <h5 class="process-title mt-2 mb-1">
                    {{ processo.aluno.user.posto_graduacao }} {{ processo.aluno.user.nome_completo }}
                </h5>
                <span class="process-id">ID Processo: {{ processo.id }} | Matrícula: {{ processo.aluno.user.matricula }}</span>
            </div>

            <div class="btn-group">
                {# Verifica status convertendo para string e maiúsculo para evitar erros #}
                {% if (processo.status | string | upper) == 'AGUARDANDO_CIENCIA' %}
                <form action="{{ url_for('justica.deletar_processo', pid=processo.id) }}" method="POST" onsubmit="return confirm('Tem certeza que deseja excluir este processo? Esta ação não pode ser desfeita.');" class="ms-2">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir Processo">
                        <i class="fas fa-trash me-1"></i> Excluir
                    </button>
                </form>
                {% endif %}

                {# CORREÇÃO: Adicionado EM_ANALISE para garantir que processos legados ou em análise apareçam #}
                {% if (processo.status | string | upper) in ['ALUNO_NOTIFICADO', 'DEFESA_ENVIADA', 'EM_ANALISE'] %}
                <button class="btn btn-sm btn-success js-toggle-analise-form"
                        data-target-form="#analise-form-{{ processo.id }}">
                    <i class="fas fa-gavel me-1"></i>
                    <span class="js-toggle-text">Analisar</span>
                </button>
                {% endif %}
            </div>
        </div>

        <hr>

        <div class="process-detail">
            <span class="detail-label">Fato Constatado:</span>
            <p class="preserve-whitespace">{{ processo.fato_constatado }}</p>
        </div>
        <div class="process-detail">
            <span class="detail-label">Relator (Termo de Justificação):</span>
            <p class="preserve-whitespace">{{ processo.observacao or "N/A" }}</p>
            <small class="text-muted">Registrado por {{ processo.relator.nome_completo }} em {{ processo.data_ocorrencia.strftime('%d/%m/%Y às %H:%M') }}</small>
        </div>

        {# Exibe a defesa se o aluno já foi notificado ou enviou #}
        {% if (processo.status | string | upper) in ['ALUNO_NOTIFICADO', 'DEFESA_ENVIADA', 'EM_ANALISE'] %}
            <div class="process-detail bg-light p-3 rounded border mt-3">
                <span class="detail-label">Defesa do Aluno:</span>
                {% if processo.defesa %}
                    <p class="preserve-whitespace">{{ processo.defesa }}</p>
                    <small class="text-muted">Enviada em {{ processo.data_defesa.strftime('%d/%m/%Y às %H:%M') }}</small>
                {% else %}
                    <p class="text-muted fst-italic">Aluno ciente em {{ processo.data_ciente.strftime('%d/%m/%Y às %H:%M') if processo.data_ciente else 'N/A' }}.<br>Nenhuma defesa foi apresentada.</p>
                {% endif %}
            </div>
        {% endif %}

        {# Exibe detalhes finais se já foi julgado #}
        {% if (processo.status | string | upper) == 'FINALIZADO' %}
            <div class="process-detail bg-light p-3 rounded border border-2 mt-3">
                <span class="detail-label text-success">Decisão Final ({{ processo.decisao_final }}):</span>

                {% if processo.tipo_sancao %}
                    <p class="fw-bold text-dark">
                        Sanção: {{ processo.tipo_sancao }}
                        {% if processo.dias_sancao %}
                             - {{ processo.dias_sancao }} dias
                        {% endif %}
                    </p>
                {% endif %}

                {% if processo.detalhes_sancao %}
                    <p class="preserve-whitespace fw-bold">{{ processo.detalhes_sancao }}</p>
                {% endif %}

                {% if processo.origem_punicao %}
                    <p class="text-muted mb-1"><small>Enquadramento: {{ processo.origem_punicao }}</small></p>
                {% endif %}

                {% if processo.is_crime %}
                    <div class="alert alert-danger py-1 px-2 d-inline-block mt-1 mb-2">
                        <i class="fas fa-exclamation-circle"></i> CONFIGURA CRIME
                    </div>
                {% endif %}

                <hr class="my-2">
                <span class="detail-label">Fundamentação:</span>
                <p class="preserve-whitespace">{{ processo.fundamentacao }}</p>
                <small class="text-muted">Decisão em {{ processo.data_decisao.strftime('%d/%m/%Y às %H:%M') }}</small>
            </div>
        {% endif %}

        {# Formulário de Análise (Invisível por padrão, ativado pelo botão) #}
        {% if (processo.status | string | upper) in ['ALUNO_NOTIFICADO', 'DEFESA_ENVIADA', 'EM_ANALISE'] %}
        <div class="analise-form-container border p-3 mt-3 rounded bg-light" id="analise-form-{{ processo.id }}" style="display: none;">

            <h5 class="mb-3">Finalizar Processo de {{ processo.aluno.user.nome_completo }}</h5>

            <form action="{{ url_for('justica.finalizar_processo', pid=processo.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="mb-3">
                    <label class="form-label d-block"><strong>Fato:</strong> {{ processo.fato_constatado }}</label>

                    {% if permite_pontuacao and processo.pontos and processo.pontos > 0 %}
                        <label class="form-label d-block text-danger"><strong>Pontuação Original da Infração:</strong> {{ processo.pontos }} pontos</label>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label class="form-label d-block"><strong>Defesa:</strong> {{ processo.defesa or "Aluno não apresentou defesa." }}</label>
                </div>

                <hr>

                {# --- ÁREA INFORMATIVA (Sem Redundância) --- #}
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-muted">Enquadramento Legal (Original)</label>
                        <p class="form-control-plaintext fw-bold">{{ processo.origem_punicao or 'NPCCAL' }}</p>
                        {# Input Hidden para manter o valor original ao salvar #}
                        <input type="hidden" name="origem_punicao" value="{{ processo.origem_punicao or 'NPCCAL' }}">
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-muted">Classificação de Crime</label>
                        {% if processo.is_crime %}
                            <div class="alert alert-danger py-1 px-2 m-0 d-inline-block">
                                <i class="fas fa-exclamation-circle"></i> Configura CRIME
                            </div>
                            <input type="hidden" name="is_crime" value="on">
                        {% else %}
                            <p class="form-control-plaintext text-success">
                                <i class="fas fa-check-circle"></i> Transgressão Disciplinar (Não é crime)
                            </p>
                        {% endif %}
                    </div>
                </div>
                {# --- FIM DA ÁREA INFORMATIVA --- #}

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="decisao_final-{{ processo.id }}" class="form-label">Decisão Final</label>
                        <select name="decisao_final" id="decisao_final-{{ processo.id }}" class="form-select" onchange="toggleFormularioSancao('{{ processo.id }}')" required>
                            <option value="" disabled selected>Selecione...</option>
                            <option value="Justificado">Justificado (Sem Punição)</option>
                            <option value="Procedente">Procedente (Com Punição)</option>
                            <option value="Sustação da Dispensa">Sustação da Dispensa (Legado)</option>
                        </select>
                    </div>

                    <div class="col-md-6 mb-3" id="div-sancao-{{ processo.id }}" style="display: none;">
                        <label class="form-label">Tipo de Sanção</label>
                        <select name="tipo_sancao" id="tipo_sancao-{{ processo.id }}" class="form-select" onchange="checkDias('{{ processo.id }}')">
                            <option value="">-- Selecione --</option>
                            <option value="Advertência">Advertência</option>
                            <option value="Repreensão">Repreensão</option>
                            <option value="Detenção">Detenção</option>
                            <option value="Prisão">Prisão</option>
                            <option value="Licenciamento">Licenciamento</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3" id="div-dias-{{ processo.id }}" style="display: none;">
                    <label class="form-label">Quantidade de Dias</label>
                    <input type="number" name="dias_sancao" id="dias_sancao-{{ processo.id }}" class="form-control" placeholder="Ex: 2">
                </div>

                <div class="mb-3" id="div-turnos-{{ processo.id }}" style="display: none;">
                    <label for="turnos_sustacao-{{ processo.id }}" class="form-label">Quantidade de Turnos</label>
                    <select name="turnos_sustacao" id="turnos_sustacao-{{ processo.id }}" class="form-select">
                        <option value="" disabled selected>Selecione a quantidade...</option>
                        <option value="01 turno (6H)">01 turno (6H)</option>
                        <option value="02 turnos (12H)">02 turnos (12H)</option>
                        <option value="03 turnos (18H)">03 turnos (18H)</option>
                        <option value="04 turnos (24H)">04 turnos (24H)</option>
                        <option value="05 turnos (30H)">05 turnos (30H)</option>
                        <option value="06 turnos (36H)">06 turnos (36H)</option>
                        <option value="07 turnos (42H)">07 turnos (42H)</option>
                        <option value="08 turnos (48H)">08 turnos (48H)</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="fundamentacao-{{ processo.id }}" class="form-label">Fundamentação da Decisão</label>
                    <textarea name="fundamentacao" id="fundamentacao-{{ processo.id }}" class="form-control" rows="5" placeholder="Descreva por que a defesa foi (ou não) aceita e a base para a decisão." required></textarea>
                </div>

                <div class="d-flex justify-content-end gap-2 mt-3">
                    <button type="button" class="btn btn-secondary js-toggle-analise-form" data-target-form="#analise-form-{{ processo.id }}">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar Decisão</button>
                </div>
            </form>
        </div>
        {% endif %}
    </div>
</div>

<script>
    // Função unificada para controlar visibilidade dos campos
    function toggleFormularioSancao(pid) {
        var decisao = document.getElementById('decisao_final-' + pid).value;
        var divSancao = document.getElementById('div-sancao-' + pid);
        var divTurnos = document.getElementById('div-turnos-' + pid);

        // Reset inicial
        if (divSancao) divSancao.style.display = 'none';
        if (divTurnos) divTurnos.style.display = 'none';

        if (decisao === 'Procedente') {
            if (divSancao) divSancao.style.display = 'block';
        } else if (decisao === 'Sustação da Dispensa') {
            if (divTurnos) divTurnos.style.display = 'block';
        }

        // Verifica se precisa mostrar campo de dias baseado na sanção selecionada
        checkDias(pid);
    }

    function checkDias(pid) {
        var sancaoSelect = document.getElementById('tipo_sancao-' + pid);
        var divDias = document.getElementById('div-dias-' + pid);
        var divSancao = document.getElementById('div-sancao-' + pid);

        // Só mostra dias se a div de sanção estiver visível E a sanção exigir dias
        if (divSancao && divSancao.style.display !== 'none' && sancaoSelect && ['Detenção', 'Prisão'].includes(sancaoSelect.value)) {
            if (divDias) divDias.style.display = 'block';
        } else {
            if (divDias) divDias.style.display = 'none';
        }
    }
</script>