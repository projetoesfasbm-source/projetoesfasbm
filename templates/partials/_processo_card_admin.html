<div class="card process-card mb-3 status-{{ processo.status | string | lower | replace(' ', '-') | replace('ç', 'c') | replace('ã', 'a') }}">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <span class="status-badge status-{{ processo.status | string | lower | replace(' ', '-') | replace('ç', 'c') | replace('ã', 'a') }}">
                    {{ processo.status | string | replace('_', ' ') }}
                </span>
                <h5 class="process-title mt-2 mb-1">
                    {{ processo.aluno.user.posto_graduacao }} {{ processo.aluno.user.nome_completo }}
                </h5>
                <span class="process-id">ID Processo: {{ processo.id }} | Matrícula: {{ processo.aluno.user.matricula }}</span>
            </div>

            <div class="btn-group">
                {% if (processo.status | string | upper) == 'AGUARDANDO_CIENCIA' %}
                <form action="{{ url_for('justica.deletar_processo', pid=processo.id) }}" method="POST" onsubmit="return confirm('Tem certeza que deseja excluir este processo? Esta ação não pode ser desfeita.');" class="ms-2">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir Processo">
                        <i class="fas fa-trash me-1"></i> Excluir
                    </button>
                </form>
                {% endif %}

                {% if (processo.status | string | upper) in ['ALUNO_NOTIFICADO', 'DEFESA_ENVIADA', 'EM_ANALISE'] %}
                <button class="btn btn-sm btn-success js-toggle-analise-form"
                        data-target-form="#analise-form-{{ processo.id }}">
                    <i class="fas fa-gavel me-1"></i>
                    <span class="js-toggle-text">Analisar</span>
                </button>
                {% endif %}
            </div>
        </div>

        <hr>

        <div class="process-detail">
            <span class="detail-label">Fato Constatado:</span>
            <p class="preserve-whitespace">{{ processo.fato_constatado }}</p>
        </div>
        <div class="process-detail">
            <span class="detail-label">Relator (Termo de Justificação):</span>
            <p class="preserve-whitespace">{{ processo.observacao or "N/A" }}</p>
            <small class="text-muted">Registrado por {{ processo.relator.nome_completo }} em {{ processo.data_ocorrencia.strftime('%d/%m/%Y às %H:%M') }}</small>
        </div>

        {# Exibe a defesa no cartão (Removida do form abaixo para não duplicar) #}
        {% if (processo.status | string | upper) in ['ALUNO_NOTIFICADO', 'DEFESA_ENVIADA', 'EM_ANALISE'] %}
            <div class="process-detail bg-light p-3 rounded border mt-3">
                <span class="detail-label">Defesa do Aluno:</span>
                {% if processo.defesa %}
                    <p class="preserve-whitespace">{{ processo.defesa }}</p>
                    <small class="text-muted">Enviada em {{ processo.data_defesa.strftime('%d/%m/%Y às %H:%M') }}</small>
                {% else %}
                    <p class="text-muted fst-italic">Aluno ciente em {{ processo.data_ciente.strftime('%d/%m/%Y às %H:%M') if processo.data_ciente else 'N/A' }}.<br>Nenhuma defesa foi apresentada.</p>
                {% endif %}
            </div>
        {% endif %}

        {# Visualização após finalizado #}
        {% if (processo.status | string | upper) == 'FINALIZADO' %}
            <div class="process-detail bg-light p-3 rounded border border-2 mt-3">
                <span class="detail-label text-success">Decisão Final ({{ processo.decisao_final }}):</span>

                <p class="mb-1"><strong>Enquadramento:</strong> {{ processo.origem_punicao }} {{ ('- ' + processo.codigo_infracao) if processo.codigo_infracao else '' }}</p>

                {% if processo.tipo_sancao %}
                    <p class="fw-bold text-dark">
                        Sanção: {{ processo.tipo_sancao }}
                    </p>
                {% endif %}
                
                {% if processo.detalhes_sancao %}
                     <p class="fw-bold text-dark text-uppercase small">Detalhes: {{ processo.detalhes_sancao }}</p>
                {% endif %}

                <hr class="my-2">
                <span class="detail-label">Fundamentação:</span>
                <p class="preserve-whitespace">{{ processo.fundamentacao or processo.observacao_decisao or "Sem fundamentação registrada." }}</p>
                <small class="text-muted">Decisão em {{ processo.data_decisao.strftime('%d/%m/%Y às %H:%M') }}</small>
            </div>
        {% endif %}

        {# Formulário de Análise #}
        {% if (processo.status | string | upper) in ['ALUNO_NOTIFICADO', 'DEFESA_ENVIADA', 'EM_ANALISE'] %}
        <div class="analise-form-container border p-3 mt-3 rounded bg-light" id="analise-form-{{ processo.id }}" style="display: none;">

            <h5 class="mb-3">Finalizar Processo de {{ processo.aluno.user.nome_completo }}</h5>

            <form action="{{ url_for('justica.finalizar_processo', pid=processo.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="mb-3">
                    <label class="form-label d-block"><strong>Fato:</strong> {{ processo.fato_constatado }}</label>
                    {% if processo.pontos and processo.pontos > 0 %}
                        <label class="form-label d-block text-danger"><strong>Pontuação Original:</strong> {{ processo.pontos }} pontos</label>
                    {% endif %}
                </div>
                
                <hr>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="decisao-{{ processo.id }}" class="form-label">Decisão Final</label>
                        <select name="decisao" id="decisao-{{ processo.id }}" class="form-select" onchange="toggleFormularioSancao('{{ processo.id }}')" required>
                            <option value="" disabled selected>Selecione a decisão...</option>
                            <option value="Justificado">Justificado (Sem Sanção)</option>
                            <option value="Advertência">Advertência (Com Sanção)</option>
                            <option value="Repreensão">Repreensão (Com Sanção)</option>
                            <option value="Sustação da Dispensa">Sustação da Dispensa (Com Sanção)</option>
                        </select>
                    </div>
                </div>

                {# Campo de Turnos (Aparece APENAS para Sustação da Dispensa) #}
                <div class="mb-3" id="div-turnos-{{ processo.id }}" style="display: none;">
                    <label for="turnos_sustacao-{{ processo.id }}" class="form-label fw-bold text-danger">Quantidade de Turnos de Sustação</label>
                    <select name="turnos_sustacao" id="turnos_sustacao-{{ processo.id }}" class="form-select">
                        <option value="" disabled selected>Selecione a quantidade...</option>
                        <option value="01 turno (6H)">01 turno (6H)</option>
                        <option value="02 turnos (12H)">02 turnos (12H)</option>
                        <option value="03 turnos (18H)">03 turnos (18H)</option>
                        <option value="04 turnos (24H)">04 turnos (24H)</option>
                        <option value="05 turnos (30H)">05 turnos (30H)</option>
                        <option value="06 turnos (36H)">06 turnos (36H)</option>
                        <option value="07 turnos (42H)">07 turnos (42H)</option>
                        <option value="08 turnos (48H)">08 turnos (48H)</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="fundamentacao-{{ processo.id }}" class="form-label">Fundamentação da Decisão</label>
                    <textarea name="fundamentacao" id="fundamentacao-{{ processo.id }}" class="form-control" rows="5" placeholder="Descreva a fundamentação..." required></textarea>
                </div>
                
                <input type="hidden" name="pontos_finais" value="{{ processo.pontos }}">

                <div class="d-flex justify-content-end gap-2 mt-3">
                    <button type="button" class="btn btn-secondary js-toggle-analise-form" data-target-form="#analise-form-{{ processo.id }}">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar Decisão</button>
                </div>
            </form>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function toggleFormularioSancao(pid) {
        var decisaoSelect = document.getElementById('decisao-' + pid);
        if (!decisaoSelect) return;
        
        var decisao = decisaoSelect.value;
        var divTurnos = document.getElementById('div-turnos-' + pid);
        var selectTurnos = document.getElementById('turnos_sustacao-' + pid);

        divTurnos.style.display = 'none';
        if (selectTurnos) selectTurnos.required = false;

        if (decisao === 'Sustação da Dispensa') {
            divTurnos.style.display = 'block';
            if (selectTurnos) selectTurnos.required = true;
        }
    }
</script>