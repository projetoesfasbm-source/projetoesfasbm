{# templates/partials/_processo_card_admin.html #}
<div class="process-card" style="border-left-color: {% if processo.status == 'Pendente' %}#f59e0b{% elif processo.status == 'Aluno Notificado' %}#3b82f6{% elif processo.status == 'Defesa Enviada' %}#10b981{% else %}#64748b{% endif %};">
    <div class="process-header">
        <div>
            <div class="process-title">{{ processo.aluno.user.nome_completo }} ({{ processo.aluno.user.matricula }})</div>
            <small class="text-muted">Relatado por: {{ processo.relator.nome_de_guerra or processo.relator.username }} em {{ processo.data_ocorrencia.strftime('%d/%m/%Y') }}</small>
        </div>
        <div class="process-id">ID: {{ processo.id }}</div>
    </div>
    <div class="process-detail">
        <span class="detail-label">Fato Constatado:</span>
        <div class="preserve-whitespace">{{ processo.fato_constatado }}</div>
    </div>
    {% if processo.observacao %}
    <div class="process-detail">
        <span class="detail-label">Observação:</span>
        <div class="preserve-whitespace">{{ processo.observacao }}</div>
    </div>
    {% endif %}
    <div class="process-detail">
        <span class="detail-label">Status:</span> 
        <span class="status-badge {% if 'Pendente' in processo.status %}pendente{% elif 'Notificado' in processo.status %}notificado{% elif 'Defesa' in processo.status %}defesa-enviada{% else %}finalizado{% endif %}">
            {{ processo.status }}
        </span>
    </div>
    {% if processo.defesa %}
    <div class="process-detail">
        <span class="detail-label">Defesa do Aluno:</span>
        <div class="preserve-whitespace" style="background-color: #f8fafc; padding: 0.5rem; border-radius: 4px; border: 1px solid #e2e8f0;">{{ processo.defesa }}</div>
    </div>
    {% endif %}

    {% if processo.status == 'Defesa Enviada' %}
    <form method="POST" action="{{ url_for('justica.finalizar_processo', processo_id=processo.id) }}" class="mt-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group">
            <label for="decisao_final_{{ processo.id }}"><strong>Decisão/Sanção a Aplicar</strong></label>
            <select name="decisao_final" id="decisao_final_{{ processo.id }}" class="form-control" onchange="toggleSanctionDetails(this)">
                <option value="Justificado">Justificado (Arquivar)</option>
                <option value="Advertência">Advertência</option>
                <option value="Repreensão">Repreensão</option>
                <option value="Sustação da Dispensa">Sustação da Dispensa</option>
            </select>
        </div>
        <div class="form-group" id="detalhes_sancao_container_{{ processo.id }}" style="display: none;">
            <label for="detalhes_sancao_{{ processo.id }}"><strong>Detalhes da Sanção (Texto da Advertência/Repreensão)</strong></label>
            <textarea name="detalhes_sancao" id="detalhes_sancao_{{ processo.id }}" class="form-control" rows="3" placeholder="Descreva aqui o texto que constará na advertência ou repreensão."></textarea>
        </div>
        <div class="form-group">
            <label for="fundamentacao_{{ processo.id }}"><strong>Fundamentação da Decisão</strong></label>
            <textarea name="fundamentacao" id="fundamentacao_{{ processo.id }}" class="form-control" rows="4" placeholder="Descreva os motivos para a sua decisão..." required></textarea>
        </div>
        <div class="form-actions mt-2" style="border-top: none; padding-top: 0; justify-content: flex-start;">
            <button type="submit" class="btn btn-success">Finalizar Processo</button>
        </div>
    </form>
    {% endif %}

    {% if processo.status == 'Finalizado' %}
    <div class="process-detail">
        <span class="detail-label">Decisão Final:</span> {{ processo.decisao_final }}
    </div>
    {% if processo.detalhes_sancao %}
    <div class="process-detail">
        <span class="detail-label">Detalhes da Sanção:</span>
        <div class="preserve-whitespace">{{ processo.detalhes_sancao }}</div>
    </div>
    {% endif %}
    <div class="process-detail">
        <span class="detail-label">Fundamentação:</span>
        <div class="preserve-whitespace">{{ processo.fundamentacao }}</div>
    </div>
    {% endif %}

    <div class="form-actions mt-3" style="justify-content: flex-end; border-top: 1px solid #eee; padding-top: 1rem;">
        <form method="POST" action="{{ url_for('justica.deletar_processo', processo_id=processo.id) }}" onsubmit="return confirm('Tem certeza que deseja excluir esta transgressão permanentemente? Esta ação não pode ser desfeita.');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-danger btn-sm">Excluir Transgressão</button>
        </form>
    </div>
</div>

<script>
    function toggleSanctionDetails(selectElement) {
        const processoId = selectElement.id.split('_').pop();
        const detailsContainer = document.getElementById(`detalhes_sancao_container_${processoId}`);
        const detailsTextarea = document.getElementById(`detalhes_sancao_${processoId}`);
        
        if (selectElement.value === 'Advertência' || selectElement.value === 'Repreensão') {
            detailsContainer.style.display = 'block';
            detailsTextarea.required = true;
        } else {
            detailsContainer.style.display = 'none';
            detailsTextarea.required = false;
        }
    }
</script>