<div class="card process-card mb-3 status-{{ processo.status | string | lower | replace('_', '-') | replace(' ', '-') }}">
    <div class="card-body">
        <div class="process-header d-flex justify-content-between align-items-start">
            <div>
                <span class="status-badge badge 
                    {% if 'AGUARDANDO' in (processo.status|string|upper) %}bg-warning text-dark
                    {% elif 'NOTIFICADO' in (processo.status|string|upper) %}bg-info text-dark
                    {% elif 'DEFESA' in (processo.status|string|upper) %}bg-primary
                    {% elif 'FINALIZADO' in (processo.status|string|upper) %}bg-success
                    {% else %}bg-secondary{% endif %}">
                    {{ processo.status | string | replace('_', ' ') }}
                </span>
                <h5 class="process-title mt-2 mb-1">Processo Disciplinar Nº {{ processo.id }}</h5>
            </div>
            <span class="process-id text-muted small">
                <i class="far fa-calendar-alt"></i> {{ processo.data_ocorrencia.strftime('%d/%m/%Y') }}
            </span>
        </div>

        <hr>

        <div class="process-detail mb-3">
            <span class="detail-label fw-bold text-muted small text-uppercase">Fato Constatado:</span>
            <p class="preserve-whitespace">{{ processo.fato_constatado }}</p>
        </div>
        
        {% if processo.observacao %}
        <div class="process-detail mb-3">
            <span class="detail-label fw-bold text-muted small text-uppercase">Termo de Justificação (Relator):</span>
            <p class="preserve-whitespace text-muted small">{{ processo.observacao }}</p>
            <small class="text-muted">Registrado por {{ processo.relator.nome_completo }}</small>
        </div>
        {% endif %}

        {# --- ÁREA DE AÇÃO DO ALUNO (CORRIGIDA) --- #}
        
        {# CASO 1: AGUARDANDO CIÊNCIA #}
        {% if 'AGUARDANDO' in (processo.status | string | upper) %}
            <div class="alert alert-warning mt-3 border-warning">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                    <div>
                        <strong>Ação Necessária:</strong><br>
                        Você foi citado neste processo. Confirme a ciência para liberar o campo de defesa.
                    </div>
                </div>
                <form action="{{ url_for('justica.dar_ciente', processo_id=processo.id) }}" method="POST" class="mt-3">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-warning w-100 fw-bold">
                        <i class="fas fa-check-double me-2"></i> DECLARAR CIÊNCIA
                    </button>
                </form>
            </div>
        {% endif %}

        {# CASO 2: ALUNO NOTIFICADO (Liberar Defesa) #}
        {% if 'NOTIFICADO' in (processo.status | string | upper) %}
            <div class="alert alert-info mt-3 border-info">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-pen-alt fa-2x me-3"></i>
                    <div>
                        <strong>Escreva sua Defesa:</strong><br>
                        O prazo está correndo. Digite sua justificativa abaixo e clique em enviar.
                    </div>
                </div>
                
                <form action="{{ url_for('justica.enviar_defesa', processo_id=processo.id) }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="form-group mb-3">
                        <textarea name="defesa" class="form-control" rows="6" placeholder="Exmo. Sr. Comandante, venho respeitosamente informar que..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 fw-bold">
                        <i class="fas fa-paper-plane me-2"></i> ENVIAR DEFESA
                    </button>
                </form>
            </div>
        {% endif %}

        {# CASO 3: JÁ RESPONDEU OU FINALIZADO #}
        {% if (processo.status | string | upper) in ['DEFESA_ENVIADA', 'FINALIZADO', 'ARQUIVADO', 'EM_ANALISE'] %}
            <div class="process-detail bg-light p-3 rounded border mt-3">
                <span class="detail-label fw-bold text-success small text-uppercase">
                    <i class="fas fa-check-circle"></i> Sua Defesa:
                </span>
                <p class="preserve-whitespace fst-italic mt-2">{{ processo.defesa }}</p>
                <small class="text-muted d-block mt-2">
                    Enviada em {{ processo.data_defesa.strftime('%d/%m/%Y às %H:%M') if processo.data_defesa else 'Data N/A' }}. 
                    {% if 'FINALIZADO' not in (processo.status | string | upper) %}
                        Aguardando análise.
                    {% endif %}
                </small>
            </div>
        {% endif %}

        {# CASO 4: DECISÃO FINAL #}
        {% if 'FINALIZADO' in (processo.status | string | upper) %}
            <div class="process-detail p-3 rounded border mt-3
                {% if processo.decisao_final == 'Justificado' %}border-success bg-success-light{% else %}border-danger bg-danger-light{% endif %}">

                <span class="detail-label fw-bold {% if processo.decisao_final == 'Justificado' %}text-success{% else %}text-danger{% endif %}">
                    <i class="fas fa-gavel"></i> Decisão Final: {{ processo.decisao_final }}
                </span>

                {% if processo.decisao_final != 'Justificado' %}
                    <p class="preserve-whitespace fw-bold mt-2 text-dark">
                        {{ processo.tipo_sancao }} 
                        {% if processo.dias_sancao %}({{ processo.dias_sancao }} dias){% endif %}
                    </p>
                {% endif %}

                <hr class="my-2">
                <span class="detail-label small text-muted">Fundamentação da Autoridade:</span>
                <p class="preserve-whitespace small mb-0">{{ processo.fundamentacao }}</p>
                <small class="text-muted d-block mt-2">Decisão em {{ processo.data_decisao.strftime('%d/%m/%Y às %H:%M') if processo.data_decisao else 'N/A' }}</small>
            </div>
        {% endif %}
    </div>
</div>