<div class="card process-card mb-3 status-{{ status_str | lower | replace('_', '-') | replace(' ', '-') }}">
    <div class="card-body">
        <div class="process-header d-flex justify-content-between align-items-start">
            <div>
                <span class="status-badge badge
                    {% if 'AGUARDANDO' in status_str %}bg-warning text-dark
                    {% elif 'NOTIFICADO' in status_str %}bg-info text-dark
                    {% elif 'DEFESA' in status_str %}bg-primary
                    {% elif 'DECISAO' in status_str %}bg-secondary
                    {% elif 'RECURSO' in status_str %}bg-warning text-dark
                    {% elif 'FINALIZADO' in status_str %}bg-success
                    {% else %}bg-secondary{% endif %}">
                    {{ status_str | replace('_', ' ') }}
                </span>
                <h5 class="process-title mt-2 mb-1">Processo Disciplinar Nº {{ processo.id }}</h5>
            </div>
            <span class="process-id text-muted small">
                <i class="far fa-calendar-alt"></i> {{ processo.data_ocorrencia.strftime('%d/%m/%Y') }}
            </span>
        </div>

        <hr>

        <div class="process-detail mb-3">
            <span class="detail-label fw-bold text-muted small text-uppercase">Fato Constatado:</span>
            <p class="preserve-whitespace">{{ processo.fato_constatado }}</p>
        </div>

        {% if processo.observacao %}
        <div class="process-detail mb-3">
            <span class="detail-label fw-bold text-muted small text-uppercase">Termo de Justificação (Relator):</span>
            <p class="preserve-whitespace text-muted small">{{ processo.observacao }}</p>
            <small class="text-muted">Registrado por {{ processo.relator.nome_completo if processo.relator else 'Administrador' }}</small>
        </div>
        {% endif %}

        {# CASO 1: AGUARDANDO CIÊNCIA #}
        {% if 'AGUARDANDO' in status_str %}
            <div class="alert alert-warning mt-3 border-warning shadow-sm">
                <i class="fas fa-clock"></i> <strong>Atenção:</strong> Você tem o prazo legal de 24 horas para dar ciência e abrir o prazo para sua defesa.
            </div>
            <form action="{{ url_for('justica.dar_ciente', processo_id=processo.id) }}" method="POST" class="mt-2" onsubmit="this.querySelector('button[type=submit]').disabled = true; this.querySelector('button[type=submit]').innerText = 'Registrando...';">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="pid" value="{{ processo.id }}">
                <button type="submit" class="btn btn-warning w-100 fw-bold rounded shadow-sm">
                    <i class="fas fa-check-double me-2"></i> DECLARAR CIÊNCIA
                </button>
            </form>
        {% endif %}

        {# CASO 2: ALUNO NOTIFICADO - ABRINDO DEFESA #}
        {% if 'NOTIFICADO' in status_str %}
            <div class="alert alert-info mt-3 border-info shadow-sm">
                <i class="fas fa-edit me-1"></i> <strong>Escreva sua Defesa:</strong><br>
                <span class="small">Você tem 24h a partir da ciência para enviar sua justificativa. Seja claro e objetivo.</span>
            </div>
            <form action="{{ url_for('justica.enviar_defesa', processo_id=processo.id) }}" method="POST" onsubmit="this.querySelector('button[type=submit]').disabled = true; this.querySelector('button[type=submit]').innerHTML = '<i class=\'fas fa-spinner fa-spin me-2\'></i> Enviando...';">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="pid" value="{{ processo.id }}">

                <div class="form-group mb-3">
                    <textarea name="defesa" class="form-control" rows="6" placeholder="Exmo. Sr. Comandante, venho respeitosamente informar que..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-100 fw-bold rounded shadow-sm">
                    <i class="fas fa-paper-plane me-2"></i> ENVIAR DEFESA
                </button>
            </form>
        {% endif %}

        {# EXIBE A DEFESA CASO JÁ TENHA SIDO ENVIADA #}
        {% if processo.defesa %}
            <div class="process-detail bg-light p-3 rounded border mt-3">
                <span class="detail-label fw-bold text-success small text-uppercase">
                    <i class="fas fa-check-circle"></i> Sua Defesa:
                </span>
                <p class="preserve-whitespace fst-italic mt-2 mb-0">{{ processo.defesa }}</p>
                <small class="text-muted d-block mt-2">Enviada em {{ processo.data_defesa.strftime('%d/%m/%Y às %H:%M') if processo.data_defesa else 'Data Indisponível' }}</small>
            </div>
        {% endif %}

        {# CASO 3: DECISÃO DO CHEFE EMITIDA E RECURSO #}
        {% if 'DECISAO' in status_str or 'FINALIZADO' in status_str or 'RECURSO' in status_str %}

            {% if processo.decisao_final %}
                <div class="process-detail p-3 rounded border mt-3 border-info bg-light">
                    <span class="detail-label fw-bold text-primary">
                        <i class="fas fa-gavel"></i> Veredito do Chefe CAL: {{ processo.decisao_final }}
                    </span>
                    {% if processo.tipo_sancao %}
                        <p class="fw-bold mt-2 mb-1">{{ processo.tipo_sancao }}
                        {% if processo.dias_sancao %}({{ processo.dias_sancao }} dias){% endif %}
                        {% if processo.detalhes_sancao %}- {{ processo.detalhes_sancao }}{% endif %}
                        </p>
                    {% endif %}
                    <p class="small text-muted mt-2 mb-0">{{ processo.fundamentacao }}</p>
                </div>
            {% endif %}

            {% if 'DECISAO' in status_str %}
                {% if not processo.data_notificacao_decisao %}
                    <form action="{{ url_for('justica.dar_ciente', processo_id=processo.id) }}" method="POST" class="mt-3">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="pid" value="{{ processo.id }}">
                        <button type="submit" class="btn btn-info text-white w-100 fw-bold rounded shadow-sm">
                            <i class="fas fa-eye"></i> Dar Ciência da Decisão
                        </button>
                    </form>
                {% else %}
                    <div class="mt-3">
                        <small class="text-muted d-block mb-2 text-center fw-bold">Você tem até 48h após a ciência para recorrer ao Comandante.</small>
                        <button class="btn btn-warning w-100 fw-bold shadow-sm rounded" type="button" data-bs-toggle="collapse" data-bs-target="#formRecurso{{ processo.id }}">
                            <i class="fas fa-balance-scale"></i> Desejo Interpor Recurso
                        </button>

                        <div class="collapse mt-2" id="formRecurso{{ processo.id }}">
                            <form action="{{ url_for('justica.enviar_recurso', pid=processo.id) }}" method="POST" class="card p-3 shadow-sm border-warning rounded" onsubmit="this.querySelector('button[type=submit]').disabled = true;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="processo_id" value="{{ processo.id }}">

                                <label class="fw-bold mb-2 small text-uppercase">Argumentação do Recurso:</label>
                                <textarea name="texto_recurso" class="form-control mb-3" rows="4" required></textarea>
                                <button type="submit" class="btn btn-warning w-100 fw-bold">ENVIAR RECURSO</button>
                            </form>
                        </div>
                    </div>
                {% endif %}

            {% elif 'RECURSO' in status_str and 'EM' in status_str %}
                 <div class="alert alert-warning mt-3 shadow-sm">
                    <i class="fas fa-spinner fa-spin"></i> Recurso enviado ao Comandante da Escola. Aguardando julgamento.
                 </div>

            {% elif 'FINALIZADO' in status_str and processo.decisao_recurso %}
                 <div class="alert {% if processo.decisao_recurso == 'DEFERIDO' %}alert-success{% else %}alert-danger{% endif %} mt-3 shadow-sm">
                    <h6 class="fw-bold mb-1"><i class="fas fa-university"></i> Decisão (Recurso)</h6>
                    <span class="badge {% if processo.decisao_recurso == 'DEFERIDO' %}bg-success{% else %}bg-danger{% endif %} fs-6 mb-2">{{ processo.decisao_recurso }}</span>
                    <p class="mb-0 small border-top pt-2 mt-1">{{ processo.fundamentacao_recurso }}</p>
                 </div>
            {% endif %}

        {% endif %}
    </div>
</div>