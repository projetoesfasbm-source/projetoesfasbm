{% if aula != 'SKIP' %}
    {# Lógica de Destaque #}
    {% set is_my_class = false %}
    {% if current_user.is_authenticated and current_user.role == 'instrutor' and current_user.instrutor_profile %}
        {# Agora usamos os campos 'raw' que foram adicionados no Service #}
        {% if aula.raw_instrutor_id == current_user.instrutor_profile.id or (aula.raw_instrutor_id_2 and aula.raw_instrutor_id_2 == current_user.instrutor_profile.id) %}
             {% set is_my_class = true %}
        {% endif %}
    {% endif %}

    <td class="schedule-slot" rowspan="{{ aula.duracao if not aula.is_disposicao else 1 }}" style="vertical-align: middle; position: relative;">
        <div class="slot-content 
                    {% if aula.is_disposicao %}disposicao{% endif %} 
                    {% if aula.status == 'pendente' %}pendente{% endif %}
                    {# APLICA DESTAQUE SE: For minha aula E NÃO for pendente (ou seja, Agendada e Autorizada) #}
                    {% if is_my_class and aula.status != 'pendente' %}aula-destaque-usuario{% endif %}" 
             style="height: 100%; min-height: 80px; display: flex; flex-direction: column; justify-content: center; padding: 4px;">
            
            <div class="disciplina-title" style="font-weight: bold; line-height: 1.2; margin-bottom: 2px;">
                {{ aula.materia }}
                {% if is_my_class and aula.status != 'pendente' %}
                    <i class="fas fa-check-circle text-success ms-1" title="Sua aula confirmada"></i>
                {% endif %}
            </div>

            {% if aula.instrutor %}
            <div class="instrutor-name" style="font-size: 0.85em; color: #555;">
                {{ aula.instrutor }}
            </div>
            {% endif %}

            {% if aula.observacao %}
            <div class="slot-observacao" 
                 style="margin-top: 4px; 
                        padding-top: 4px; 
                        border-top: 1px dotted #ccc; 
                        font-size: 0.8em; 
                        color: #dc3545; 
                        white-space: normal !important; 
                        word-wrap: break-word !important; 
                        overflow-wrap: anywhere !important; 
                        word-break: break-word; 
                        line-height: 1.1; 
                        display: block; 
                        max-width: 100%;">
                <i class="fas fa-info-circle"></i> {{ aula.observacao }}
            </div>
            {% endif %}

            {# --- BARRA DE FERRAMENTAS DE ADMINISTRAÇÃO RÁPIDA --- #}
            {% set user_role = current_user.get_role_in_school(active_school_id) if current_user.is_authenticated and active_school_id else '' %}
            {% if current_user.is_programador or user_role in ['admin_escola', 'admin_sens', 'admin_cal'] %}
            <div class="admin-quick-actions" style="margin-top: auto; padding-top: 5px; border-top: 1px dashed #bbb; display: flex; justify-content: space-between; gap: 2px;">
                
                <button type="button" class="btn btn-sm btn-success p-0" 
                        style="width: 24px; height: 24px; line-height: 24px; font-size: 0.7rem;"
                        onclick="aprovarRapido('{{ aula.id }}')" 
                        title="Aprovar Aula (Carga Total)">
                    <i class="fas fa-check"></i>
                </button>

                <button type="button" class="btn btn-sm btn-primary p-0" 
                        style="width: 24px; height: 24px; line-height: 24px; font-size: 0.7rem;"
                        onclick="abrirModalEdicao('{{ aula.id }}')" 
                        title="Editar / Aprovação Parcial">
                    <i class="fas fa-pencil-alt"></i>
                </button>

                <button type="button" class="btn btn-sm btn-danger p-0" 
                        style="width: 24px; height: 24px; line-height: 24px; font-size: 0.7rem;"
                        onclick="removerAgendamento('{{ aula.id }}')" 
                        title="Remover Agendamento">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            {% endif %}
            {# ---------------------------------------------------- #}

        </div>
    </td>
{% endif %}