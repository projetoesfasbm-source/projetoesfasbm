<div class="fada-page shadow">
    
    <div id="area-vinculacao" class="alert alert-warning border-warning shadow-sm mb-3 d-print-none">
        <div class="d-flex align-items-center justify-content-between">
            <h6 class="fw-bold text-dark mb-0"><i class="fas fa-exclamation-triangle"></i> Pendências (SisGEn)</h6>
            <span class="badge bg-dark">Uso Interno</span>
        </div>
        <p class="small text-muted mb-2">Vincule as infrações/elogios abaixo para o cálculo automático.</p>
        <div id="lista-infracoes-pendentes" class="bg-white rounded border p-2 small">
            <div class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>
        </div>
    </div>

    <form id="formFada" method="POST" action="{{ url_for('justica.salvar_fada') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="aluno_id" id="fada_aluno_id" value="">

        <div class="text-center mb-3 font-serif lh-1">
            <img src="{{ url_for('static', filename='img/brasao_rs.png') }}" alt="" style="height: 50px; display: none;" class="d-print-block mx-auto mb-1">
            <h6 class="fw-bold mb-0">ESTADO DO RIO GRANDE DO SUL</h6>
            <h6 class="fw-bold mb-0">SECRETARIA DA SEGURANÇA PÚBLICA</h6>
            <h6 class="fw-bold mb-0">BRIGADA MILITAR</h6>
            <h6 class="fw-bold mb-0 mt-2">DEPARTAMENTO DE ENSINO</h6>
            <h5 class="fw-bold mt-3 text-decoration-underline">FICHA DE AVALIAÇÃO DE DESEMPENHO ATITUDINAL</h5>
        </div>

        <div class="border border-dark p-2 mb-2 font-serif small">
            <div class="row">
                <div class="col-8"><strong>ALUNO:</strong> <span id="fada_nome_aluno_display">...</span></div>
                <div class="col-4"><strong>QUALIFICAÇÃO:</strong> Sd PM</div>
            </div>
            <div class="row mt-1">
                <div class="col-8"><strong>OPM:</strong> <span id="fada_opm_display">EsFES/PoA (SisGEn)</span></div>
                <div class="col-4"><strong>DATA DA AVALIAÇÃO:</strong> <span id="fada_data_display"></span></div>
            </div>
        </div>

        <table class="table table-bordered border-dark align-middle fada-table mb-2">
            <thead class="bg-light text-center">
                <tr>
                    <th style="width: 5%;">ITEM</th>
                    <th style="width: 70%;">ATRIBUTOS AVALIADOS</th>
                    <th style="width: 10%;">GRAU</th>
                    <th style="width: 15%;">CONCEITO</th>
                </tr>
            </thead>
            <tbody>
                {% set atributos = [
                    ('Expressão oral e escrita', 'Verbalizar com clareza, precisão e correção de ideias ou fatos. Expressar o pensamento, coerentemente, através da escrita ou de forma verbal.'),
                    ('Planejamento e método', 'Prever e propor soluções para situações futuras com objetivo. Proceder de forma ordenada, lógica e sistemática, sem desviar da proposta inicial.'),
                    ('Perseverança e Tenacidade', 'Manter a continuidade na execução de uma tarefa, mesmo que implique em esforço físico e mental prolongados.'),
                    ('Apresentação pessoal', 'Manter, em todos os momentos, aparência condizente com os padrões militares.'),
                    ('Lealdade', 'Capacidade revelada pelo indivíduo no tocante à sinceridade e franqueza de atitudes e opiniões.'),
                    ('Tato', 'Agir com prudência e habilidade, com relação a pessoas e/ou assuntos evitando situações embaraçosas.'),
                    ('Equilíbrio emocional', 'Controle da impulsividade e precipitação, enfrentando quaisquer situações com serenidade e firmeza.'),
                    ('Disciplina', 'Submeter-se de forma consciente às leis, normas e regulamentos vigentes na instituição a que pertence.'),
                    ('Responsabilidade', 'Responder pelas próprias ações e atos, bem como de outrem. Assumir compromissos e obrigações funcionais.'),
                    ('Maturidade', 'Adaptabilidade diante de situações, respeitando e acreditando no cumprimento das normas vigentes.'),
                    ('Assiduidade', 'Capacidade de, mediante ação da vontade, estar presente em todos os trabalhos e eventos programados, nas datas e horários previstos.'),
                    ('Pontualidade', 'Capacidade de estar presente aos trabalhos e eventos programados nos horários previstos.'),
                    ('Dicção de voz e comando', 'Capacidade de emprego da voz impondo-se perante um grupo ou uma situação, demonstrando energia e firmeza.'),
                    ('Liderança', 'Capacidade de coordenar, direcionar, orientar as atitudes dos membros de um grupo.'),
                    ('Relacionamento interpessoal', 'Relaciona-se com todos, sem distinção, de forma amistosa no trato, demonstrando estima e respeito com os outros.'),
                    ('Ética', 'Apresenta os valores policiais, nos termos do Estatuto dos Militares Estaduais, destacando o sentimento do dever, da dignidade, o brio e o decoro da classe.'),
                    ('Produtividade', 'Grau de qualidade na apresentação do trabalho do servidor. Capacidade para desempenhar suas funções. Capacidade em assimilar os ensinamentos.'),
                    ('Eficiência', 'Grau de conhecimento que o servidor demonstra no exercício das atribuições de seu cargo. Modo como executa suas atividades.')
                ] %}

                {% for titulo, desc in atributos %}
                <tr>
                    <td class="text-center fw-bold">{{ loop.index }}</td>
                    <td style="font-size: 0.8rem; text-align: justify;">
                        <strong>{{ titulo }}:</strong> {{ desc }}
                        <div id="badge_desc_{{ loop.index0 }}" class="mt-1 d-print-none"></div>
                    </td>
                    <td class="p-1">
                        <input type="number" step="0.01" min="0" max="10" 
                               class="form-control text-center fw-bold fada-input border-0 bg-transparent p-0" 
                               id="attr_{{ loop.index0 }}" name="notas[]" value="8.00" 
                               onchange="atualizarConceito({{ loop.index0 }})">
                    </td>
                    <td class="text-center fw-bold small" id="conc_{{ loop.index0 }}">APROVADO</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="row mx-0 border border-dark p-1 mb-2 align-items-center">
            <div class="col-8 text-end fw-bold">MÉDIA FINAL FADA:</div>
            <div class="col-4 text-center fw-bold fs-5" id="displayMediaFada">8.00</div>
        </div>

        <div class="border border-dark p-2 mb-2 font-serif small">
            <strong>LEGENDA:</strong> 
            <span class="mx-3">APROVADO (Nota 7 a 10)</span>
            <span class="mx-3">REPROVADO (Abaixo de 7)</span>
            <span class="mx-3">NÃO OBSERVADO</span>
        </div>

        <div class="border border-dark p-2 mb-2 font-serif small">
            <div class="fw-bold mb-1">De acordo com o parecer o (a) aluno (a) até o presente momento encontra-se:</div>
            <div class="d-flex justify-content-around">
                <div class="form-check">
                    <input class="form-check-input border-dark" type="radio" name="parecer" id="parecer1" value="adaptado" checked>
                    <label class="form-check-label" for="parecer1">Adaptado à carreira militar</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input border-dark" type="radio" name="parecer" id="parecer2" value="em_adaptacao">
                    <label class="form-check-label" for="parecer2">Em adaptação à carreira militar</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input border-dark" type="radio" name="parecer" id="parecer3" value="nao_adaptado">
                    <label class="form-check-label" for="parecer3">Não adaptado à carreira militar</label>
                </div>
            </div>
        </div>

        <div class="border border-dark p-2 mb-2 font-serif small">
            <div class="fw-bold mb-1">OBSERVAÇÕES / JUSTIFICATIVA PARA GRAUS ABAIXO DE 7 E ACIMA DE 9:</div>
            <textarea class="form-control border-0 p-0 font-serif" name="observacao" rows="4" 
                      style="font-size: 0.9rem; resize: none; background: transparent;"
                      placeholder="(Digite a justificativa aqui...)"></textarea>
        </div>

        <div class="border border-dark p-2 mb-2 font-serif small">
            <div class="fw-bold mb-1">CIENTE DO ALUNO:</div>
            <div class="d-flex mb-2">
                <div class="form-check me-4">
                    <input class="form-check-input border-dark" type="radio" name="recurso" id="rec_nao" value="nao" checked>
                    <label class="form-check-label" for="rec_nao">De acordo com o conceito emitido.</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input border-dark" type="radio" name="recurso" id="rec_sim" value="sim">
                    <label class="form-check-label" for="rec_sim">Desejo interpor recurso (prazo 5 dias úteis).</label>
                </div>
            </div>
            <div class="row align-items-end mt-4">
                <div class="col-6 text-center border-top border-dark pt-1">
                    Assinatura do Avaliado
                </div>
                <div class="col-6 text-center border-top border-dark pt-1">
                    Assinatura do Avaliador (Oficial/Monitor)
                </div>
            </div>
            <div class="text-center mt-3">
                Local e Data: ___________________, ____/____/______
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-4 d-print-none">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-dark" onclick="window.print()">
                <i class="fas fa-print"></i> Imprimir
            </button>
            <button type="submit" class="btn btn-primary fw-bold px-4">
                <i class="fas fa-save"></i> Salvar no Sistema
            </button>
        </div>
    </form>
</div>

<style>
    /* Configuração A4 */
    .fada-page {
        width: 210mm;
        min-height: 297mm;
        background: white;
        padding: 15mm; /* Margens de impressão */
        margin: 0 auto;
        font-family: "Times New Roman", Times, serif;
        color: #000;
    }

    /* Tabela compacta */
    .fada-table th, .fada-table td {
        padding: 2px 5px !important;
        font-size: 0.85rem;
        border-color: #000 !important;
    }

    .font-serif { font-family: "Times New Roman", Times, serif; }

    /* Ajuste de Inputs para parecerem texto na impressão */
    .fada-input {
        box-shadow: none;
        font-size: 1rem;
    }
    
    /* Configurações de Impressão */
    @media print {
        @page { margin: 0; size: A4; }
        body { background: white; -webkit-print-color-adjust: exact; }
        .modal { position: static; overflow: visible; }
        .modal-dialog { max-width: 100%; margin: 0; }
        .modal-content { border: none; shadow: none; }
        .fada-page { margin: 0; box-shadow: none !important; width: 100%; }
        .d-print-none { display: none !important; }
        .btn-close { display: none; }
        
        /* Força fundo branco nos inputs */
        input, textarea { border: none !important; resize: none; }
    }
</style>

<script>
// Função renomeada para ser chamada pelo fada_lista_alunos.html
window.abrirFadaModalInterno = function(alunoId, nomeAluno) {
    document.getElementById('fada_aluno_id').value = alunoId;
    document.getElementById('fada_nome_aluno_display').innerText = nomeAluno;
    
    const hoje = new Date();
    document.getElementById('fada_data_display').innerText = hoje.toLocaleDateString('pt-BR');

    // Reset inputs
    document.querySelectorAll('.fada-input').forEach(inp => {
        inp.value = "8.00";
        inp.classList.remove('text-danger', 'text-success');
        // Gatilho visual
        atualizarConceito(inp.id.split('_')[1]);
    });
    
    // Limpa Badges do sistema
    for(let i=0; i<18; i++) {
        const badge = document.getElementById(`badge_desc_${i}`);
        if(badge) badge.innerHTML = "";
    }

    carregarPendenciasFada(alunoId);
    calcularMediaFada();
};

function carregarPendenciasFada(alunoId) {
    const container = document.getElementById('lista-infracoes-pendentes');
    container.innerHTML = '<div class="text-center small"><i class="fas fa-spinner fa-spin"></i> Verificando pendências...</div>';

    fetch(`/justica-e-disciplina/api/infracoes-pendentes/${alunoId}`)
        .then(r => r.json())
        .then(data => {
            dadosPendentes = data;
            renderizarPendencias();
        })
        .catch(err => {
            container.innerHTML = '<div class="text-danger small">Erro ao carregar dados.</div>';
        });
}

function renderizarPendencias() {
    const container = document.getElementById('lista-infracoes-pendentes');
    if (!dadosPendentes || dadosPendentes.length === 0) {
        container.innerHTML = '<div class="text-center text-success small"><i class="fas fa-check"></i> Nada consta para vincular.</div>';
        return;
    }

    let html = '<table class="table table-sm table-borderless mb-0 small">';
    dadosPendentes.forEach((item, idx) => {
        let cor = item.tipo === 'elogio' ? 'text-success' : 'text-danger';
        let sinal = item.tipo === 'elogio' ? '+' : '-';
        html += `
            <tr id="pend_row_${idx}">
                <td class="fw-bold ${cor}" style="width: 80px;">${item.tipo.toUpperCase()}</td>
                <td>${item.descricao} <span class="text-muted">(${item.data})</span></td>
                <td class="fw-bold ${cor}">${sinal}${item.pontos}</td>
                <td>
                    <select class="form-select form-select-sm py-0" style="height: 24px; font-size: 0.8rem;" 
                            onchange="aplicarVinculo(${idx}, this.value, ${item.pontos}, '${item.tipo}')">
                        <option value="">Vincular...</option>
                        ${gerarOpcoesAtributos()}
                    </select>
                </td>
            </tr>`;
    });
    html += '</table>';
    container.innerHTML = html;
}

function gerarOpcoesAtributos() {
    let opts = "";
    const nomes = [
        "1. Expressão oral e escrita", "2. Planejamento e método", "3. Perseverança e Tenacidade",
        "4. Apresentação pessoal", "5. Lealdade", "6. Tato", "7. Equilíbrio emocional", "8. Disciplina",
        "9. Responsabilidade", "10. Maturidade", "11. Assiduidade", "12. Pontualidade",
        "13. Dicção de voz e comando", "14. Liderança", "15. Relacionamento interpessoal",
        "16. Ética", "17. Produtividade", "18. Eficiência"
    ];
    nomes.forEach((nome, idx) => {
        opts += `<option value="${idx}">${nome}</option>`;
    });
    return opts;
}

function aplicarVinculo(idx, attrIdx, pontos, tipo) {
    if (attrIdx === "") return;

    const input = document.getElementById(`attr_${attrIdx}`);
    let valorAtual = parseFloat(input.value);
    let novoValor = valorAtual;

    let badgeHtml = "";
    if (tipo === 'elogio') {
        novoValor = Math.min(10, valorAtual + parseFloat(pontos));
        badgeHtml = `<span class="badge bg-success text-white ms-1">+${pontos}</span>`;
    } else {
        novoValor = Math.max(0, valorAtual - parseFloat(pontos));
        badgeHtml = `<span class="badge bg-danger text-white ms-1">-${pontos}</span>`;
    }

    input.value = novoValor.toFixed(2);
    
    // Adiciona badge visual
    const badgeContainer = document.getElementById(`badge_desc_${attrIdx}`);
    if(badgeContainer) badgeContainer.innerHTML += badgeHtml;
    
    // Marca linha como usada
    const row = document.getElementById(`pend_row_${idx}`);
    row.style.opacity = '0.5';
    row.querySelector('select').disabled = true;
    
    atualizarConceito(attrIdx);
    calcularMediaFada();
}

function atualizarConceito(idx) {
    const input = document.getElementById(`attr_${idx}`);
    const cellConc = document.getElementById(`conc_${idx}`);
    const val = parseFloat(input.value);

    // Regra: < 7 é Reprovado neste quesito? (Ajustar se a regra for diferente)
    // O PDF mostra "APROVADO" para notas altas.
    if (val >= 7) {
        cellConc.innerText = "APROVADO";
        cellConc.className = "text-center fw-bold small text-success";
    } else {
        cellConc.innerText = "REPROVADO";
        cellConc.className = "text-center fw-bold small text-danger";
    }
    calcularMediaFada();
}

function calcularMediaFada() {
    let soma = 0;
    document.querySelectorAll('.fada-input').forEach(i => soma += parseFloat(i.value || 0));
    const media = soma / 18.0;
    document.getElementById('displayMediaFada').innerText = media.toFixed(2);
}
</script>