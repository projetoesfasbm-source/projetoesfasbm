{% extends "base.html" %}

{% block title %}Exportar Termos - DEC{% endblock %}

{% block content %}
<style>
    /* --- ESTILOS DE TELA (SCREEN) --- */
    .split-container { display: flex; height: calc(100vh - 120px); gap: 20px; overflow: hidden; }
    .left-panel { width: 350px; flex-shrink: 0; background: #fff; border: 1px solid #ddd; border-radius: 5px; display: flex; flex-direction: column; }
    
    .right-panel { 
        flex-grow: 1; 
        background: #525659; /* Fundo cinza escuro estilo Word/PDF Reader */
        border: 1px solid #ddd; 
        border-radius: 5px; 
        overflow-y: auto; 
        padding: 30px; 
        display: block; 
        text-align: center; 
    }
    
    /* Folha A4 na tela */
    .a4-page {
        background: white; 
        width: 21cm; 
        min-height: 29.7cm;
        height: auto; 
        padding: 2cm 2cm; /* Margem padrão ABNT aprox */
        margin: 0 auto 30px auto; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        font-family: 'Times New Roman', Times, serif; 
        color: black; 
        line-height: 1.5; 
        font-size: 12pt;
        text-align: left; 
        overflow: visible;
        position: relative;
    }
    
    .editable:hover { background: #ffffd0; cursor: text; outline: 1px dashed #ccc; }
    
    .doc-header { text-align: center; font-weight: bold; margin-bottom: 1.0cm; text-transform: uppercase; font-size: 11pt; border: 2px solid #000; padding: 10px; }
    .doc-title { text-align: center; font-weight: bold; margin: 0.5cm 0; text-decoration: underline; text-transform: uppercase; }
    
    p { margin-bottom: 6pt; text-align: justify; margin-top: 0; }
    
    .sancao-box { 
        border: 1px solid #000; padding: 10px; margin: 10px 0; background: #fff; 
    }
    
    .process-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
    .process-item.active { background: #e3f2fd; border-left: 4px solid #0d6efd; }

    /* --- ESTILOS DE IMPRESSÃO (CRÍTICO) --- */
    @media print {
        @page {
            size: A4;
            margin: 1.5cm; /* Define margem física da impressora */
        }

        body {
            background-color: white !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Oculta interface do sistema */
        nav, header, footer, .left-panel, .d-flex, .no-print, .btn, form, h5 {
            display: none !important;
        }

        .split-container {
            display: block !important;
            height: auto !important;
            overflow: visible !important;
        }

        .right-panel {
            background: white !important;
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
            width: 100% !important;
            position: static !important;
            overflow: visible !important;
        }

        .a4-page {
            width: 100% !important;
            margin: 0 !important;
            padding: 0 !important; /* Remove padding pois @page já tem margem */
            box-shadow: none !important;
            border: none !important;
            min-height: auto !important;
        }

        /* Força quebra de página correta entre termos */
        .page-break {
            page-break-after: always !important;
            break-after: page !important;
            display: block !important;
            border-bottom: none !important; /* Remove linha de separação na impressão */
            margin-bottom: 0 !important;
            padding-bottom: 0 !important;
        }
        
        /* Evita quebra dentro de um parágrafo ou caixa */
        p, .sancao-box {
            page-break-inside: avoid;
        }
        
        /* Ajuste do cabeçalho na impressão */
        .doc-header {
            margin-top: 0 !important;
        }
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white border-bottom no-print">
    <h5 class="m-0">Gerador de Termos DEC</h5>
    
    <form action="{{ url_for('justica.confirmar_publicacao_boletim') }}" method="POST" class="d-flex align-items-center gap-2" id="formPublicacao">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <input type="text" name="numero_boletim" class="form-control form-control-sm" placeholder="Nº Boletim (Ex: BI 024)" style="width: 150px;" required>
        <button type="button" class="btn btn-sm btn-primary" onclick="submeterPublicacao()">
            <i class="fas fa-save"></i> Registrar Publicação
        </button>
        <div id="hidden-inputs"></div>
    </form>

    <div>
        <button class="btn btn-sm btn-success" onclick="exportWord()"><i class="fas fa-file-word"></i> Baixar Word</button>
        <button class="btn btn-sm btn-dark" onclick="window.print()"><i class="fas fa-print"></i> Imprimir</button>
    </div>
</div>

<div class="split-container">
    <div class="left-panel no-print">
        <div class="p-2 bg-light border-bottom">
            <input type="text" class="form-control form-control-sm mb-2" placeholder="Buscar aluno..." onkeyup="filtrarLista(this.value)">
            <small class="text-muted">Selecione os processos:</small>
        </div>
        <div class="process-list" style="overflow-y: auto;" id="processList">
            {% for p in processos %}
            <div class="process-item" onclick="toggleProcess({{ p.id }}, this)">
                <input type="checkbox" id="chk_{{ p.id }}" class="pe-none">
                <strong>{{ p.aluno.user.posto_graduacao }} {{ p.aluno.user.nome_completo }}</strong><br>
                <small class="text-muted">Fato: {{ p.data_ocorrencia.strftime('%d/%m/%Y') }}</small><br>
                
                <span class="badge bg-secondary" style="font-size: 0.7em;">{{ p.decisao_final }}</span>
                
                {% if p.observacao_decisao and 'Publicado' in p.observacao_decisao %}
                    <span class="badge bg-success" style="font-size: 0.7em;">Publicado</span>
                {% endif %}
            </div>
            
            {# JSON com os dados completos, incluindo a fundamentação correta #}
            <script type="application/json" id="data_{{ p.id }}">
                {
                    "id": {{ p.id }},
                    "ano": "{{ p.data_ocorrencia.year }}",
                    "data_fato": "{{ p.data_ocorrencia.strftime('%d/%m/%Y') }}",
                    "aluno": "{{ p.aluno.user.posto_graduacao }} {{ p.aluno.user.nome_completo }}",
                    "matricula": "{{ p.aluno.user.matricula }}",
                    "fato": "{{ p.fato_constatado | replace('\r', '') | replace('\n', ' ') | replace('"', '\\"') | safe }}",
                    "defesa": "{{ p.defesa | replace('\r', '') | replace('\n', '<br>') | replace('"', '\\"') | safe if p.defesa else '(Espaço reservado para defesa escrita)' }}",
                    "decisao_texto": "{{ p.decisao_final or 'Não julgado' }}",
                    "tipo_sancao": "{{ p.tipo_sancao or '' }}",
                    "detalhes": "{{ p.detalhes_sancao or '' }}",
                    "origem": "{{ p.origem_punicao }} {{ ('- ' + p.codigo_infracao) if p.codigo_infracao else '' }}",
                    "fundamentacao": "{{ (p.fundamentacao or p.observacao_decisao or 'Sem fundamentação registrada.') | replace('\r', '') | replace('\n', '<br>') | replace('"', '\\"') | safe }}"
                }
            </script>
            {% else %}
            <div class="p-3 text-center text-muted">Nenhum processo finalizado.</div>
            {% endfor %}
        </div>
    </div>

    <div class="right-panel" id="docPreview">
        <div class="a4-page" id="docContent">
            
            <div id="placeholder-msg" class="text-center text-muted mt-5 pt-5 no-print">
                <i class="fas fa-arrow-left fa-2x mb-3"></i><br>
                Selecione os processos na lista à esquerda para gerar os termos.
            </div>

            <div id="dynamic-content">
                </div>
            
        </div>
    </div>
</div>

<script>
    let selectedIds = new Set();

    function toggleProcess(id, el) {
        const chk = document.getElementById('chk_' + id);
        
        // Remove aviso inicial ao selecionar primeiro item
        const placeholder = document.getElementById('placeholder-msg');
        if(placeholder) placeholder.style.display = 'none';

        if (selectedIds.has(id)) {
            selectedIds.delete(id);
            chk.checked = false;
            el.classList.remove('active');
            const termEl = document.getElementById('term_' + id);
            if(termEl) termEl.remove();
            
            // Se não sobrar nenhum, mostra o aviso novamente
            if(selectedIds.size === 0 && placeholder) placeholder.style.display = 'block';
            
        } else {
            selectedIds.add(id);
            chk.checked = true;
            el.classList.add('active');
            addTerm(id);
        }
    }

    function addTerm(id) {
        const scriptTag = document.getElementById('data_' + id);
        if (!scriptTag) return;
        const d = JSON.parse(scriptTag.textContent);
        
        // Cabeçalho único para cada termo
        const headerHTML = `
            <div class="doc-header editable" contenteditable="true">
                ESTADO DO RIO GRANDE DO SUL<br>
                SECRETARIA DA SEGURANÇA PÚBLICA<br>
                BRIGADA MILITAR<br>
                {% set nome_escola = g.active_school.nome if g.active_school else 'ESCOLA' %}
                {% if ' - ' in nome_escola %}
                    DEC – {{ nome_escola.split(' - ', 1)[1] }}
                {% else %}
                    DEC – {{ nome_escola }}
                {% endif %}
            </div>
        `;

        // Lógica de exibição da sanção dentro do JS
        let sancaoHTML = '';
        
        if (d.tipo_sancao === 'Sustação da Dispensa') {
            sancaoHTML = `
                <p><strong>TIPO DE SANÇÃO:</strong> Sustação da Dispensa</p>
                <p><strong>QUANTIDADE:</strong> ${d.detalhes}</p>
            `;
        } else if (d.tipo_sancao) {
            // Advertência, Repreensão, etc (sem dias)
            sancaoHTML = `
                <p><strong>TIPO DE SANÇÃO:</strong> ${d.tipo_sancao}</p>
            `;
        }

        const html = `
            <div id="term_${id}" class="page-break mb-5 pb-5 border-bottom border-secondary">
                ${headerHTML}
                
                <div class="doc-title editable" contenteditable="true">TERMO DE JUSTIFICAÇÃO Nº ${String(id).padStart(3, '0')} / ${d.ano}</div>
                
                <p><strong>1. DO FATO:</strong></p>
                <div class="editable" contenteditable="true">
                    <p>No dia ${d.data_fato}, o(a) <strong>${d.aluno}</strong>, Matrícula ${d.matricula}, teve a seguinte conduta observada:</p>
                    <p style="padding-left: 1cm; font-style: italic;">"${d.fato}"</p>
                </div>
                
                <p><strong>2. DA DEFESA:</strong></p>
                <div class="editable" contenteditable="true" style="border:1px solid #ccc; padding:10px; min-height:2cm; margin-bottom: 10px;">${d.defesa}</div>
                
                <p><strong>3. DA SOLUÇÃO:</strong></p>
                <p>Diante do exposto, o Comandante/Chefe RESOLVE:</p>
                <div class="sancao-box editable" contenteditable="true">
                    <p><strong>DECISÃO:</strong> <span style="color: #00008B; font-weight: bold;">${d.decisao_texto}</span></p>
                    <p><strong>ENQUADRAMENTO:</strong> ${d.origem}</p>
                    
                    <p><strong>FUNDAMENTAÇÃO:</strong> ${d.fundamentacao}</p>
                    
                    ${sancaoHTML}
                </div>

                <div class="text-center mt-5 pt-4 editable" contenteditable="true">
                    <p>Quartel em <span style="background: #ffffd0;">[DIGITE A CIDADE]</span>, {{ datetime.now().strftime('%d de %B de %Y') }}.</p>
                    <br><br>
                    <div style="border-top: 1px solid #000; width: 60%; display: inline-block;"></div>
                    <p style="margin-top: 5px;"><strong>[NOME, POSTO/GRADUAÇÃO E FUNÇÃO DO RESPONSÁVEL]</strong></p>
                </div>
            </div>`;
            
        document.getElementById('dynamic-content').insertAdjacentHTML('beforeend', html);
    }

    function filtrarLista(texto) {
        texto = texto.toLowerCase();
        document.querySelectorAll('.process-item').forEach(item => {
            item.style.display = item.innerText.toLowerCase().includes(texto) ? 'flex' : 'none';
        });
    }

    function submeterPublicacao() {
        const container = document.getElementById('hidden-inputs');
        container.innerHTML = ''; 
        
        if (selectedIds.size === 0) {
            alert("Selecione pelo menos um processo.");
            return;
        }
        
        selectedIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'processos_ids';
            input.value = id;
            container.appendChild(input);
        });
        
        document.getElementById('formPublicacao').submit();
    }

    function exportWord() {
        var header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Termos</title><style>body{font-family:'Times New Roman'; font-size:12pt;} @page Section1 {size:595.3pt 841.9pt; margin:70.85pt 56.7pt 70.85pt 56.7pt; mso-header-margin:35.4pt; mso-footer-margin:35.4pt; mso-paper-source:0;} div.Section1 {page:Section1;}</style></head><body><div class='Section1'>";
        var footer = "</div></body></html>";
        var content = document.getElementById("dynamic-content").innerHTML;
        
        // Remove as bordas de visualização antes de exportar
        content = content.replace(/border-bottom border-secondary/g, ''); 
        
        var source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(header + content + footer);
        var link = document.createElement("a");
        link.href = source;
        link.download = 'Termos_DEC.doc';
        link.click();
    }
</script>
{% endblock %}