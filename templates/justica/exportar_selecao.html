{% extends "base.html" %}

{% block title %}Exportar e Editar - Termos de Justificação{% endblock %}

{% block content %}
<style>
    /* Layout Split Screen */
    .split-container { display: flex; height: calc(100vh - 120px); gap: 20px; overflow: hidden; }
    .left-panel { width: 350px; flex-shrink: 0; background: #fff; border: 1px solid #ddd; border-radius: 5px; display: flex; flex-direction: column; }
    .right-panel { flex-grow: 1; background: #e9ebee; border: 1px solid #ddd; border-radius: 5px; overflow-y: auto; padding: 20px; display: flex; justify-content: center; }
    
    /* Documento A4 */
    .a4-page {
        background: white; width: 21cm; min-height: 29.7cm;
        padding: 2.5cm 2cm; margin-bottom: 30px; box-shadow: 0 0 15px rgba(0,0,0,0.1);
        font-family: 'Times New Roman', Times, serif; color: black; line-height: 1.5; font-size: 12pt;
    }
    
    /* Editáveis */
    .editable { border: 1px dashed transparent; }
    .editable:hover { border-color: #999; background: #ffffd0; cursor: text; }
    
    /* Estilos do Texto */
    .doc-header { text-align: center; font-weight: bold; margin-bottom: 1.5cm; text-transform: uppercase; font-size: 11pt; border: 1px solid #000; padding: 10px; }
    .doc-title { text-align: center; font-weight: bold; margin: 0.5cm 0; text-decoration: underline; text-transform: uppercase; }
    p { margin-bottom: 6pt; text-align: justify; margin-top: 0; }
    .sancao-box { border: 1px solid #000; padding: 10px; margin: 10px 0; background: #fff; }
    
    /* Botões */
    .actions-bar { padding: 10px; background: #fff; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .process-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; gap: 10px; }
    .process-item.active { background: #e3f2fd; border-left: 4px solid #0d6efd; }

    @media print {
        body * { visibility: hidden; }
        .right-panel, .right-panel * { visibility: visible; }
        .right-panel { position: absolute; left: 0; top: 0; width: 100%; height: auto; background: white; border: none; overflow: visible; padding: 0; }
        .a4-page { box-shadow: none; margin: 0; width: 100%; page-break-after: always; padding: 2cm 1.5cm; }
        .editable { border: none !important; background: none !important; }
        .no-print { display: none !important; }
    }
</style>

<div class="actions-bar">
    <div class="d-flex align-items-center gap-2">
        <h5 class="mb-0">Gerador de Termos</h5>
        <span class="badge bg-secondary" id="count-badge">0 selecionados</span>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('justica.index') }}" class="btn btn-sm btn-outline-secondary">Voltar</a>
        <button class="btn btn-sm btn-success" onclick="exportWord()"><i class="fas fa-file-word"></i> Baixar Word</button>
        <button class="btn btn-sm btn-dark" onclick="window.print()"><i class="fas fa-print"></i> Imprimir</button>
    </div>
</div>

<div class="split-container">
    <div class="left-panel">
        <div class="p-2 border-bottom bg-light">
            <input type="text" class="form-control form-control-sm" placeholder="Filtrar aluno..." onkeyup="filtrarLista(this.value)">
        </div>
        <div class="process-list" id="processList">
            {% for p in processos %}
            <div class="process-item" onclick="toggleProcess({{ p.id }}, this)">
                <input type="checkbox" id="chk_{{ p.id }}" class="form-check-input mt-1 pe-none">
                <div>
                    <div class="fw-bold text-dark">{{ p.aluno.user.posto_graduacao }} {{ p.aluno.user.nome_completo }}</div>
                    <div class="small text-muted">{{ p.data_ocorrencia.strftime('%d/%m/%Y') }} - {{ p.fato_constatado[:30] }}...</div>
                </div>
            </div>
            
            <script type="application/json" id="data_{{ p.id }}">
                {
                    "id": {{ p.id }},
                    "ano": "{{ p.data_ocorrencia.year }}",
                    "data_fato": "{{ p.data_ocorrencia.strftime('%d/%m/%Y') }}",
                    "aluno": "{{ p.aluno.user.posto_graduacao }} {{ p.aluno.user.nome_completo }}",
                    "matricula": "{{ p.aluno.user.matricula }}",
                    "fato": "{{ p.fato_constatado | replace('\n', ' ') | replace('"', '\\"') }}",
                    "defesa": "{{ p.defesa | replace('\n', '<br>') | replace('"', '\\"') if p.defesa else '(Espaço reservado para defesa escrita)' }}",
                    "decisao_final": "{{ p.decisao_final or 'Em Análise' }}",
                    "tipo_sancao": "{{ p.tipo_sancao or '' }}",
                    "dias": "{{ p.dias_sancao if p.dias_sancao else '' }}",
                    "origem": "{{ p.origem_punicao or 'NPCCAL' }}"
                }
            </script>
            {% endfor %}
        </div>
    </div>

    <div class="right-panel" id="docPreview">
        <div class="a4-page" id="docContent">
            <div class="doc-header editable" contenteditable="true">
                ESTADO DO RIO GRANDE DO SUL<br>
                SECRETARIA DA SEGURANÇA PÚBLICA<br>
                BRIGADA MILITAR<br>
                {% set school_name = g.active_school.nome if g.active_school else 'NOME DA ESCOLA' %}
                {% if ' - ' in school_name %}
                    {% set parts = school_name.split(' - ') %}
                    DEC – {{ parts[1] if parts|length > 1 else school_name }}
                {% else %}
                    DEC – {{ school_name }}
                {% endif %}
            </div>
            
            <div id="dynamic-content">
                <div class="text-center text-muted py-5 my-5">
                    <h3><i class="fas fa-arrow-left"></i> Selecione processos na lista</h3>
                </div>
            </div>
            
            <div class="editable mt-5 pt-5 text-center" contenteditable="true">
                <p>Quartel em [CIDADE], {{ datetime.now().strftime('%d de %B de %Y') }}.</p>
                <br><br><br>
                <div style="border-top: 1px solid #000; width: 60%; display: inline-block; margin-top: 20px;"></div>
                <p style="margin-top: 5px;"><strong>[NOME, POSTO/GRADUAÇÃO E FUNÇÃO DO RESPONSÁVEL]</strong></p>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedIds = new Set();

    function toggleProcess(id, element) {
        const checkbox = document.getElementById('chk_' + id);
        if (selectedIds.has(id)) {
            selectedIds.delete(id);
            checkbox.checked = false;
            element.classList.remove('active');
            document.getElementById('term_' + id).remove();
        } else {
            selectedIds.add(id);
            checkbox.checked = true;
            element.classList.add('active');
            addTermToDoc(id);
        }
        
        const placeholder = document.querySelector('#dynamic-content .text-muted');
        if (placeholder) placeholder.style.display = (selectedIds.size > 0) ? 'none' : 'block';
        document.getElementById('count-badge').innerText = selectedIds.size + ' selecionados';
    }

    function addTermToDoc(id) {
        const data = JSON.parse(document.getElementById('data_' + id).textContent);
        
        // Monta a string de Decisão Concatenada
        // Ex: "Sustação da dispensa de 1 turno (6H)"
        let textoDecisao = data.decisao_final;
        if (data.tipo_sancao) textoDecisao += " " + data.tipo_sancao;
        if (data.dias) textoDecisao += " (" + data.dias + ")";

        const html = `
            <div id="term_${id}" class="mb-5 pb-4 border-bottom page-break">
                <div class="doc-title editable" contenteditable="true">TERMO DE JUSTIFICAÇÃO Nº ${String(id).padStart(3, '0')} / ${data.ano}</div>
                
                <p><strong>1. DO FATO:</strong></p>
                <div class="editable" contenteditable="true">
                    <p>No dia ${data.data_fato}, o(a) <strong>${data.aluno}</strong>, Matrícula ${data.matricula}, teve a seguinte conduta observada:</p>
                    <p style="padding-left: 1cm; font-style: italic;">"${data.fato}"</p>
                </div>

                <p><strong>2. DA DEFESA:</strong></p>
                <div class="editable" contenteditable="true" style="border: 1px solid #ccc; padding: 10px; min-height: 2cm; font-family: 'Courier New', monospace; font-size: 11pt;">
                    ${data.defesa}
                </div>

                <p><strong>3. DA SOLUÇÃO:</strong></p>
                <p>Diante do exposto, o Comandante/Chefe RESOLVE:</p>
                
                <div class="sancao-box editable" contenteditable="true">
                    <p><strong>DECISÃO:</strong> ${textoDecisao}</p>
                    <p><strong>ENQUADRAMENTO:</strong> ${data.origem}</p>
                </div>
            </div>
        `;
        document.getElementById('dynamic-content').insertAdjacentHTML('beforeend', html);
    }

    function filtrarLista(texto) {
        texto = texto.toLowerCase();
        document.querySelectorAll('.process-item').forEach(item => {
            item.style.display = item.innerText.toLowerCase().includes(texto) ? 'flex' : 'none';
        });
    }

    function exportWord() {
        var header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Termos</title><style>body{font-family:'Times New Roman'; font-size:12pt;} .page-break{page-break-after:always;}</style></head><body>";
        var footer = "</body></html>";
        var content = document.getElementById("docContent").innerHTML;
        var source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(header + content + footer);
        var fileDownload = document.createElement("a");
        document.body.appendChild(fileDownload);
        fileDownload.href = source;
        fileDownload.download = 'Termos_Justificacao.doc';
        fileDownload.click();
        document.body.removeChild(fileDownload);
    }
</script>
{% endblock %}