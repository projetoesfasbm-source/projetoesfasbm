{% extends "base.html" %}

{% block title %}Boletim Atitudinal{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Boletim de Avaliação Atitudinal</h2>
        <div>
            <a href="{{ url_for('justica.fada_boletim', print='true') }}" target="_blank" class="btn btn-primary">
                <i class="fas fa-print me-1"></i> Imprimir Boletim Oficial
            </a>
            <a href="{{ url_for('justica.index') }}" class="btn btn-outline-secondary ms-2">Voltar</a>
        </div>
    </div>

    <div class="card mb-4 shadow-sm no-print">
        <div class="card-body py-2">
            <form method="GET" class="row align-items-center">
                <div class="col-auto"><label class="fw-bold">Filtrar Turma:</label></div>
                <div class="col-auto">
                    <select name="turma_id" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="">Todas</option>
                        {% for t in turmas %}
                        <option value="{{ t.id }}" {% if request.args.get('turma_id')|int == t.id %}selected{% endif %}>{{ t.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover table-bordered mb-0 align-middle">
                <thead class="bg-light text-center">
                    <tr>
                        <th rowspan="2" class="align-middle">Nº</th>
                        <th rowspan="2" class="align-middle text-start">Aluno</th>
                        <th colspan="3">Notas (Conforme Regulamento)</th>
                        <th rowspan="2" class="align-middle" style="width: 150px;">Ações</th>
                    </tr>
                    <tr>
                        <th class="text-primary">NDisc (Base 20)</th>
                        <th class="text-success">FADA (Base 8)</th>
                        <th class="table-dark">AAt Final</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in dados %}
                    <tr class="text-center">
                        <td>{{ item.aluno.numero or '-' }}</td>
                        <td class="text-start">
                            <strong>{{ item.aluno.user.posto_graduacao }} {{ item.aluno.user.nome_completo }}</strong><br>
                            <small class="text-muted">{{ item.turma }}</small>
                        </td>
                        <td class="fw-bold text-primary">{{ "{:.2f}".format(item.ndisc) }}</td>
                        <td class="fw-bold text-success">{{ "{:.2f}".format(item.fada) }}</td>
                        <td class="bg-light fw-bold fs-5">{{ "{:.2f}".format(item.aat) }}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    onclick="abrirFadaModal({{ item.id }}, '{{ item.aluno.user.nome_completo }}')">
                                <i class="fas fa-edit"></i> Avaliar
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center py-4">Nenhum aluno encontrado para os critérios selecionados.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="alert alert-light mt-3 border">
        <strong>Legenda:</strong><br>
        <small><strong>NDisc:</strong> Nota Disciplinar (Base 20 - Pontos Perdidos) / 2. (Considera infrações a partir do 2º Ciclo).</small><br>
        <small><strong>FADA:</strong> Ficha de Avaliação (Base 8.0 - Punições + Elogios). (Pode ser editada individualmente ou calculada automaticamente).</small><br>
        <small><strong>AAt:</strong> Avaliação Atitudinal Final = (NDisc + FADA) / 2.</small>
    </div>
</div>
{% endblock %}

{% block modals %}
<div class="modal fade" id="modalFada" tabindex="-1" aria-hidden="true" style="z-index: 10000;">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold" id="modalFadaTitle">FADA - Avaliação Atitudinal</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                {% include 'justica/fada_formulario.html' %}
            </div>
        </div>
    </div>
</div>

<script>
function abrirFadaModal(alunoId, nomeAluno) {
    document.getElementById('modalFadaTitle').innerText = 'FADA - ' + nomeAluno;
    
    if(typeof window.carregarPendenciasFada === 'function') {
        // Seta o ID no input hidden
        const hiddenId = document.getElementById('fada_aluno_id');
        if(hiddenId) hiddenId.value = alunoId;
        
        // Reseta visual
        document.querySelectorAll('.fada-input').forEach(inp => {
            inp.value = "10.00";
            inp.classList.remove('bg-danger-subtle', 'bg-success-subtle');
        });
        
        // Limpa badges
        for(let i=0; i<18; i++) {
            const b = document.getElementById(`badge_desc_${i}`);
            if(b) b.innerHTML = '';
        }
        
        // Carrega dados
        carregarPendenciasFada(alunoId);
        calcularMediaFada();
    }
    
    const modalEl = document.getElementById('modalFada');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
}
</script>
{% endblock %}