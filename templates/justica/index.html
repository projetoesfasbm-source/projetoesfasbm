{% extends "base.html" %}

{% block title %}Justiça e Disciplina{% endblock %}

{% block content %}
<div class="content-header">
    <h1>Justiça e Disciplina</h1>
    <p>Gestão de processos disciplinares e avaliação atitudinal.</p>
</div>

<div class="justice-page-layout">
    <div class="justice-main-content">
        <div class="justice-container">
            
            <div class="justice-options">
                <button class="btn btn-primary justice-option-btn active" data-target="inProgressContent">Em Andamento</button>
                <button class="btn btn-warning justice-option-btn" data-target="finalizadosContent">Finalizados</button>

                {% if current_user.role != 'aluno' %}
                    <button class="btn btn-danger justice-option-btn" data-target="newInfracaoContent">
                        <i class="fas fa-exclamation-triangle me-1"></i>Nova Infração
                    </button>
                    <button class="btn btn-success justice-option-btn" data-target="newElogioContent">
                        <i class="fas fa-star me-1"></i>Novo Elogio
                    </button>
                {% endif %}
            </div>

            <div class="justice-content active" id="inProgressContent">
                <h3 class="justice-content-title">Processos em Andamento</h3>
                {% if em_andamento %}
                    {% for processo in em_andamento %}
                        {% include 'partials/_processo_card_admin.html' if current_user.role != 'aluno' else 'partials/_processo_card_aluno.html' %}
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">Nenhum processo em andamento.</div>
                {% endif %}
            </div>

            <div class="justice-content" id="finalizadosContent">
                <h3 class="justice-content-title">Processos Finalizados</h3>
                {% if finalizados %}
                    {% for processo in finalizados %}
                        {% include 'partials/_processo_card_admin.html' if current_user.role != 'aluno' else 'partials/_processo_card_aluno.html' %}
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">Nenhum processo finalizado.</div>
                {% endif %}
            </div>

            <div class="justice-content" id="newInfracaoContent">
                <div class="card border-danger shadow-sm">
                    <div class="card-header bg-danger text-white"><h4 class="mb-0">Registrar Infração</h4></div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('justica.registrar_em_massa') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="tipo_registro" value="infracao">
                            <div class="row">
                                <div class="col-md-5 mb-3 border-end">
                                    <label class="form-label fw-bold">1. Turma</label>
                                    <select class="form-select mb-2" onchange="carregarAlunos(this.value, 'listaAlunosInfracao')">
                                        <option value="">-- Escolha --</option>
                                        {% for turma in turmas %}
                                        <option value="{{ turma.id }}">{{ turma.nome }}</option>
                                        {% endfor %}
                                    </select>
                                    <a href="#" onclick="toggleTodos('listaAlunosInfracao'); return false;" class="small text-danger">Marcar Todos</a>
                                    <div id="listaAlunosInfracao" class="border rounded bg-light p-2" style="max-height: 350px; overflow-y: auto;">
                                        <div class="text-center text-muted small py-3">Selecione uma turma.</div>
                                    </div>
                                </div>
                                <div class="col-md-7 mb-3">
                                    <label class="form-label fw-bold">2. Detalhes</label>
                                    <div class="mb-2">
                                        <label class="small">Enquadramento</label>
                                        <select id="regraSelect" name="regra_id" class="form-select" required onchange="atualizarTextoInteligente()">
                                            <option value="">-- Selecione --</option>
                                            {% for regra in fatos_predefinidos %}
                                            <option value="{{ regra.id }}" data-desc="no item {{ regra.codigo }} - '{{ regra.descricao }}'">{{ regra.codigo }} - {{ regra.descricao[:60] }}...</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="mb-2">
                                        <label class="small">Data</label>
                                        <input type="date" name="data_fato" class="form-control" value="{{ hoje }}">
                                    </div>
                                    <div class="mb-2">
                                        <label class="small">Fato Constatado (Resumo)</label>
                                        <textarea name="descricao" class="form-control" rows="2" required></textarea>
                                    </div>
                                    <div class="mb-2">
                                        <label class="small">Termo de Justificação</label>
                                        <textarea id="campoObservacao" name="observacao" class="form-control" rows="6"></textarea>
                                    </div>
                                    <div class="text-end"><button type="submit" class="btn btn-danger">Registrar</button></div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="justice-content" id="newElogioContent">
                <div class="card border-success shadow-sm">
                    <div class="card-header bg-success text-white"><h4 class="mb-0">Registrar Elogio</h4></div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('justica.registrar_em_massa') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="tipo_registro" value="elogio">
                            <div class="row">
                                <div class="col-md-5 border-end">
                                    <label class="form-label">Turma</label>
                                    <select class="form-select mb-2" onchange="carregarAlunos(this.value, 'listaAlunosElogio')">
                                        <option value="">-- Escolha --</option>
                                        {% for turma in turmas %}
                                        <option value="{{ turma.id }}">{{ turma.nome }}</option>
                                        {% endfor %}
                                    </select>
                                    <div id="listaAlunosElogio" class="border rounded p-2" style="max-height:300px; overflow-y:auto;"></div>
                                </div>
                                <div class="col-md-7">
                                    <label class="form-label">Motivo</label>
                                    <textarea name="descricao" class="form-control" rows="5" required></textarea>
                                    <div class="text-end mt-3"><button type="submit" class="btn btn-success">Registrar Elogio</button></div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    .justice-page-layout { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    @media (min-width: 992px) { .justice-page-layout { grid-template-columns: 3fr 1fr; } }
    .justice-options { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .justice-content { display: none; }
    .justice-content.active { display: block; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Tabs ---
    document.querySelectorAll('.justice-option-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.justice-option-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.justice-content').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(this.dataset.target).classList.add('active');
        });
    });

    // --- Alunos ---
    window.carregarAlunos = function(turmaId, containerId) {
        const container = document.getElementById(containerId);
        if(!turmaId) return;
        container.innerHTML = 'Carregando...';
        fetch(`/justica-e-disciplina/api/alunos-por-turma/${turmaId}`)
            .then(r => r.json())
            .then(data => {
                container.innerHTML = data.map(a => `
                    <div class="form-check border-bottom py-1">
                        <input class="form-check-input aluno-check-${containerId}" type="checkbox" name="alunos_selecionados" value="${a.id}" id="chk_${containerId}_${a.id}" onchange="if('${containerId}'=='listaAlunosInfracao') atualizarTextoInteligente()">
                        <label class="form-check-label" for="chk_${containerId}_${a.id}">${a.numero} - ${a.nome}</label>
                    </div>
                `).join('');
            });
    };

    window.toggleTodos = function(cId) {
        const checks = document.querySelectorAll(`.aluno-check-${cId}`);
        const status = Array.from(checks).some(c => !c.checked);
        checks.forEach(c => c.checked = status);
        if(cId === 'listaAlunosInfracao') atualizarTextoInteligente();
    };

    // --- Texto Inteligente ---
    window.atualizarTextoInteligente = function() {
        const checks = document.querySelectorAll('.aluno-check-listaAlunosInfracao:checked');
        const regSel = document.getElementById('regraSelect');
        const regraDesc = regSel.options[regSel.selectedIndex].getAttribute('data-desc') || "";
        const box = document.getElementById('campoObservacao');
        
        if(checks.length === 1) {
            box.value = "Carregando dados do aluno...";
            fetch(`/justica-e-disciplina/api/aluno-details/${checks[0].value}`)
                .then(r => r.json())
                .then(d => {
                    box.value = `Termo de Justificação:\n1. Justificante: ${d.posto_graduacao} ${d.nome_completo}, Id ${d.matricula}.\n2. Conduta: O militar acima, na data de hoje, incorreu ${regraDesc}.\n3. Prazo: 24h para defesa.`;
                });
        } else if(checks.length > 1) {
            box.value = `Termo de Justificação Coletivo:\n1. Justificantes: Conforme lista anexa (${checks.length} alunos).\n2. Conduta: Os militares incorreram ${regraDesc}.\n3. Prazo: 24h para defesa.`;
        }
    };
});
</script>
{% endblock %}