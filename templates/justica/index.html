{% extends "base.html" %}

{% block title %}Justiça e Disciplina{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<div class="container-xl">
    <div class="content-header mt-4">
        <h1>Justiça e Disciplina</h1>
        <p>Gestão de processos disciplinares e avaliação atitudinal.</p>
    </div>

    <div class="justice-page-layout">
        <div class="justice-main-content">
            <div class="justice-container">

                <div class="justice-options mb-4">
                    <button class="btn btn-primary justice-option-btn active" data-target="inProgressContent">Em Andamento</button>
                    <button class="btn btn-warning justice-option-btn" data-target="finalizadosContent">Finalizados</button>

                    {% if current_user.role != 'aluno' %}
                        <button class="btn btn-danger justice-option-btn" data-target="newInfracaoContent">
                            <i class="fas fa-exclamation-triangle me-1"></i>Nova Infração
                        </button>
                        <button class="btn btn-success justice-option-btn" data-target="newElogioContent">
                            <i class="fas fa-star me-1"></i>Novo Elogio
                        </button>
                        
                        {% set school_type = 'ctsp' %}
                        {% if g.active_school and g.active_school.npccal_type %}
                            {% set school_type = g.active_school.npccal_type|lower %}
                        {% endif %}
                        {% if school_type in ['cbfpm', 'cspm'] %}
                        <a href="{{ url_for('justica.fada_boletim') }}" class="btn btn-info text-white justice-option-btn">
                            <i class="fas fa-clipboard-list me-1"></i> Boletim / Avaliar (FADA)
                        </a>
                        {% endif %}
                    {% endif %}
                </div>

                <div class="justice-content active" id="inProgressContent">
                    <h3 class="justice-content-title mb-3">Processos em Andamento</h3>
                    {% if em_andamento %}
                        {% for p in em_andamento %}
                            <div class="card mb-3 shadow-sm border-start border-4 border-primary">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-2 col-sm-4">
                                            <small class="text-muted d-block small text-uppercase fw-bold">Data</small>
                                            <strong>{{ p.data_ocorrencia.strftime('%d/%m/%Y') }}</strong>
                                        </div>
                                        <div class="col-md-3 col-sm-8">
                                            <small class="text-muted d-block small text-uppercase fw-bold">Aluno</small>
                                            <span class="fw-bold">{{ p.aluno.user.nome_completo }}</span>
                                        </div>
                                        <div class="col-md-4 col-sm-12 mt-2 mt-md-0">
                                            <small class="text-muted d-block small text-uppercase fw-bold">Fato/Status</small>
                                            <div class="text-truncate text-dark" title="{{ p.fato_constatado }}">{{ p.fato_constatado }}</div>
                                            <span class="badge bg-secondary">{{ p.status }}</span>
                                            {% if p.pontos > 0 %}
                                                <span class="badge bg-danger ms-1">-{{ p.pontos }} pts (Previsto)</span>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="col-md-3 text-md-end text-start mt-3 mt-md-0">
                                            <div class="d-flex justify-content-md-end justify-content-start gap-2 flex-wrap">
                                                
                                                {% if current_user.role != 'aluno' %}
                                                    {% if p.status == 'EM_RECURSO' %}
                                                        <button type="button" class="btn btn-sm btn-primary fw-bold text-white" onclick="toggleJulgarRecurso('{{ p.id }}')">
                                                            <i class="fas fa-balance-scale"></i> Julgar Recurso
                                                        </button>
                                                    {% elif p.status in ['AGUARDANDO_CIENCIA', 'ALUNO_NOTIFICADO'] and not p.is_revelia %}
                                                        <button type="button" class="btn btn-sm btn-secondary text-white" disabled title="Aguardando prazo do aluno">
                                                            <i class="fas fa-lock"></i> Analisar
                                                            {% if p.status == 'AGUARDANDO_CIENCIA' and p.prazo_ciencia %}
                                                                <br><small class="cronometro-prazo badge bg-dark mt-1" data-prazo="{{ p.prazo_ciencia.isoformat() }}"></small>
                                                            {% elif p.status == 'ALUNO_NOTIFICADO' and p.prazo_defesa %}
                                                                <br><small class="cronometro-prazo badge bg-dark mt-1" data-prazo="{{ p.prazo_defesa.isoformat() }}"></small>
                                                            {% endif %}
                                                        </button>
                                                    {% else %}
                                                        <button type="button" class="btn btn-sm btn-info text-white" onclick="toggleAnalise('{{ p.id }}')" title="Analisar/Decidir">
                                                            <i class="fas fa-gavel"></i> Analisar
                                                            {% if p.is_revelia %}<span class="badge bg-danger ms-1">À REVELIA</span>{% endif %}
                                                        </button>
                                                    {% endif %}
                                                    
                                                    <form action="{{ url_for('justica.deletar_processo', pid=p.id) }}" method="POST" onsubmit="return confirm('ATENÇÃO: Deseja EXCLUIR este processo?');" class="d-inline">
                                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                        <button type="submit" class="btn btn-sm btn-danger" title="Excluir"><i class="fas fa-trash"></i></button>
                                                    </form>
                                                {% endif %}

                                                {% if current_user.role == 'aluno' %}
                                                    {% if p.status == 'AGUARDANDO_CIENCIA' %}
                                                        <form action="{{ url_for('justica.dar_ciente', processo_id=p.id) }}" method="POST">
                                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                            <button type="submit" class="btn btn-sm btn-warning fw-bold text-dark">
                                                                DAR CIENTE <span class="cronometro-prazo badge bg-dark ms-1" data-prazo="{{ p.prazo_ciencia.isoformat() if p.prazo_ciencia else '' }}"></span>
                                                            </button>
                                                        </form>
                                                    {% elif p.status == 'ALUNO_NOTIFICADO' and not p.defesa %}
                                                        <button type="button" class="btn btn-sm btn-warning fw-bold text-dark" onclick="toggleDefesa('{{ p.id }}')">
                                                            ENVIAR DEFESA <span class="cronometro-prazo badge bg-dark ms-1" data-prazo="{{ p.prazo_defesa.isoformat() if p.prazo_defesa else '' }}"></span>
                                                        </button>
                                                    {% elif p.status == 'DECISAO_EMITIDA' %}
                                                        {% if not p.data_notificacao_decisao %}
                                                            <form action="{{ url_for('justica.dar_ciente', processo_id=p.id) }}" method="POST">
                                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                                <button type="submit" class="btn btn-sm btn-info fw-bold text-white">CIÊNCIA DA DECISÃO</button>
                                                            </form>
                                                        {% else %}
                                                            <button type="button" class="btn btn-sm btn-primary fw-bold text-white" onclick="toggleRecurso('{{ p.id }}')">
                                                                INTERPOR RECURSO <span class="cronometro-prazo badge bg-dark ms-1" data-prazo="{{ p.prazo_recurso.isoformat() if p.prazo_recurso else '' }}"></span>
                                                            </button>
                                                        {% endif %}
                                                    {% elif p.status == 'EM_RECURSO' %}
                                                        <span class="badge bg-primary py-2"><i class="fas fa-clock"></i> Recurso em Análise</span>
                                                    {% elif p.defesa %}
                                                        <span class="badge bg-success py-2"><i class="fas fa-check"></i> Defesa Enviada</span>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <div id="collapseDefesa{{ p.id }}" class="mt-3 pt-3 border-top bg-light p-3 rounded" style="display: none;">
                                        <h5 class="text-warning fw-bold"><i class="fas fa-shield-alt me-2"></i>Registrar Defesa</h5>
                                        <form action="{{ url_for('justica.enviar_defesa', processo_id=p.id) }}" method="POST">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Sua Justificativa / Defesa:</label>
                                                <textarea name="defesa" class="form-control" rows="6" placeholder="Escreva aqui sua defesa detalhadamente..." required></textarea>
                                            </div>
                                            <div class="text-end">
                                                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleDefesa('{{ p.id }}')">Cancelar</button>
                                                <button type="submit" class="btn btn-warning fw-bold text-dark">Enviar Defesa Agora</button>
                                            </div>
                                        </form>
                                    </div>

                                    <div id="collapseRecurso{{ p.id }}" class="mt-3 pt-3 border-top bg-white p-3 rounded border border-warning shadow-sm" style="display: none;">
                                        <h5 class="text-primary fw-bold"><i class="fas fa-gavel me-2"></i>Interpor Recurso ao Comandante</h5>
                                        <form action="{{ url_for('justica.enviar_recurso', pid=p.id) }}" method="POST">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Argumentação do Recurso:</label>
                                                <textarea name="texto_recurso" class="form-control" rows="6" placeholder="Justifique os motivos para anulação ou revisão da decisão..." required></textarea>
                                            </div>
                                            <div class="text-end">
                                                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleRecurso('{{ p.id }}')">Cancelar</button>
                                                <button type="submit" class="btn btn-primary fw-bold">Enviar Recurso ao Comandante</button>
                                            </div>
                                        </form>
                                    </div>

                                    {% if current_user.role != 'aluno' and p.status == 'EM_RECURSO' %}
                                    <div id="collapseJulgarRecurso{{ p.id }}" class="mt-3 pt-3 border-top bg-light p-3 rounded border border-primary shadow-sm" style="display: none;">
                                        <h5 class="text-primary fw-bold"><i class="fas fa-balance-scale me-2"></i>Decisão de Recurso (Comandante)</h5>
                                        <form action="{{ url_for('justica.julgar_recurso', pid=p.id) }}" method="POST">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <div class="row">
                                                <div class="col-md-6 border-end">
                                                    <h6 class="fw-bold text-muted">Argumentação do Aluno:</h6>
                                                    <div class="p-2 bg-white border rounded text-dark fst-italic mb-3" style="white-space: pre-wrap; max-height: 200px; overflow-y: auto;">{{ p.texto_recurso }}</div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label small fw-bold">Veredito do Comandante</label>
                                                        <select name="decisao_recurso" class="form-select border-primary" required>
                                                            <option value="">-- Selecione --</option>
                                                            <option value="INDEFERIDO">INDEFERIDO (Manter a Punição)</option>
                                                            <option value="DEFERIDO">DEFERIDO (Anular a Punição)</option>
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label small">Fundamentação do Parecer</label>
                                                        <textarea name="fundamentacao_recurso" class="form-control" rows="4" required></textarea>
                                                    </div>
                                                    <div class="text-end">
                                                        <button type="button" class="btn btn-secondary btn-sm" onclick="toggleJulgarRecurso('{{ p.id }}')">Cancelar</button>
                                                        <button type="submit" class="btn btn-primary btn-sm fw-bold">Publicar Decisão Final</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    {% endif %}

                                    <div id="collapseProcesso{{ p.id }}" class="mt-3 pt-3 border-top bg-light p-3 rounded" style="display: none;">
                                        <form action="{{ url_for('justica.finalizar_processo', pid=p.id) }}" method="POST">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <div class="row">
                                                <div class="col-md-6 border-end">
                                                    <h6 class="fw-bold text-muted">Fato Constatado:</h6>
                                                    <div class="p-2 bg-white border rounded text-dark mb-3">{{ p.fato_constatado }}</div>
                                                    
                                                    {% if p.defesa %}
                                                    <div class="alert alert-secondary border-secondary">
                                                        <h6 class="fw-bold text-dark mb-1">Defesa do Aluno:</h6>
                                                        <p class="mb-0" style="white-space: pre-wrap;">{{ p.defesa }}</p>
                                                    </div>
                                                    {% else %}
                                                    <div class="alert alert-warning py-2 small">
                                                        <i class="fas fa-exclamation-circle me-1"></i> Aluno não enviou defesa{% if p.is_revelia %} (À REVELIA){% endif %}.
                                                    </div>
                                                    {% endif %}
                                                </div>

                                                <div class="col-md-6">
                                                    <h6 class="fw-bold text-primary">Decisão do Chefe CAL</h6>
                                                    <div class="mb-3">
                                                        <label class="form-label small fw-bold">Punição Aplicada</label>
                                                        <select name="decisao" class="form-select" required onchange="toggleInputsInline(this, '{{ p.id }}')">
                                                            <option value="">-- Selecione --</option>
                                                            <option value="Justificado">Justificado (Sem punição)</option>
                                                            <option value="Advertência">Advertência</option>
                                                            <option value="Repreensão">Repreensão</option>
                                                            <option value="Sustação da Dispensa">Sustação da Dispensa</option>
                                                            <option value="absolver">Absolver / Arquivar</option>
                                                        </select>
                                                    </div>

                                                    <div class="mb-3" id="divTurnos{{ p.id }}" style="display:none;">
                                                        <label class="form-label small text-danger fw-bold">Sustação (1 Turno = 6 horas):</label>
                                                        <select name="turnos_sustacao" class="form-select border-danger text-danger fw-bold">
                                                            <option value="">Selecione...</option>
                                                            {% for i in range(1, 9) %}
                                                            <option value="{{ i }} Turno(s) ({{ i*6 }}h)">{{ i }} Turno(s) ({{ i*6 }}h)</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>

                                                    <div class="mb-3" id="divPontos{{ p.id }}" style="display:none;">
                                                        <label class="form-label small">Pontos Perdidos:</label>
                                                        <input type="number" step="0.01" name="pontos_finais" class="form-control" value="{{ p.pontos }}">
                                                    </div>

                                                    <div class="mb-3">
                                                        <label class="form-label small">Fundamentação da Decisão</label>
                                                        <textarea name="observacao_decisao" class="form-control" rows="4" placeholder="Justifique sua decisão..." required></textarea>
                                                    </div>

                                                    <div class="text-end">
                                                        <button type="button" class="btn btn-secondary btn-sm" onclick="toggleAnalise('{{ p.id }}')">Cancelar</button>
                                                        <button type="submit" class="btn btn-primary btn-sm fw-bold">Confirmar e Notificar Aluno</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info">Nenhum processo disciplinar em andamento.</div>
                    {% endif %}
                </div>

                <div class="justice-content" id="finalizadosContent">
                    {% if finalizados %}
                        {% for p in finalizados %}
                            <div class="card mb-2 bg-light border-success">
                                <div class="card-body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-9">
                                            <strong>{{ p.aluno.user.nome_completo }}</strong> - {{ p.decisao_final or 'Concluído' }}
                                            {% if p.tipo_sancao == 'Sustação da Dispensa' %}<span class="badge bg-danger ms-2">{{ p.detalhes_sancao }}</span>{% endif %}
                                            {% if p.decisao_recurso %}<span class="badge bg-info text-dark ms-2">Recurso: {{ p.decisao_recurso }}</span>{% endif %}
                                            <br><small class="text-muted">{{ p.fato_constatado }}</small>
                                        </div>
                                        <div class="col-md-3 text-end">
                                            <span class="badge bg-success">FINALIZADO</span>
                                            {% if p.pontos > 0 %}<span class="badge bg-secondary ms-1">-{{ p.pontos }} pts</span>{% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info">Nenhum processo finalizado ainda.</div>
                    {% endif %}
                </div>

                </div>
        </div>
    </div>
</div>

<style>
    .justice-page-layout { display: block; width: 100%; overflow-x: hidden; }
    .justice-options { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .justice-content { display: none; width: 100%; }
    .justice-content.active { display: block; }
    .ts-control { min-height: 38px; border-radius: 0.375rem; }
    .ts-wrapper { max-width: 100%; }
    .ts-dropdown .option { white-space: normal !important; word-wrap: break-word; }
</style>

<script>
// --- FUNÇÕES DE TOGGLE ---
function toggleAnalise(id) { const el = document.getElementById('collapseProcesso' + id); el.style.display = (el.style.display === 'none') ? 'block' : 'none'; }
function toggleDefesa(id) { const el = document.getElementById('collapseDefesa' + id); el.style.display = (el.style.display === 'none') ? 'block' : 'none'; }
function toggleRecurso(id) { const el = document.getElementById('collapseRecurso' + id); el.style.display = (el.style.display === 'none') ? 'block' : 'none'; }
function toggleJulgarRecurso(id) { const el = document.getElementById('collapseJulgarRecurso' + id); el.style.display = (el.style.display === 'none') ? 'block' : 'none'; }

function toggleInputsInline(selectEl, id) {
    const divTurnos = document.getElementById('divTurnos' + id);
    const divPontos = document.getElementById('divPontos' + id);
    divTurnos.style.display = (selectEl.value === 'Sustação da Dispensa') ? 'block' : 'none';
    divPontos.style.display = (['Advertência', 'Repreensão', 'Sustação da Dispensa'].includes(selectEl.value)) ? 'block' : 'none';
}

// --- CRONÔMETROS ---
function iniciarCronometros() {
    const elementos = document.querySelectorAll('.cronometro-prazo');
    if (elementos.length === 0) return;

    setInterval(() => {
        const agora = new Date().getTime();
        let precisaRecarregar = false;

        elementos.forEach(el => {
            const prazoStr = el.getAttribute('data-prazo');
            if (!prazoStr) return;
            const prazo = new Date(prazoStr).getTime();
            const diff = prazo - agora;

            if (diff <= 0) {
                el.innerHTML = "Tempo Esgotado!";
                if (!el.classList.contains('bg-danger')) {
                    el.classList.replace('bg-dark', 'bg-danger');
                    precisaRecarregar = true; 
                }
            } else {
                const h = Math.floor(diff / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                el.innerHTML = `⏳ ${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }
        });

        if (precisaRecarregar) { setTimeout(() => { window.location.reload(); }, 2500); }
    }, 1000);
}

document.addEventListener('DOMContentLoaded', function() {
    iniciarCronometros();
    
    // Inicialização do TomSelect (Mantida conforme original)
    if(document.getElementById("regraSelect")) {
        window.controlRegra = new TomSelect("#regraSelect", { create: false, allowEmptyOption: true, maxOptions: 1000 });
    }

    // Controle de Abas
    document.querySelectorAll('.justice-option-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if(this.tagName.toLowerCase() === 'a') return;
            document.querySelectorAll('.justice-option-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.justice-content').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            const target = document.getElementById(this.dataset.target);
            if(target) target.classList.add('active');
        });
    });
});
</script>
{% endblock %}