{% extends "base.html" %}

{% block title %}Justi√ßa e Disciplina{% endblock %}

{% block content %}
<div class="content-header">
    <h1>Justi√ßa e Disciplina</h1>
    <p>Acompanhamento de processos disciplinares e avalia√ß√£o atitudinal.</p>
</div>

<div class="justice-page-layout">
    <div class="justice-main-content">
        <div class="justice-container">
            <div class="justice-options">
                <button class="btn btn-primary justice-option-btn active" data-target="inProgressContent">Em Andamento</button>
                <button class="btn btn-warning justice-option-btn" data-target="finalizadosContent">Finalizados</button>

                {# PERMISS√ïES DE GEST√ÉO #}
                {% if current_user.is_cal or current_user.role in ['admin_escola', 'programador', 'super_admin'] %}
                    <button class="btn btn-danger justice-option-btn" data-target="newTransgressionContent">Nova Infra√ß√£o</button>
                    
                    {# NOVO: Bot√£o de Elogio #}
                    <a href="{{ url_for('aluno.listar_alunos') }}" class="btn btn-success justice-option-btn">Novo Elogio</a>

                    {# NOVO: Bot√£o de Mala Direta #}
                    <a href="{{ url_for('justica.registrar_em_massa') }}" class="btn btn-dark justice-option-btn">Mala Direta</a>

                    {% if permite_pontuacao %}
                        <a href="{{ url_for('justica.fada_lista_alunos') }}" class="btn btn-info justice-option-btn">Avalia√ß√£o FADA</a>
                    {% endif %}
                {% endif %}

                {# EXPORTA√á√ÉO #}
                {% if current_user.is_cal or current_user.role in ['admin_escola', 'programador', 'super_admin'] %}
                    <a href="{{ url_for('justica.exportar_selecao') }}" class="btn btn-secondary justice-option-btn">Exportar BI</a>
                {% endif %}
            </div>

            <div class="justice-content active" id="inProgressContent">
                <h3 class="justice-content-title">Processos em Andamento</h3>
                {% if em_andamento %}
                    {% for processo in em_andamento %}
                        {% if current_user.role == 'aluno' %}
                            {% include 'partials/_processo_card_aluno.html' %}
                        {% else %}
                            {% include 'partials/_processo_card_admin.html' %}
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">Nenhum processo em andamento encontrado.</div>
                {% endif %}
            </div>

            <div class="justice-content" id="finalizadosContent">
                <h3 class="justice-content-title">Processos Finalizados</h3>
                {% if finalizados %}
                    {% for processo in finalizados %}
                        {% if current_user.role == 'aluno' %}
                            {% include 'partials/_processo_card_aluno.html' %}
                        {% else %}
                            {% include 'partials/_processo_card_admin.html' %}
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">Nenhum processo finalizado encontrado.</div>
                {% endif %}
            </div>

            {% if current_user.is_cal or current_user.role in ['admin_escola', 'programador', 'super_admin'] %}
            <div class="justice-content" id="newTransgressionContent">
                <h3 class="justice-content-title">Registrar Nova Infra√ß√£o (Individual)</h3>
                <form method="POST" action="{{ url_for('justica.novo_processo') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="fato_pontos" id="fato_pontos" value="0.0">
                    <input type="hidden" name="regra_id" id="regra_id_hidden"> 

                    <div class="form-group mb-3">
                        <label for="aluno_search_input" class="form-label fw-bold">Aluno</label>
                        <div class="search-form-container">
                            <div class="input-group">
                                <input type="search" id="aluno_search_input" class="form-control" placeholder="Buscar por nome ou matr√≠cula..." autocomplete="off">
                            </div>
                        </div>
                        <div id="aluno_results" class="search-results"></div>
                        <input type="hidden" name="aluno_id" id="aluno_id_hidden" required>
                        <div id="aluno_selected" class="selected-item-display" style="display: none;"></div>
                    </div>

                    <div id="transgression_fields" style="display: none;">
                        
                        <div class="form-group mb-3">
                            <label class="form-label fw-bold">Data do Fato</label>
                            <input type="date" name="data_fato" class="form-control" value="{{ now().strftime('%Y-%m-%d') if now else '' }}">
                        </div>

                        {% if fatos_predefinidos %}
                        <div class="form-group mb-3">
                            <label for="fato_search_input" class="form-label fw-bold">Fato Constatado (Selecione da Lista)</label>
                            <input type="text" id="fato_search_input" class="form-control mb-2" placeholder="Pesquisar c√≥digo ou descri√ß√£o...">

                            <div class="facts-list-container" id="facts-list-container">
                                {% for rule in fatos_predefinidos %}
                                    <div class="result-item"
                                     data-id="{{ rule.id }}" 
                                     data-fato="({{ rule.codigo }}) {{ rule.descricao }}"
                                     data-pontos="{{ rule.pontos if permite_pontuacao else '0.0' }}">

                                    <strong>{{ rule.codigo }}</strong> - {{ rule.descricao }}

                                    {% if permite_pontuacao %}
                                        <span class="badge bg-danger float-end">{{ rule.pontos }} pts</span>
                                    {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                            <input type="hidden" id="fato_hidden_input" name="fato_descricao" required>
                        </div>

                        {% else %}
                        <div class="form-group mb-3">
                            <label for="fato_descricao_manual" class="form-label fw-bold">Fato Constatado (Manual)</label>
                            <div class="alert alert-warning py-2 small">Nenhuma regra cadastrada. O c√°lculo autom√°tico da FADA n√£o funcionar√° para este registro.</div>
                            <textarea id="fato_descricao_manual" name="fato_descricao" class="form-control" rows="3" placeholder="Descreva o fato..." required></textarea>
                        </div>
                        {% endif %}

                        <div class="form-group mb-3">
                            <label for="observacao" class="form-label fw-bold">Termo de Justifica√ß√£o (Observa√ß√£o)</label>
                            <textarea id="observacao" name="observacao" class="form-control" rows="10"></textarea>
                        </div>
                        
                        <div class="form-actions d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary px-4"><i class="fas fa-save me-2"></i>Registrar Processo</button>
                        </div>
                    </div>
                </form>
            </div>
            {% endif %}

        </div>
    </div>

    <div class="justice-sidebar">
        {% if current_user.is_cal or current_user.role in ['admin_escola', 'programador', 'super_admin'] %}
            
            {% if permite_pontuacao %}
            <a href="{{ url_for('justica.analise') }}" class="analysis-card mb-3">
                <div class="analysis-card-icon">üìä</div>
                <div class="analysis-card-text">
                    <h4>An√°lise de Dados</h4>
                    <p>Estat√≠sticas e Gr√°ficos.</p>
                </div>
            </a>
            
            {# NOVO: Configura√ß√£o de Regras #}
            <a href="{{ url_for('regras.index') }}" class="analysis-card mb-3" style="background: linear-gradient(135deg, #6c757d, #495057);">
                <div class="analysis-card-icon">‚öôÔ∏è</div>
                <div class="analysis-card-text">
                    <h4>Configurar Regras</h4>
                    <p>Vincular infra√ß√µes √† FADA.</p>
                </div>
            </a>
            {% endif %}

        {% endif %}
    </div>
</div>

<style>
    /* Estilos CSS mantidos e ajustados */
    .justice-page-layout { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    @media (min-width: 992px) { .justice-page-layout { grid-template-columns: 3fr 1fr; } }
    
    .analysis-card { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 1.5rem; border-radius: var(--border-radius); background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light)); color: white; text-decoration: none; transition: all 0.3s ease; border: 2px solid transparent; min-height: 120px; box-shadow: var(--shadow-soft); }
    .analysis-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-medium); border-color: rgba(255, 255, 255, 0.5); color: white; }
    .analysis-card-icon { font-size: 2rem; line-height: 1; margin-bottom: 0.5rem; }
    .analysis-card-text h4 { font-size: 1.1rem; font-weight: 700; margin: 0; }
    .analysis-card-text p { font-size: 0.8rem; opacity: 0.9; margin: 0; }

    .facts-list-container { max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px; background: #fff; }
    .result-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f1f1f1; transition: background 0.2s; }
    .result-item:last-child { border-bottom: none; }
    .result-item:hover { background-color: #f8f9fa; }
    .result-item.selected { background-color: #e7f1ff; border-left: 4px solid var(--color-primary); }

    .justice-options { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem; align-items: center; }
    .justice-option-btn.active { box-shadow: inset 0 3px 5px rgba(0,0,0,0.125); border: 2px solid transparent; }
    .justice-content { display: none; animation: fadeIn 0.3s; }
    .justice-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .search-results { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; border-radius: 0 0 8px 8px; background: white; position: absolute; width: 100%; z-index: 1000; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .selected-item-display { background-color: #e9ecef; padding: 10px; border-radius: 4px; margin-top: 5px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #ced4da; }
    .remove-selected-btn { cursor: pointer; color: #dc3545; font-size: 1.2rem; font-weight: bold; padding: 0 5px; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- L√≥gica das abas ---
    const optionBtns = document.querySelectorAll('.justice-option-btn');
    const contentDivs = document.querySelectorAll('.justice-content');
    
    // Verifica se √© um bot√£o de aba (tem data-target)
    optionBtns.forEach(btn => {
        if(btn.dataset.target) {
            btn.addEventListener('click', function() {
                // Remove active de todos os bot√µes que s√£o abas
                optionBtns.forEach(b => {
                    if(b.dataset.target) b.classList.remove('active');
                });
                this.classList.add('active');
                
                contentDivs.forEach(div => div.classList.remove('active'));
                const targetElement = document.getElementById(this.dataset.target);
                if (targetElement) {
                    targetElement.classList.add('active');
                }
            });
        }
    });

    // --- Elementos do Formul√°rio ---
    const alunoSearchInput = document.getElementById('aluno_search_input');
    const alunoResults = document.getElementById('aluno_results');
    const alunoHiddenInput = document.getElementById('aluno_id_hidden');
    const alunoSelectedDisplay = document.getElementById('aluno_selected');
    const transgressionFields = document.getElementById('transgression_fields');
    const observacaoTextarea = document.getElementById('observacao');

    let observacaoTemplateOriginal = '';

    // --- Busca de Aluno ---
    if (alunoSearchInput) {
        let searchTimeout;
        alunoSearchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value;

            alunoHiddenInput.value = '';
            transgressionFields.style.display = 'none';

            if (query.length < 2) {
                alunoResults.style.display = 'none';
                return;
            }
            searchTimeout = setTimeout(() => {
                fetch(`{{ url_for('justica.api_get_alunos') }}?q=${query}`)
                    .then(response => response.json())
                    .then(data => {
                        alunoResults.innerHTML = '';
                        if (data.length > 0) {
                            data.forEach(aluno => {
                                const item = document.createElement('div');
                                item.className = 'result-item';
                                item.textContent = aluno.text;
                                item.dataset.id = aluno.id;
                                item.addEventListener('click', function() {
                                    selectAluno(this.dataset.id, this.textContent);
                                });
                                alunoResults.appendChild(item);
                            });
                            alunoResults.style.display = 'block';
                        } else {
                            alunoResults.style.display = 'none';
                        }
                    });
            }, 300);
        });

        function selectAluno(alunoId, alunoText) {
            alunoSearchInput.style.display = 'none';
            alunoSelectedDisplay.innerHTML = `<span><strong>${alunoText}</strong></span><span class="remove-selected-btn" title="Remover sele√ß√£o"> &times;</span>`;
            alunoSelectedDisplay.style.display = 'flex';
            alunoHiddenInput.value = alunoId;
            alunoResults.style.display = 'none';

            const url = "{{ url_for('justica.api_get_aluno_details', aluno_id=0) }}".replace('/0', '/' + alunoId);

            fetch(url)
                .then(response => response.json())
                .then(details => {
                    const hoje = new Date();
                    const dia = hoje.getDate();
                    const mes = hoje.toLocaleString('pt-BR', { month: 'long' });
                    const ano = hoje.getFullYear();
                    const autoridadeNome = "{{ current_user.nome_completo or 'NOME DA AUTORIDADE' }}";
                    const autoridadePosto = "{{ current_user.posto_graduacao or 'POSTO DA AUTORIDADE' }}";

                    observacaoTemplateOriginal = `Tendo em vista as informa√ß√µes constantes na Parte N¬∫ 000/CAl/EsFAS/${ano}, evidenciando a exist√™ncia, em tese, de infra√ß√£o das Normas de Procedimentos e Condutas do Corpo de Alunos e proporcionando assegurar o direito de defesa, formulo o seguinte termo de justifica√ß√£o:\n\n1. Justificante: ${details.posto_graduacao} ${details.nome_completo}, Id Func. ${details.matricula}.\n\n2. Descri√ß√£o da conduta infracional: O(a) ${details.posto_graduacao} ${details.nome_completo}, Id Func. ${details.matricula}, no dia ${dia} de ${mes} de ${ano}, ...... \nCom isso, incorreu no item...\n\n3. Cientifico-lhe que a contar do recebimento da presente, abre-se o prazo de 24 horas, para que, querendo, apresente resposta escrita com as provas que entender cab√≠veis. Fica advertido o acusado que a n√£o entrega da justifica√ß√£o dentro do prazo estipulado, implicar√° em reconhecimento como verdadeiros os fatos imputados.\n\n\n${autoridadeNome}\n${autoridadePosto}`;
                    
                    observacaoTextarea.value = observacaoTemplateOriginal;
                    transgressionFields.style.display = 'block';

                    updateObservacaoComFato(null);

                    document.getElementById('fato_pontos').value = '0.0';
                    const regraHidden = document.getElementById('regra_id_hidden');
                    if(regraHidden) regraHidden.value = '';

                    const fatoHiddenInput = document.getElementById('fato_hidden_input');
                    if (fatoHiddenInput) {
                        fatoHiddenInput.value = '';
                        const fatoItems = document.querySelectorAll('.facts-list-container .result-item');
                        fatoItems.forEach(i => i.classList.remove('selected'));
                    }
                });
        }

        alunoSelectedDisplay.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-selected-btn')) {
                alunoSearchInput.style.display = 'block';
                alunoSearchInput.value = '';
                alunoSelectedDisplay.style.display = 'none';
                alunoHiddenInput.value = '';
                transgressionFields.style.display = 'none';
                observacaoTextarea.value = '';
                observacaoTemplateOriginal = '';
                alunoSearchInput.focus();
            }
        });

        document.addEventListener('click', function(e) {
            if (!alunoSearchInput.contains(e.target) && !alunoResults.contains(e.target)) {
                alunoResults.style.display = 'none';
            }
        });
    }

    // --- L√≥gica do Fato Constatado (Seletor) ---
    const fatoSearchInput = document.getElementById('fato_search_input');

    if (fatoSearchInput) {
        const fatoListContainer = document.getElementById('facts-list-container');
        const fatoHiddenInput = document.getElementById('fato_hidden_input');
        const fatoPontosInput = document.getElementById('fato_pontos');
        const regraIdInput = document.getElementById('regra_id_hidden');
        const fatoItems = fatoListContainer.querySelectorAll('.result-item');

        fatoSearchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            fatoItems.forEach(item => {
                const fatoText = item.innerText.toLowerCase();
                item.style.display = fatoText.includes(query) ? 'block' : 'none';
            });
        });

        fatoItems.forEach(item => {
            item.addEventListener('click', function() {
                fatoItems.forEach(i => i.classList.remove('selected'));
                this.classList.add('selected');

                const fatoText = this.dataset.fato;
                const pontos = this.dataset.pontos || 0.0;
                const regraId = this.dataset.id; // Pega o ID da regra

                fatoHiddenInput.value = fatoText;
                fatoPontosInput.value = pontos;
                if(regraIdInput) regraIdInput.value = regraId; // Salva o ID para c√°lculo

                updateObservacaoComFato(fatoText);
            });
        });
    }

    function updateObservacaoComFato(fatoText) {
        let textoObservacao = observacaoTemplateOriginal;

        if (fatoText) {
            const regex = /^\(([^)]+)\)\s*(.*)$/;
            const match = fatoText.match(regex);
            let fatoDetalhes = fatoText;

            if (match) {
                const codigo = match[1];
                const descricao = match[2].trim();
                fatoDetalhes = `no item ${codigo} - "${descricao}"`;
            }
            textoObservacao = textoObservacao.replace(/no item\.\.\./, `${fatoDetalhes};`);
        } else {
            textoObservacao = textoObservacao.replace(/\nCom isso, incorreu no item\.\.\./, '');
        }

        observacaoTextarea.value = textoObservacao;
    }
});
</script>
{% endblock %}