{% extends "base.html" %}

{% block title %}Justi√ßa e Disciplina{% endblock %}

{% block content %}
<div class="content-header">
    <h1>Justi√ßa e Disciplina</h1>
    <p>Acompanhamento de processos disciplinares.</p>
</div>

<div class="justice-page-layout">
    <div class="justice-main-content">
        <div class="justice-container">
            <div class="justice-options">
                <button class="btn btn-primary justice-option-btn active" data-target="inProgressContent">Em Andamento</button>
                <button class="btn btn-warning justice-option-btn" data-target="finalizadosContent">Finalizados</button>
                {% if current_user.role != 'aluno' %}
                <button class="btn btn-success justice-option-btn" data-target="newTransgressionContent">Nova Transgress√£o</button>
                <a href="{{ url_for('justica.exportar_selecao') }}" class="btn btn-info">Exportar para Aditamento Interno</a>
                {% endif %}
            </div>

            <div class="justice-content active" id="inProgressContent">
                <h3 class="justice-content-title">Processos em Andamento</h3>
                {% for processo in em_andamento %}
                    {% if current_user.role == 'aluno' %}
                        {% include 'partials/_processo_card_aluno.html' %}
                    {% else %}
                        {% include 'partials/_processo_card_admin.html' %}
                    {% endif %}
                {% else %}
                    <p>Nenhum processo em andamento encontrado.</p>
                {% endfor %}
            </div>
            
            <div class="justice-content" id="finalizadosContent">
                <h3 class="justice-content-title">Processos Finalizados</h3>
                {% for processo in finalizados %}
                    {% if current_user.role == 'aluno' %}
                        {% include 'partials/_processo_card_aluno.html' %}
                    {% else %}
                        {% include 'partials/_processo_card_admin.html' %}
                    {% endif %}
                {% else %}
                    <p>Nenhum processo finalizado encontrado.</p>
                {% endfor %}
            </div>

            {% if current_user.role != 'aluno' %}
            <div class="justice-content" id="newTransgressionContent">
                <h3 class="justice-content-title">Registrar Nova Transgress√£o</h3>
                <form method="POST" action="{{ url_for('justica.novo_processo') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="form-group">
                        <label for="aluno_search_input">Aluno</label>
                        <div class="search-form-container">
                            <div class="input-group">
                                <input type="search" id="aluno_search_input" class="form-control" placeholder="Buscar por nome ou matr√≠cula..." autocomplete="off">
                            </div>
                        </div>
                        <div id="aluno_results" class="search-results"></div>
                        <input type="hidden" name="aluno_id" id="aluno_id_hidden" required>
                        <div id="aluno_selected" class="selected-item-display" style="display: none;"></div>
                    </div>
                    
                    <div id="transgression_fields" style="display: none;">
                        <div class="form-group">
                            <label for="fato">Fato Constatado</label>
                            <textarea id="fato" name="fato" class="form-control" rows="4" required placeholder="Descreva aqui o fato ocorrido..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="observacao">Observa√ß√£o (Termo de Justifica√ß√£o)</label>
                            <textarea id="observacao" name="observacao" class="form-control" rows="12"></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Registrar</button>
                        </div>
                    </div>
                </form>
            </div>
            {% endif %}
        </div>
    </div>
    <div class="justice-sidebar">
        {% if current_user.role != 'aluno' %}
        <a href="{{ url_for('justica.analise') }}" class="analysis-card">
            <div class="analysis-card-icon">üìä</div>
            <div class="analysis-card-text">
                <h4>An√°lise de Dados</h4>
                <p>Gr√°ficos e estat√≠sticas sobre as transgress√µes.</p>
            </div>
        </a>
        {% endif %}
    </div>
</div>

<style>
    /* --- NOVOS ESTILOS PARA O LAYOUT E O CARD DE AN√ÅLISE --- */
    .justice-page-layout {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }

    /* Em telas maiores, cria a divis√£o em duas colunas */
    @media (min-width: 992px) {
        .justice-page-layout {
            grid-template-columns: 3fr 1fr;
        }
    }

    .analysis-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 1.5rem;
        border-radius: var(--border-radius);
        background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light));
        color: white;
        text-decoration: none;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        min-height: 150px;
        box-shadow: var(--shadow-soft);
    }

    .analysis-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-medium);
        border-color: rgba(255, 255, 255, 0.5);
    }

    .analysis-card-icon {
        font-size: 2.5rem;
        line-height: 1;
        margin-bottom: 0.75rem;
    }

    .analysis-card-text h4 {
        font-size: 1.2rem;
        font-weight: 700;
        margin: 0 0 0.25rem 0;
    }

    .analysis-card-text p {
        font-size: 0.8rem;
        opacity: 0.8;
        margin: 0;
    }

    /* --- ESTILOS EXISTENTES --- */
    .justice-options { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem; align-items: center; }
    .justice-option-btn.active {
        filter: brightness(1.1);
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.15);
        transform: translateY(1px);
    }
    .justice-content { display: none; }
    .justice-content.active { display: block; }
    .justice-content-title { margin-bottom: 1.5rem; }
    .process-card { background-color: var(--color-white); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; border: 1px solid var(--color-border); border-left-width: 4px; }
    .process-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
    .process-title { font-weight: bold; }
    .process-id { font-size: 0.8rem; color: var(--color-text-muted); }
    .process-detail { margin-bottom: 0.75rem; }
    .detail-label { font-weight: 600; }
    .status-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
    .status-badge.pendente { background-color: #fefce8; color: #a16207; }
    .status-badge.notificado { background-color: #eff6ff; color: #1d4ed8; }
    .status-badge.defesa-enviada { background-color: #f0fdf4; color: #166534; }
    .status-badge.finalizado { background-color: #f1f5f9; color: #475569; }
    .search-form-container { position: relative; }
    .search-results { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; border-radius: 0 0 8px 8px; background: white; position: absolute; width: 100%; z-index: 10; display: none; }
    .result-item { padding: 10px; cursor: pointer; }
    .result-item:hover { background-color: #f0f0f0; }
    .selected-item-display { background-color: #e9ecef; padding: 10px; border-radius: 4px; margin-top: 5px; display: flex; justify-content: space-between; align-items: center; }
    .remove-selected-btn { cursor: pointer; color: red; font-weight: bold; }
    .preserve-whitespace { white-space: pre-wrap; word-wrap: break-word; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const optionBtns = document.querySelectorAll('.justice-option-btn');
    const contentDivs = document.querySelectorAll('.justice-content');
    const searchInput = document.getElementById('aluno_search_input');
    const resultsContainer = document.getElementById('aluno_results');
    const hiddenInput = document.getElementById('aluno_id_hidden');
    const selectedDisplay = document.getElementById('aluno_selected');
    const transgressionFields = document.getElementById('transgression_fields');
    const fatoTextarea = document.getElementById('fato');
    const observacaoTextarea = document.getElementById('observacao');

    optionBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // L√≥gica para alternar o bot√£o ativo
            optionBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            // L√≥gica para mostrar/esconder conte√∫do
            contentDivs.forEach(div => div.classList.remove('active'));
            document.getElementById(this.dataset.target).classList.add('active');
        });
    });

    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value;
            hiddenInput.value = '';
            transgressionFields.style.display = 'none';

            if (query.length < 2) {
                resultsContainer.innerHTML = '';
                resultsContainer.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                fetch(`{{ url_for('justica.api_get_alunos') }}?q=${query}`)
                    .then(response => response.json())
                    .then(data => {
                        resultsContainer.innerHTML = '';
                        if (data.length > 0) {
                            data.forEach(aluno => {
                                const item = document.createElement('div');
                                item.className = 'result-item';
                                item.textContent = aluno.text;
                                item.dataset.id = aluno.id;
                                item.addEventListener('click', function() {
                                    selectAluno(this.dataset.id, this.textContent);
                                });
                                resultsContainer.appendChild(item);
                            });
                            resultsContainer.style.display = 'block';
                        } else {
                            resultsContainer.style.display = 'none';
                        }
                    });
            }, 300);
        });

        function selectAluno(alunoId, alunoText) {
            searchInput.style.display = 'none';
            selectedDisplay.innerHTML = `<span>${alunoText}</span><span class="remove-selected-btn" title="Remover sele√ß√£o"> &times;</span>`;
            selectedDisplay.style.display = 'flex';
            hiddenInput.value = alunoId;
            resultsContainer.style.display = 'none';
            
            fetch(`{{ url_for('justica.api_get_aluno_details', aluno_id=0) }}${alunoId}`)
                .then(response => response.json())
                .then(details => {
                    const hoje = new Date();
                    const dia = hoje.getDate();
                    const mes = hoje.toLocaleString('pt-BR', { month: 'long' });
                    const ano = hoje.getFullYear();

                    const autoridadeNome = "{{ current_user.nome_completo or 'NOME DA AUTORIDADE' }}";
                    const autoridadePosto = "{{ current_user.posto_graduacao or 'POSTO DA AUTORIDADE' }}";
                    
                    const obsTemplate = `Tendo em vista as informa√ß√µes constantes na Parte N¬∫ 000/CAl/EsFAS/${ano}, evidenciando a exist√™ncia, em tese, de transgress√£o das Normas de Procedimentos e Condutas do Corpo de Alunos e proporcionando assegurar o direito de defesa, formulo o seguinte termo de justifica√ß√£o:\n\n1. Justificante: ${details.posto_graduacao} ${details.nome_completo}, Id Func. ${details.matricula}.\n\n2. Descri√ß√£o da conduta infracional: O ${details.posto_graduacao} ${details.nome_completo}, Id Func. ${details.matricula}, no dia ${dia} de ${mes} de ${ano}, ...... \nCom isso, incorreu no item...\n\n3. Cientifico-lhe que a contar do recebimento da presente, abre-se o prazo de 24 horas, para que, querendo, apresente resposta escrita com as provas que entender cab√≠veis. Fica advertido o acusado que a n√£o entrega da justifica√ß√£o dentro do prazo estipulado, implicar√° em reconhecimento como verdadeiros os fatos imputados.\n\n\n${autoridadeNome}\n${autoridadePosto}`;

                    fatoTextarea.value = '';
                    observacaoTextarea.value = obsTemplate;
                    transgressionFields.style.display = 'block';
                });
        }
        
        selectedDisplay.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-selected-btn')) {
                searchInput.style.display = 'block';
                searchInput.value = '';
                selectedDisplay.style.display = 'none';
                hiddenInput.value = '';
                transgressionFields.style.display = 'none';
                fatoTextarea.value = '';
                observacaoTextarea.value = '';
                searchInput.focus();
            }
        });

        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target)) {
                resultsContainer.style.display = 'none';
            }
        });
    }
});
</script>
{% endblock %}