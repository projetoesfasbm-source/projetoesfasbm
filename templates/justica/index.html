{% extends "base.html" %}

{% block title %}Justiça e Disciplina{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

{% set school_type = 'ctsp' %}
{% if g.active_school and g.active_school.npccal_type %}
    {% set school_type = g.active_school.npccal_type|lower %}
{% endif %}
{% set show_fada = (school_type in ['cbfpm', 'cspm']) %}

<div class="content-header">
    <h1>Justiça e Disciplina</h1>
    <p>Gestão de processos disciplinares e avaliação atitudinal.</p>
</div>

<div class="justice-page-layout">
    <div class="justice-main-content">
        <div class="justice-container">

            <div class="justice-options">
                <button class="btn btn-primary justice-option-btn active" data-target="inProgressContent">Em Andamento</button>
                <button class="btn btn-warning justice-option-btn" data-target="finalizadosContent">Finalizados</button>

                {% if current_user.role != 'aluno' %}
                    <button class="btn btn-danger justice-option-btn" data-target="newInfracaoContent">
                        <i class="fas fa-exclamation-triangle me-1"></i>Nova Infração
                    </button>
                    <button class="btn btn-success justice-option-btn" data-target="newElogioContent">
                        <i class="fas fa-star me-1"></i>Novo Elogio
                    </button>

                    {% if show_fada %}
                    <a href="{{ url_for('justica.fada_boletim') }}" class="btn btn-info text-white justice-option-btn">
                        <i class="fas fa-clipboard-list me-1"></i> Boletim / Avaliar (FADA)
                    </a>
                    {% endif %}
                {% endif %}
            </div>

            <div class="justice-content active" id="inProgressContent">
                <h3 class="justice-content-title">Processos em Andamento</h3>
                {% if em_andamento %}
                    {% for p in em_andamento %}
                        <div class="card mb-3 shadow-sm border-start border-4 {{ 'border-warning' if p.status == 'AGUARDANDO_CIENCIA' else 'border-primary' }}">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-2">
                                        <small class="text-muted d-block">Data</small>
                                        <strong>{{ p.data_ocorrencia.strftime('%d/%m/%Y') }}</strong>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted d-block">Aluno</small>
                                        <span class="fw-bold">{{ p.aluno.user.nome_completo }}</span>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted d-block">Fato/Status</small>
                                        <div class="text-truncate text-dark" title="{{ p.fato_constatado }}">{{ p.fato_constatado }}</div>
                                        <span class="badge bg-secondary">{{ p.status }}</span>
                                    </div>
                                    <div class="col-md-3 text-end">
                                        <div class="btn-group">
                                            {% if current_user.role != 'aluno' %}
                                                <button type="button" class="btn btn-sm btn-info text-white" 
                                                        onclick='abrirModalAnalise({{ p.id }}, "{{ p.aluno.user.nome_completo }}", `{{ p.fato_constatado | replace("`", "") }}`)'>
                                                    <i class="fas fa-gavel"></i> Analisar
                                                </button>
                                                
                                                <form action="{{ url_for('justica.deletar_processo', pid=p.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Tem certeza que deseja EXCLUIR este processo?');">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            {% endif %}

                                            {% if p.status == 'AGUARDANDO_CIENCIA' %}
                                            <form action="{{ url_for('justica.dar_ciente', processo_id=p.id) }}" method="POST" class="d-inline ms-1">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button type="submit" class="btn btn-sm btn-warning fw-bold">
                                                    <i class="fas fa-check"></i> Dar Ciente
                                                </button>
                                            </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">Nenhum processo em andamento.</div>
                {% endif %}
            </div>

            <div class="justice-content" id="finalizadosContent">
                <div class="d-flex justify-content-end mb-3">
                    {% if current_user.role != 'aluno' %}
                        <a href="{{ url_for('justica.exportar_selecao') }}" class="btn btn-sm btn-outline-dark">
                            <i class="fas fa-file-export"></i> Exportar Termos
                        </a>
                    {% endif %}
                </div>

                {% if finalizados %}
                    {% for p in finalizados %}
                        <div class="card mb-2 bg-light border-success">
                            <div class="card-body py-2">
                                <div class="row">
                                    <div class="col-8">
                                        <strong>{{ p.aluno.user.nome_completo }}</strong> - {{ p.decisao_final or 'Finalizado' }}
                                        <br><small class="text-muted">{{ p.fato_constatado }}</small>
                                    </div>
                                    <div class="col-4 text-end">
                                        <span class="badge bg-success">Concluído</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">Nenhum processo finalizado.</div>
                {% endif %}
            </div>

            <div class="justice-content" id="newInfracaoContent">
               {% include 'templates/justica/partials_form_infracao_stub.html' ignore missing %}
                <div class="alert alert-warning">Utilize o formulário de registro original aqui (código preservado no controller).</div>
                </div>

            <div class="justice-content" id="newElogioContent">
                <div class="alert alert-success">Utilize o formulário de elogio original aqui.</div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="modalAnalise" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formAnaliseProcesso" method="POST" action="">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title"><i class="fas fa-gavel me-2"></i>Analisar / Julgar Processo</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3 p-2 bg-light rounded border">
                <p class="mb-1"><strong>Aluno:</strong> <span id="modalAlunoNome" class="text-primary"></span></p>
                <label class="small fw-bold text-muted">Descrição do Fato:</label>
                <p id="modalFatoDesc" class="fst-italic border p-2 bg-white rounded" style="white-space: pre-wrap;"></p>
            </div>
            <hr>
            <div class="mb-3">
                <label class="form-label fw-bold">Decisão do Chefe</label>
                <select name="decisao" class="form-select" required onchange="togglePontos(this.value)">
                    <option value="">-- Selecione --</option>
                    <option value="justificar">Justificar (Sem punição)</option>
                    <option value="punir">Punir (Com perda de pontos)</option>
                    <option value="absolver">Absolver (Arquivar)</option>
                </select>
            </div>
            <div class="mb-3" id="divPontos" style="display:none;">
                <label class="form-label">Pontos Perdidos</label>
                <input type="number" step="0.1" name="pontos_finais" class="form-control" placeholder="0.0">
            </div>
            <div class="mb-3">
                <label class="form-label">Fundamentação / Observação</label>
                <textarea name="observacao_decisao" class="form-control" rows="3" placeholder="Digite a fundamentação da decisão..."></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary fw-bold">Salvar Decisão</button>
          </div>
      </form>
    </div>
  </div>
</div>

<style>
    .justice-page-layout { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    @media (min-width: 992px) { .justice-page-layout { grid-template-columns: 3fr 1fr; } }
    .justice-options { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .justice-content { display: none; }
    .justice-content.active { display: block; }
    .ts-control { min-height: 38px; border-radius: 0.375rem; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Inicialização do Select (Mantido)
    if(document.getElementById("regraSelect")) {
        var controlRegra = new TomSelect("#regraSelect", {
            create: false,
            sortField: { field: "text", direction: "asc" },
            allowEmptyOption: true,
            maxOptions: 1000
        });
    }

    // Abas (Mantido)
    document.querySelectorAll('.justice-option-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            if(this.tagName.toLowerCase() === 'a') return;
            document.querySelectorAll('.justice-option-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.justice-content').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            const target = document.getElementById(this.dataset.target);
            if(target) target.classList.add('active');
        });
    });

    // --- FUNÇÃO NOVA PARA ABRIR O MODAL E CORRIGIR O TEXTO ---
    window.abrirModalAnalise = function(idProcesso, nomeAluno, textoFato) {
        // Preenche os campos visuais
        document.getElementById('modalAlunoNome').innerText = nomeAluno;
        document.getElementById('modalFatoDesc').innerText = textoFato || "Sem descrição disponível.";
        
        // Define a ação do formulário para a rota correta
        const form = document.getElementById('formAnaliseProcesso');
        form.action = `/justica-e-disciplina/finalizar-processo/${idProcesso}`;
        
        // Abre o modal usando Bootstrap 5
        var myModal = new bootstrap.Modal(document.getElementById('modalAnalise'));
        myModal.show();
    };

    window.togglePontos = function(val) {
        document.getElementById('divPontos').style.display = (val === 'punir') ? 'block' : 'none';
    };

    window.toggleTiposInfracao = function() {
        const isNPCCAL = document.getElementById('rad_npccal').checked;
        const isRDBM = document.getElementById('rad_rdbm').checked;
        const isCrime = document.getElementById('rad_crime').checked;
        const boxRegras = document.getElementById('box_regras_npccal');
        const boxManual = document.getElementById('box_regras_manual');
        const selectRegra = document.getElementById('regraSelect');
        const inputManual = document.getElementById('inputManualDesc');
        const hiddenOrigem = document.getElementById('hidden_origem_punicao');
        const hiddenCrime = document.getElementById('hidden_is_crime');

        if (isNPCCAL) {
            boxRegras.style.display = 'block';
            boxManual.style.display = 'none';
            // Para Tom Select, habilitar o elemento original
            if (controlRegra) controlRegra.enable();
            inputManual.removeAttribute('required');
            inputManual.value = '';
            hiddenOrigem.value = 'NPCCAL';
            hiddenCrime.value = 'false';
        } else {
            boxRegras.style.display = 'none';
            boxManual.style.display = 'block';
            if (controlRegra) {
                controlRegra.clear();
                controlRegra.disable();
            }
            inputManual.setAttribute('required', 'required');
            if (isRDBM) { hiddenOrigem.value = 'RDBM'; hiddenCrime.value = 'false'; }
            else { hiddenOrigem.value = 'NPCCAL'; hiddenCrime.value = 'true'; }
        }
        atualizarTextoInteligente();
    };

    window.carregarAlunos = function(turmaId, containerId) {
        const container = document.getElementById(containerId);
        if(!turmaId) return;
        container.innerHTML = 'Carregando...';
        fetch(`/justica-e-disciplina/api/alunos-por-turma/${turmaId}`)
            .then(r => r.json())
            .then(data => {
                if (container.tagName === 'SELECT') {
                    let html = '<option value="">-- Selecione o Aluno --</option>';
                    data.forEach(a => {
                        html += `<option value="${a.id}">${a.numero ? a.numero + ' - ' : ''}${a.graduacao} ${a.nome}</option>`;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = data.map(a => `
                        <div class="form-check border-bottom py-1">
                            <input class="form-check-input aluno-check-${containerId}" type="checkbox" name="alunos_selecionados" value="${a.id}" id="chk_${containerId}_${a.id}" onchange="if('${containerId}'=='listaAlunosInfracao') atualizarTextoInteligente()">
                            <label class="form-check-label" for="chk_${containerId}_${a.id}">
                                ${a.numero ? a.numero + ' - ' : ''}${a.nome}
                            </label>
                        </div>
                    `).join('');
                }
            });
    };

    window.toggleTodos = function(cId) {
        const checks = document.querySelectorAll(`.aluno-check-${cId}`);
        const status = Array.from(checks).some(c => !c.checked);
        checks.forEach(c => c.checked = status);
        if(cId === 'listaAlunosInfracao') atualizarTextoInteligente();
    };

    function getDataPorExtenso(dateString) {
        if (!dateString) return "data não informada";
        const parts = dateString.split('-');
        if (parts.length !== 3) return dateString;
        const meses = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
        const dia = parts[2];
        const mes = meses[parseInt(parts[1]) - 1];
        const ano = parts[0];
        return `${dia} de ${mes} de ${ano}`;
    }

    window.atualizarTextoInteligente = function() {
        const checks = document.querySelectorAll('.aluno-check-listaAlunosInfracao:checked');
        const regSel = document.getElementById('regraSelect');
        const isNPCCAL = document.getElementById('rad_npccal').checked;
        const isRDBM = document.getElementById('rad_rdbm').checked;
        const isCrime = document.getElementById('rad_crime').checked;

        let regraDesc = "";
        if (isNPCCAL) {
            if (regSel.selectedIndex >= 0) {
                 regraDesc = regSel.options[regSel.selectedIndex].getAttribute('data-desc') || "";
            }
        } else {
            const manualText = document.getElementById('inputManualDesc').value.trim();
            if (manualText) {
                if (isRDBM) regraDesc = "em transgressão disciplinar: " + manualText;
                if (isCrime) regraDesc = "em fato tipificado como crime: " + manualText;
            } else {
                regraDesc = isRDBM ? "em transgressão disciplinar (descrever)" : "em crime (descrever)";
            }
        }

        const box = document.getElementById('campoObservacao');
        let descFato = document.getElementById('descricaoFatoInput').value.trim();
        if (!descFato) descFato = "[DESCREVER A CONDUTA AQUI]";
        if (descFato.endsWith('.')) descFato = descFato.slice(0, -1);

        const dataInput = document.getElementById('dataFatoInput').value;
        const dataExtenso = getDataPorExtenso(dataInput);
        const anoAtual = new Date().getFullYear();

        if(checks.length === 1) {
            box.value = "Carregando dados...";
            fetch(`/justica-e-disciplina/api/aluno-details/${checks[0].value}`)
                .then(r => r.json())
                .then(d => {
                    const idFunc = `Id Func. ${d.matricula}`;
                    const nomeCompleto = `${d.posto_graduacao} ${d.nome_completo}, ${idFunc}`;
                    const termo = `Termo de Justificação:\nTendo em vista as informações constantes na Parte Nº ___/___Pel/CAl/EsFAS/${anoAtual}, evidenciando a existência, em tese, de infração das Normas de Procedimentos e Condutas do Corpo de Alunos e proporcionando assegurar o direito de defesa, formulo o seguinte termo de justificação:\n\n1. Justificante: ${nomeCompleto}.\n\n2. Descrição da conduta infracional: O ${nomeCompleto}, no dia ${dataExtenso}, ${descFato}. Com isso, incorreu ${regraDesc}.\n\n3. Cientifico-lhe que a contar do recebimento da presente, abre-se o prazo de 24 horas, para que, querendo, apresente resposta escrita com as provas que entender cabíveis. Fica advertido o acusado que a não entrega da justificação dentro do prazo estipulado, implicará em reconhecimento como verdadeiros os fatos imputados.\n\n[NOME, POSTO/GRADUAÇÃO E FUNÇÃO DO RESPONSÁVEL]`;
                    box.value = termo;
                });
        } else if(checks.length > 1) {
             const templateBase = `Termo de Justificação:\nTendo em vista as informações constantes na Parte Nº ___/___Pel/CAl/EsFAS/${anoAtual}, evidenciando a existência, em tese, de infração das Normas de Procedimentos e Condutas do Corpo de Alunos e proporcionando assegurar o direito de defesa, formulo o seguinte termo de justificação:\n\n1. Justificantes: Conforme lista de ${checks.length} alunos selecionados.\n\n2. Descrição da conduta infracional: Os militares selecionados, no dia ${dataExtenso}, ${descFato}. Com isso, incorreram ${regraDesc}.\n\n3. Cientifico-lhes que a contar do recebimento da presente, abre-se o prazo de 24 horas, para que, querendo, apresentem resposta escrita com as provas que entenderem cabíveis.\n\n[NOME, POSTO/GRADUAÇÃO E FUNÇÃO DO RESPONSÁVEL]`;
            box.value = templateBase;
        }
    };
});
</script>
{% endblock %}