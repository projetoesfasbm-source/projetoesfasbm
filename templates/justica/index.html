{% extends "base.html" %}

{% block title %}Justi√ßa e Disciplina{% endblock %}

{% block content %}
<div class="content-header">
    <h1>Justi√ßa e Disciplina</h1>
    <p>Gest√£o de processos disciplinares e avalia√ß√£o atitudinal.</p>
</div>

<div class="justice-page-layout">
    <div class="justice-main-content">
        <div class="justice-container">
            
            <div class="justice-options">
                <button class="btn btn-primary justice-option-btn active" data-target="inProgressContent">Em Andamento</button>
                <button class="btn btn-warning justice-option-btn" data-target="finalizadosContent">Finalizados</button>

                {% if current_user.is_cal or current_user.role in ['admin_escola', 'programador', 'super_admin'] %}
                    
                    <button class="btn btn-danger justice-option-btn" data-target="newInfracaoContent">
                        <i class="fas fa-exclamation-triangle me-1"></i>Nova Infra√ß√£o
                    </button>
                    
                    <button class="btn btn-success justice-option-btn" data-target="newElogioContent">
                        <i class="fas fa-star me-1"></i>Novo Elogio
                    </button>

                {% endif %}

                {% if current_user.is_cal or current_user.role in ['admin_escola', 'programador', 'super_admin'] %}
                    <a href="{{ url_for('justica.exportar_selecao') }}" class="btn btn-secondary justice-option-btn">
                        <i class="fas fa-download me-1"></i>Exportar BI
                    </a>
                {% endif %}
            </div>

            <div class="justice-content active" id="inProgressContent">
                <h3 class="justice-content-title">Processos em Andamento</h3>
                {% if em_andamento %}
                    {% for processo in em_andamento %}
                        {% if current_user.role == 'aluno' %}
                            {% include 'partials/_processo_card_aluno.html' %}
                        {% else %}
                            {% include 'partials/_processo_card_admin.html' %}
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">Nenhum processo em andamento.</div>
                {% endif %}
            </div>

            <div class="justice-content" id="finalizadosContent">
                <h3 class="justice-content-title">Processos Finalizados</h3>
                {% if finalizados %}
                    {% for processo in finalizados %}
                        {% if current_user.role == 'aluno' %}
                            {% include 'partials/_processo_card_aluno.html' %}
                        {% else %}
                            {% include 'partials/_processo_card_admin.html' %}
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">Nenhum processo finalizado.</div>
                {% endif %}
            </div>

            <div class="justice-content" id="newInfracaoContent">
                <div class="card border-danger shadow-sm">
                    <div class="card-header bg-danger text-white">
                        <h4 class="mb-0">Registrar Infra√ß√£o</h4>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('justica.registrar_em_massa') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="tipo_registro" value="infracao">

                            <div class="row">
                                <div class="col-md-5 mb-3 border-end">
                                    <label class="form-label fw-bold">1. Selecione a Turma</label>
                                    <select class="form-select mb-2" onchange="carregarAlunos(this.value, 'listaAlunosInfracao')">
                                        <option value="">-- Escolha --</option>
                                        {% for turma in turmas %}
                                        <option value="{{ turma.id }}">{{ turma.nome }}</option>
                                        {% endfor %}
                                    </select>
                                    
                                    <div class="d-flex justify-content-between mb-1">
                                        <small class="text-muted">Marque os alunos:</small>
                                        <a href="#" onclick="toggleTodos('listaAlunosInfracao'); atualizarTextoInteligente(); return false;" class="small text-danger">Marcar Todos</a>
                                    </div>
                                    
                                    <div id="listaAlunosInfracao" class="border rounded bg-light p-2" style="max-height: 400px; overflow-y: auto;">
                                        <div class="text-center text-muted small py-3">Selecione uma turma para carregar.</div>
                                    </div>
                                </div>

                                <div class="col-md-7 mb-3">
                                    <label class="form-label fw-bold">2. Detalhes da Infra√ß√£o</label>
                                    
                                    <div class="mb-3">
                                        <label class="small text-muted">Enquadramento (Regra)</label>
                                        <select id="regraSelect" name="regra_id" class="form-select" required onchange="atualizarTextoInteligente()">
                                            <option value="" data-desc="">-- Selecione a Infra√ß√£o --</option>
                                            {% for regra in fatos_predefinidos %}
                                            <option value="{{ regra.id }}" data-desc="no item {{ regra.codigo }} - '{{ regra.descricao }}'">
                                                {{ regra.codigo }} - {{ regra.descricao[:80] }}... 
                                                {% if permite_pontuacao %}({{ regra.pontos }} pts){% endif %}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="small text-muted">Data do Fato</label>
                                        <input type="date" name="data_fato" class="form-control" value="{{ hoje }}">
                                    </div>

                                    <div class="mb-3">
                                        <label class="small text-muted">Descri√ß√£o do Fato (Fato Constatado)</label>
                                        <textarea id="campoDescricao" name="descricao" class="form-control" rows="3" required placeholder="Descreva o fato constatado..."></textarea>
                                    </div>

                                    <div class="form-group mb-3">
                                        <label class="small text-muted">Termo de Justifica√ß√£o (Autom√°tico)</label>
                                        <textarea id="campoObservacao" name="observacao" class="form-control" rows="8" placeholder="O texto padr√£o aparecer√° aqui ao selecionar um aluno..."></textarea>
                                        <div class="form-text small">Se selecionar 1 aluno, preenche com os dados dele. Se selecionar v√°rios, usa dados gen√©ricos.</div>
                                    </div>

                                    <div class="text-end">
                                        <button type="submit" class="btn btn-danger btn-lg">
                                            <i class="fas fa-gavel me-1"></i> Registrar Infra√ß√£o
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="justice-content" id="newElogioContent">
                <div class="card border-success shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">Registrar Elogio</h4>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('justica.registrar_em_massa') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="tipo_registro" value="elogio">

                            <div class="row">
                                <div class="col-md-5 mb-3 border-end">
                                    <label class="form-label fw-bold">1. Selecione a Turma</label>
                                    <select class="form-select mb-2" onchange="carregarAlunos(this.value, 'listaAlunosElogio')">
                                        <option value="">-- Escolha --</option>
                                        {% for turma in turmas %}
                                        <option value="{{ turma.id }}">{{ turma.nome }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="d-flex justify-content-between mb-1">
                                        <small class="text-muted">Alunos:</small>
                                        <a href="#" onclick="toggleTodos('listaAlunosElogio'); return false;" class="small text-success">Marcar Todos</a>
                                    </div>
                                    <div id="listaAlunosElogio" class="border rounded bg-light p-2" style="max-height: 400px; overflow-y: auto;">
                                        <div class="text-center text-muted small py-3">Selecione uma turma.</div>
                                    </div>
                                </div>

                                <div class="col-md-7 mb-3">
                                    <label class="form-label fw-bold">2. Detalhes do Elogio</label>
                                    
                                    <div class="mb-3">
                                        <label class="small text-muted">Data</label>
                                        <input type="date" name="data_fato" class="form-control" value="{{ hoje }}">
                                    </div>

                                    <div class="mb-3">
                                        <label class="small text-muted">Motivo do Elogio</label>
                                        <textarea name="descricao" class="form-control" rows="5" required placeholder="Descreva o motivo do elogio..."></textarea>
                                    </div>

                                    {% if permite_pontuacao %}
                                    <div class="card bg-light border-success mb-3">
                                        <div class="card-body py-2">
                                            <small class="text-success fw-bold"><i class="fas fa-plus-circle"></i> Pontua√ß√£o FADA (+0.5 pts)</small>
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <select name="atributo_1" class="form-select form-select-sm">
                                                        <option value="">-- Atributo 1 --</option>
                                                        {% for id, nome in atributos_fada %}
                                                        <option value="{{ id }}">{{ id }}. {{ nome }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-6">
                                                    <select name="atributo_2" class="form-select form-select-sm">
                                                        <option value="">-- Atributo 2 --</option>
                                                        {% for id, nome in atributos_fada %}
                                                        <option value="{{ id }}">{{ id }}. {{ nome }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}

                                    <div class="text-end">
                                        <button type="submit" class="btn btn-success btn-lg">
                                            <i class="fas fa-star me-1"></i> Registrar Elogio
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="justice-sidebar">
        {% if (current_user.is_cal or current_user.role in ['admin_escola', 'programador', 'super_admin']) and permite_pontuacao %}
        <div class="d-grid gap-2">
            <a href="{{ url_for('justica.analise') }}" class="analysis-card mb-2">
                <div class="analysis-card-icon">üìä</div>
                <div class="analysis-card-text">
                    <h4>An√°lise FADA</h4>
                    <p>Estat√≠sticas gerais.</p>
                </div>
            </a>
            
            <a href="{{ url_for('regras.index') }}" class="analysis-card mb-2" style="background: linear-gradient(135deg, #6c757d, #495057);">
                <div class="analysis-card-icon">‚öôÔ∏è</div>
                <div class="analysis-card-text">
                    <h4>Configurar Regras</h4>
                    <p>Vincular infra√ß√µes.</p>
                </div>
            </a>
        </div>
        {% endif %}
    </div>
</div>

<style>
    .justice-page-layout { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    @media (min-width: 992px) { .justice-page-layout { grid-template-columns: 3fr 1fr; } }
    .analysis-card { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 1rem; border-radius: 8px; background: linear-gradient(135deg, #0d6efd, #0a58ca); color: white; text-decoration: none; transition: all 0.3s ease; min-height: 100px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .analysis-card:hover { transform: translateY(-3px); color: white; box-shadow: 0 6px 8px rgba(0,0,0,0.15); }
    .analysis-card-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
    .analysis-card-text h4 { font-size: 1rem; font-weight: 700; margin: 0; }
    .analysis-card-text p { font-size: 0.75rem; margin: 0; opacity: 0.9; }
    .justice-options { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem; }
    .justice-content { display: none; animation: fadeIn 0.3s; }
    .justice-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- L√≥gica das abas ---
    const optionBtns = document.querySelectorAll('.justice-option-btn');
    const contentDivs = document.querySelectorAll('.justice-content');
    
    optionBtns.forEach(btn => {
        if(btn.dataset.target) {
            btn.addEventListener('click', function() {
                optionBtns.forEach(b => { if(b.dataset.target) b.classList.remove('active'); });
                this.classList.add('active');
                contentDivs.forEach(div => div.classList.remove('active'));
                const target = document.getElementById(this.dataset.target);
                if(target) target.classList.add('active');
            });
        }
    });

    // --- CARREGAR ALUNOS DA TURMA ---
    window.carregarAlunos = function(turmaId, containerId) {
        const container = document.getElementById(containerId);
        if (!turmaId) {
            container.innerHTML = '<div class="text-center text-muted small py-3">Selecione uma turma.</div>';
            return;
        }
        
        container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-secondary"></div> Carregando...</div>';
        
        const url = "{{ url_for('justica.api_alunos_por_turma', turma_id=0) }}".replace('0', turmaId);

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    container.innerHTML = '<div class="alert alert-warning small m-2">Nenhum aluno nesta turma.</div>';
                    return;
                }
                let html = '';
                // Adiciona o evento onclick para atualizar o texto sempre que clicar num aluno
                data.forEach(a => {
                    html += `
                    <div class="form-check border-bottom py-1">
                        <input class="form-check-input aluno-check-${containerId}" type="checkbox" name="alunos_selecionados" value="${a.id}" id="${containerId}_${a.id}" onchange="atualizarTextoInteligente()">
                        <label class="form-check-label w-100" for="${containerId}_${a.id}" style="cursor:pointer; margin-left: 5px;">
                            <strong>${a.numero || '-'}</strong> - ${a.nome}
                        </label>
                    </div>`;
                });
                container.innerHTML = html;
            })
            .catch(err => {
                console.error(err);
                container.innerHTML = '<div class="text-danger small text-center">Erro ao carregar alunos.</div>';
            });
    };

    window.toggleTodos = function(containerId) {
        const checks = document.querySelectorAll(`.aluno-check-${containerId}`);
        const algumDesmarcado = Array.from(checks).some(c => !c.checked);
        checks.forEach(c => c.checked = algumDesmarcado);
        
        // Atualiza o texto se for na aba de infra√ß√£o
        if(containerId === 'listaAlunosInfracao') {
            atualizarTextoInteligente();
        }
    };

    // --- L√ìGICA DO TEXTO PADR√ÉO INTELIGENTE ---
    window.atualizarTextoInteligente = function() {
        const checks = document.querySelectorAll('.aluno-check-listaAlunosInfracao:checked');
        const regraSelect = document.getElementById('regraSelect');
        const selectedOption = regraSelect.options[regraSelect.selectedIndex];
        const regraDesc = selectedOption.getAttribute('data-desc') || "(Selecione a infra√ß√£o)";
        
        const observacaoBox = document.getElementById('campoObservacao');
        const hoje = new Date();
        const dataStr = hoje.toLocaleDateString('pt-BR', {day: 'numeric', month: 'long', year: 'numeric'});
        
        const autoridadeNome = "{{ current_user.nome_completo or 'AUTORIDADE' }}";
        const autoridadePosto = "{{ current_user.posto_graduacao or 'POSTO' }}";

        // Template Base
        let template = `Tendo em vista as informa√ß√µes constantes na Parte N¬∫ 000/CAl/EsFAS/${hoje.getFullYear()}, evidenciando a exist√™ncia, em tese, de infra√ß√£o das Normas de Procedimentos e Condutas do Corpo de Alunos e proporcionando assegurar o direito de defesa, formulo o seguinte termo de justifica√ß√£o:\n\n`;

        if (checks.length === 1) {
            // MODO INDIVIDUAL: Busca dados espec√≠ficos (como era antes)
            const alunoId = checks[0].value;
            const url = "{{ url_for('justica.api_get_aluno_details', aluno_id=0) }}".replace('0', alunoId);
            
            // Coloca um loading ou placeholder enquanto busca
            observacaoBox.value = "Carregando dados do aluno...";

            fetch(url)
                .then(r => r.json())
                .then(details => {
                    const nome = details.nome_completo || "NOME";
                    const posto = details.posto_graduacao || "POSTO";
                    const mat = details.matricula || "MAT";

                    template += `1. Justificante: ${posto} ${nome}, Id Func. ${mat}.\n\n`;
                    template += `2. Descri√ß√£o da conduta infracional: O(a) ${posto} ${nome}, Id Func. ${mat}, no dia ${dataStr}, ...\n`;
                    template += `Com isso, incorreu ${regraDesc}.\n\n`;
                    template += `3. Cientifico-lhe que a contar do recebimento da presente, abre-se o prazo de 24 horas, para que, querendo, apresente resposta escrita com as provas que entender cab√≠veis. Fica advertido o acusado que a n√£o entrega da justifica√ß√£o dentro do prazo estipulado, implicar√° em reconhecimento como verdadeiros os fatos imputados.\n\n\n`;
                    template += `${autoridadeNome}\n${autoridadePosto}`;
                    
                    observacaoBox.value = template;
                });

        } else if (checks.length > 1) {
            // MODO COLETIVO: Usa termos gen√©ricos
            template += `1. Justificante: Aluno(a) selecionado(a) na lista anexa.\n\n`;
            template += `2. Descri√ß√£o da conduta infracional: O(a) militar em quest√£o, no dia ${dataStr}, ...\n`;
            template += `Com isso, incorreu ${regraDesc}.\n\n`;
            template += `3. Cientifico-lhe que a contar do recebimento da presente, abre-se o prazo de 24 horas... (Texto padr√£o de defesa).\n\n\n`;
            template += `${autoridadeNome}\n${autoridadePosto}`;
            
            observacaoBox.value = template;
        
        } else {
            // NENHUM SELECIONADO
            observacaoBox.value = "Selecione pelo menos um aluno para gerar o termo.";
        }
    };
});
</script>
{% endblock %}