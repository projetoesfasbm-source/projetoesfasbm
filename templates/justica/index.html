{% extends "base.html" %}

{% block title %}Justiça e Disciplina{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="text-primary">Justiça e Disciplina</h1>
    <p class="text-secondary">Gerenciamento de processos disciplinares.</p>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        {% if current_user.role in ['admin_escola', 'programador', 'super_admin'] %}
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#novoProcessoModal">
            <i class="fas fa-plus me-1"></i> Novo Processo
        </button>
        {% endif %}
    </div>
    <div>
        {% if current_user.role in ['admin_escola', 'programador', 'super_admin'] %}
        <a href="{{ url_for('justica.analise') }}" class="btn btn-outline-primary">
            <i class="fas fa-chart-bar me-1"></i> Análise Gráfica
        </a>
        <a href="{{ url_for('justica.exportar_selecao') }}" class="btn btn-outline-secondary">
            <i class="fas fa-file-export me-1"></i> Exportar para BI
        </a>
        {% endif %}
    </div>
</div>

<ul class="nav nav-tabs mb-3" id="processosTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="andamento-tab" data-bs-toggle="tab" data-bs-target="#andamento" type="button" role="tab" aria-controls="andamento" aria-selected="true">
            Em Andamento <span class="badge bg-warning text-dark">{{ em_andamento | length }}</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="finalizados-tab" data-bs-toggle="tab" data-bs-target="#finalizados" type="button" role="tab" aria-controls="finalizados" aria-selected="false">
            Finalizados <span class="badge bg-light text-dark">{{ finalizados | length }}</span>
        </button>
    </li>
</ul>

<div class="tab-content" id="processosTabContent">
    <div class="tab-pane fade show active" id="andamento" role="tabpanel" aria-labelledby="andamento-tab">
        {% if em_andamento %}
            {% for processo in em_andamento %}
                {% if current_user.role in ['admin_escola', 'programador', 'super_admin'] %}
                    {% include 'partials/_processo_card_admin.html' %}
                {% elif current_user.role == 'aluno' %}
                    {% include 'partials/_processo_card_aluno.html' %}
                {% endif %}
            {% endfor %}
        {% else %}
            <div class="alert alert-info" role="alert">Nenhum processo em andamento.</div>
        {% endif %}
    </div>

    <div class="tab-pane fade" id="finalizados" role="tabpanel" aria-labelledby="finalizados-tab">
        {% if finalizados %}
            {% for processo in finalizados %}
                 {% if current_user.role in ['admin_escola', 'programador', 'super_admin'] %}
                    {% include 'partials/_processo_card_admin.html' %}
                {% elif current_user.role == 'aluno' %}
                    {% include 'partials/_processo_card_aluno.html' %}
                {% endif %}
            {% endfor %}
        {% else %}
            <div class="alert alert-info" role="alert">Nenhum processo finalizado.</div>
        {% endif %}
    </div>
</div>

{% if current_user.role in ['admin_escola', 'programador', 'super_admin'] %}
<div class="modal fade" id="novoProcessoModal" tabindex="-1" aria-labelledby="novoProcessoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="novoProcessoModalLabel">Registrar Novo Processo Disciplinar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('justica.novo_processo') }}" method="POST" id="novoProcessoForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="fato_pontos" id="fato_pontos" value="0.0">
                
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="aluno_id" class="form-label">Aluno</label>
                        <select class="form-select" id="aluno_id" name="aluno_id" required>
                            </select>
                    </div>

                    <div id="aluno-details" class="card p-2 mb-3" style="display: none;">
                        <small class="text-muted">Detalhes do Aluno:</small>
                        <div>
                            <span id="aluno-posto" class="badge bg-secondary"></span>
                            <strong id="aluno-nome"></strong>
                            (<span id="aluno-matricula"></span>)
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="fato_descricao" class="form-label">Fato Constatado</label>
                        <select class="form-select" id="fato_descricao" name="fato_descricao" required>
                            <option value="" data-pontos="0.0" selected disabled>Selecione um fato...</option>
                            
                            {% for rule in fatos_predefinidos %}
                                <option value="{{ rule.descricao }}" data-pontos="{{ rule.pontos }}">
                                    ({{ rule.codigo }}) {{ rule.descricao }}
                                    {% if g.active_school and g.active_school.npccal_type != 'cfs' %}
                                     - [{{ rule.pontos }} pts]
                                    {% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacao" class="form-label">Observações (Opcional)</label>
                        <textarea class="form-control" id="observacao" name="observacao" rows="3" placeholder="Detalhes adicionais, como local, data/hora da ocorrência, etc."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Registrar e Notificar Aluno</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Inicializa o Select2 para Alunos
    $('#aluno_id').select2({
        dropdownParent: $('#novoProcessoModal'),
        theme: "bootstrap-5",
        placeholder: 'Digite a matrícula ou nome do aluno...',
        minimumInputLength: 2,
        ajax: {
            url: "{{ url_for('justica.api_get_alunos') }}",
            dataType: 'json',
            delay: 250,
            data: function (params) { return { q: params.term }; },
            processResults: function (data) { return { results: data }; },
            cache: true
        }
    });

    // Atualiza os detalhes do aluno quando selecionado
    $('#aluno_id').on('select2:select', function (e) {
        var alunoId = e.params.data.id;
        // Substitui o '0' na URL gerada pelo Flask pelo ID real
        var url = "{{ url_for('justica.api_get_aluno_details', aluno_id=0) }}".replace('/0', '/' + alunoId);
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    $('#aluno-posto').text(data.posto_graduacao);
                    $('#aluno-nome').text(data.nome_completo);
                    $('#aluno-matricula').text(data.matricula);
                    $('#aluno-details').show();
                }
            });
    });

    // Limpa o modal ao fechar
    $('#novoProcessoModal').on('hidden.bs.modal', function () {
        $('#aluno_id').val(null).trigger('change');
        $('#aluno-details').hide();
        $(this).find('form')[0].reset();
        $('#fato_descricao').val(null).trigger('change');
        $('#fato_pontos').val('0.0'); // Reseta os pontos também
    });

    // Inicializa Select2 para os Fatos (permite busca textual)
    $('#fato_descricao').select2({
        dropdownParent: $('#novoProcessoModal'),
        theme: "bootstrap-5",
        placeholder: 'Pesquise o fato...'
    });

    // Atualiza o campo oculto de pontos quando um fato é selecionado
    $('#fato_descricao').on('change', function() {
        var selectedOption = $(this).find('option:selected');
        var pontos = selectedOption.data('pontos') || 0.0;
        $('#fato_pontos').val(pontos);
    });
});
</script>
{% endblock %}