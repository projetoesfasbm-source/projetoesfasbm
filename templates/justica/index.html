{% extends "base.html" %}

{% block title %}Justi√ßa e Disciplina{% endblock %}

{% block content %}
<div class="content-header">
    <h1>Justi√ßa e Disciplina</h1>
    <p>Acompanhamento de processos disciplinares.</p>
</div>

<div class="justice-page-layout">
    <div class="justice-main-content">
        <div class="justice-container">
            <div class="justice-options">
                <button class="btn btn-primary justice-option-btn active" data-target="inProgressContent">Em Andamento</button>
                <button class="btn btn-warning justice-option-btn" data-target="finalizadosContent">Finalizados</button>
                
                {% if current_user.role in ['admin_escola', 'programador', 'super_admin'] %}
                    <button class="btn btn-success justice-option-btn" data-target="newTransgressionContent">Nova Infra√ß√£o</button>
                    
                    <a href="{{ url_for('justica.fada_lista_alunos') }}" class="btn btn-info">Avalia√ß√£o FADA</a>
                {% endif %}
                
                {% if current_user.role in ['admin_escola', 'programador', 'super_admin'] and permite_pontuacao %}
                <a href="{{ url_for('justica.exportar_selecao') }}" class="btn btn-info">Exportar para BI</a>
                {% endif %}
                
                </div>

            <div class="justice-content active" id="inProgressContent">
                <h3 class="justice-content-title">Processos em Andamento</h3>
                {% if em_andamento %}
                    {% for processo in em_andamento %}
                        {% if current_user.role == 'aluno' %}
                            {% include 'partials/_processo_card_aluno.html' %}
                        {% else %}
                            {% include 'partials/_processo_card_admin.html' %}
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">Nenhum processo em andamento encontrado.</div>
                {% endif %}
            </div>
            
            <div class="justice-content" id="finalizadosContent">
                <h3 class="justice-content-title">Processos Finalizados</h3>
                {% if finalizados %}
                    {% for processo in finalizados %}
                        {% if current_user.role == 'aluno' %}
                            {% include 'partials/_processo_card_aluno.html' %}
                        {% else %}
                            {% include 'partials/_processo_card_admin.html' %}
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">Nenhum processo finalizado encontrado.</div>
                {% endif %}
            </div>

            {% if current_user.role in ['admin_escola', 'programador', 'super_admin'] %}
            <div class="justice-content" id="newTransgressionContent">
                <h3 class="justice-content-title">Registrar Nova Infra√ß√£o</h3>
                <form method="POST" action="{{ url_for('justica.novo_processo') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="fato_pontos" id="fato_pontos" value="0.0">

                    <div class="form-group">
                        <label for="aluno_search_input">Aluno</label>
                        <div class="search-form-container">
                            <div class="input-group">
                                <input type="search" id="aluno_search_input" class="form-control" placeholder="Buscar por nome ou matr√≠cula..." autocomplete="off">
                            </div>
                        </div>
                        <div id="aluno_results" class="search-results"></div>
                        <input type="hidden" name="aluno_id" id="aluno_id_hidden" required>
                        <div id="aluno_selected" class="selected-item-display" style="display: none;"></div>
                    </div>
                    
                    <div id="transgression_fields" style="display: none;">
                        
                        {% if fatos_predefinidos %}
                        <div class="form-group">
                            <label for="fato_search_input">Fato Constatado</label>
                            <input type="text" id="fato_search_input" class="form-control mb-2" placeholder="Pesquisar na lista de infra√ß√µes...">
                            
                            <div class="facts-list-container" id="facts-list-container">
                                {% for rule in fatos_predefinidos %}
                                    <div class="result-item" 
                                         data-fato="({{ rule.codigo }}) {{ rule.descricao }}"
                                         data-pontos="{{ rule.pontos if permite_pontuacao else '0.0' }}">
                                        
                                        <strong>{{ rule.codigo }}</strong> - {{ rule.descricao }}
                                        
                                        {% if permite_pontuacao %}
                                            <span class="badge bg-danger float-end">{{ rule.pontos }} pts</span>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                            <input type="hidden" id="fato_hidden_input" name="fato_descricao" required>
                        </div>
                        
                        {% else %}
                        <div class="form-group">
                            <label for="fato_descricao_manual">Fato Constatado (Registro Manual)</label>
                            <p class="form-text">Nenhuma infra√ß√£o pr√©-definida encontrada para esta escola. Registre o fato manualmente.</p>
                            <textarea id="fato_descricao_manual" name="fato_descricao" class="form-control" rows="3" placeholder="Descreva o fato constatado..." required></textarea>
                        </div>
                        {% endif %}
                        
                        <div class="form-group">
                            <label for="observacao">Observa√ß√£o (Termo de Justifica√ß√£o)</label>
                            <textarea id="observacao" name="observacao" class="form-control" rows="12"></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Registrar</button>
                        </div>
                    </div>
                </form>
            </div>
            {% endif %}

        </div>
    </div>

    <div class="justice-sidebar">
        {% if current_user.role in ['admin_escola', 'programador', 'super_admin'] and permite_pontuacao %}
        <a href="{{ url_for('justica.analise') }}" class="analysis-card">
            <div class="analysis-card-icon">üìä</div>
            <div class="analysis-card-text">
                <h4>An√°lise de Dados</h4>
                <p>Gr√°ficos e estat√≠sticas sobre as infra√ß√µes.</p>
            </div>
        </a>
        {% endif %}
    </div>
</div>

<style>
    /* Estilos CSS permanecem os mesmos */
    .justice-page-layout { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    @media (min-width: 992px) { .justice-page-layout { grid-template-columns: 3fr 1fr; } }
    .analysis-card { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 1.5rem; border-radius: var(--border-radius); background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light)); color: white; text-decoration: none; transition: all 0.3s ease; border: 2px solid transparent; min-height: 150px; box-shadow: var(--shadow-soft); }
    .analysis-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-medium); border-color: rgba(255, 255, 255, 0.5); }
    .analysis-card-icon { font-size: 2.5rem; line-height: 1; margin-bottom: 0.75rem; }
    .analysis-card-text h4 { font-size: 1.2rem; font-weight: 700; margin: 0 0 0.25rem 0; }
    .analysis-card-text p { font-size: 0.8rem; opacity: 0.8; margin: 0; }

    .facts-list-container { max-height: 250px; overflow-y: auto; border: 1px solid #ccc; border-radius: 8px; background: #f8fafc; padding: 0.5rem; }
    .result-item { padding: 10px; cursor: pointer; border-radius: 4px; }
    .result-item:hover { background-color: #e2e8f0; }
    .result-item.selected { background-color: var(--color-primary); color: white; }
    .result-item.selected .badge { background-color: white !important; color: var(--color-primary) !important; }

    .justice-options { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem; align-items: center; }
    .justice-option-btn.active { filter: brightness(1.1); box-shadow: inset 0 2px 4px rgba(0,0,0,0.15); transform: translateY(1px); }
    .justice-content { display: none; }
    .justice-content.active { display: block; }
    .justice-content-title { margin-bottom: 1.5rem; }
    
    .search-form-container { position: relative; }
    .search-results { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; border-radius: 0 0 8px 8px; background: white; position: absolute; width: 100%; z-index: 10; display: none; }
    .selected-item-display { background-color: #e9ecef; padding: 10px; border-radius: 4px; margin-top: 5px; display: flex; justify-content: space-between; align-items: center; }
    .remove-selected-btn { cursor: pointer; color: red; font-weight: bold; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- L√≥gica das abas (MANTIDA) ---
    const optionBtns = document.querySelectorAll('.justice-option-btn');
    const contentDivs = document.querySelectorAll('.justice-content');
    optionBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            optionBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            contentDivs.forEach(div => div.classList.remove('active'));
            const targetElement = document.getElementById(this.dataset.target);
            if (targetElement) {
                targetElement.classList.add('active');
            }
        });
    });

    // --- Elementos do Formul√°rio (MANTIDOS) ---
    const alunoSearchInput = document.getElementById('aluno_search_input');
    const alunoResults = document.getElementById('aluno_results');
    const alunoHiddenInput = document.getElementById('aluno_id_hidden');
    const alunoSelectedDisplay = document.getElementById('aluno_selected');
    const transgressionFields = document.getElementById('transgression_fields');
    const observacaoTextarea = document.getElementById('observacao');
    
    let observacaoTemplateOriginal = '';

    // --- Busca de Aluno (MANTIDA) ---
    if (alunoSearchInput) {
        let searchTimeout;
        alunoSearchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value;
            
            alunoHiddenInput.value = '';
            transgressionFields.style.display = 'none';

            if (query.length < 2) {
                alunoResults.style.display = 'none';
                return;
            }
            searchTimeout = setTimeout(() => {
                fetch(`{{ url_for('justica.api_get_alunos') }}?q=${query}`)
                    .then(response => response.json())
                    .then(data => {
                        alunoResults.innerHTML = '';
                        if (data.length > 0) {
                            data.forEach(aluno => {
                                const item = document.createElement('div');
                                item.className = 'result-item';
                                item.textContent = aluno.text;
                                item.dataset.id = aluno.id;
                                item.addEventListener('click', function() {
                                    selectAluno(this.dataset.id, this.textContent);
                                });
                                alunoResults.appendChild(item);
                            });
                            alunoResults.style.display = 'block';
                        } else {
                            alunoResults.style.display = 'none';
                        }
                    });
            }, 300);
        });

        function selectAluno(alunoId, alunoText) {
            alunoSearchInput.style.display = 'none';
            alunoSelectedDisplay.innerHTML = `<span>${alunoText}</span><span class="remove-selected-btn" title="Remover sele√ß√£o"> &times;</span>`;
            alunoSelectedDisplay.style.display = 'flex';
            alunoHiddenInput.value = alunoId;
            alunoResults.style.display = 'none';

            const url = "{{ url_for('justica.api_get_aluno_details', aluno_id=0) }}".replace('/0', '/' + alunoId);

            fetch(url)
                .then(response => response.json())
                .then(details => {
                    const hoje = new Date();
                    const dia = hoje.getDate();
                    const mes = hoje.toLocaleString('pt-BR', { month: 'long' });
                    const ano = hoje.getFullYear();
                    const autoridadeNome = "{{ current_user.nome_completo or 'NOME DA AUTORIDADE' }}";
                    const autoridadePosto = "{{ current_user.posto_graduacao or 'POSTO DA AUTORIDADE' }}";

                    observacaoTemplateOriginal = `Tendo em vista as informa√ß√µes constantes na Parte N¬∫ 000/CAl/EsFAS/${ano}, evidenciando a exist√™ncia, em tese, de infra√ß√£o das Normas de Procedimentos e Condutas do Corpo de Alunos e proporcionando assegurar o direito de defesa, formulo o seguinte termo de justifica√ß√£o:\n\n1. Justificante: ${details.posto_graduacao} ${details.nome_completo}, Id Func. ${details.matricula}.\n\n2. Descri√ß√£o da conduta infracional: O(a) ${details.posto_graduacao} ${details.nome_completo}, Id Func. ${details.matricula}, no dia ${dia} de ${mes} de ${ano}, ...... \nCom isso, incorreu no item...\n\n3. Cientifico-lhe que a contar do recebimento da presente, abre-se o prazo de 24 horas, para que, querendo, apresente resposta escrita com as provas que entender cab√≠veis. Fica advertido o acusado que a n√£o entrega da justifica√ß√£o dentro do prazo estipulado, implicar√° em reconhecimento como verdadeiros os fatos imputados.\n\n\n${autoridadeNome}\n${autoridadePosto}`;
                    observacaoTextarea.value = observacaoTemplateOriginal;
                    transgressionFields.style.display = 'block';

                    // Esta l√≥gica agora est√° correta.
                    // Ela vai limpar a sele√ß√£o de infra√ß√£o para AMBOS os casos,
                    // for√ßando o usu√°rio a selecionar uma (seja CTSP ou CSPM).
                    
                    // Limpa o item 'incorreu...'
                    updateObservacaoComFato(null); 
                    
                    // Garante que os pontos estejam zerados at√© a sele√ß√£o
                    document.getElementById('fato_pontos').value = '0.0';

                    // Reseta a sele√ß√£o visual da lista (se ela existir)
                    const fatoHiddenInput = document.getElementById('fato_hidden_input');
                    if (fatoHiddenInput) {
                        fatoHiddenInput.value = '';
                        const fatoItems = document.querySelectorAll('.facts-list-container .result-item');
                        fatoItems.forEach(i => i.classList.remove('selected'));
                    }
                });
        }

        alunoSelectedDisplay.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-selected-btn')) {
                alunoSearchInput.style.display = 'block';
                alunoSearchInput.value = '';
                alunoSelectedDisplay.style.display = 'none';
                alunoHiddenInput.value = '';
                transgressionFields.style.display = 'none';
                observacaoTextarea.value = '';
                observacaoTemplateOriginal = '';
                alunoSearchInput.focus();
            }
        });

        document.addEventListener('click', function(e) {
            if (!alunoSearchInput.contains(e.target) && !alunoResults.contains(e.target)) {
                alunoResults.style.display = 'none';
            }
        });
    }

    // --- L√≥gica do Fato Constatado (Seletor) ---
    // Esta l√≥gica agora funciona tanto para CTSP quanto para CSPM/CBFPM,
    // desde que 'fatos_predefinidos' exista.
    const fatoSearchInput = document.getElementById('fato_search_input');
    
    if (fatoSearchInput) { 
        const fatoListContainer = document.getElementById('facts-list-container');
        const fatoHiddenInput = document.getElementById('fato_hidden_input');
        const fatoPontosInput = document.getElementById('fato_pontos'); 
        const fatoItems = fatoListContainer.querySelectorAll('.result-item');

        fatoSearchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            fatoItems.forEach(item => {
                const fatoText = item.innerText.toLowerCase();
                item.style.display = fatoText.includes(query) ? 'block' : 'none';
            });
        });

        fatoItems.forEach(item => {
            item.addEventListener('click', function() {
                fatoItems.forEach(i => i.classList.remove('selected'));
                this.classList.add('selected');
                
                const fatoText = this.dataset.fato;
                // Pega os pontos do 'data-pontos' (que ser√° 0.0 para CTSP)
                const pontos = this.dataset.pontos || 0.0;
                
                fatoHiddenInput.value = fatoText;
                fatoPontosInput.value = pontos; 

                updateObservacaoComFato(fatoText);
            });
        });
    }

    // Fun√ß√£o 'updateObservacao' (MANTIDA)
    // Esta fun√ß√£o j√° lidava bem com 'fatoText' nulo ou preenchido.
    function updateObservacaoComFato(fatoText) {
        let textoObservacao = observacaoTemplateOriginal;

        if (fatoText) {
            // Se um fato foi selecionado, preenche o "incorreu no item..."
            const regex = /^\(([^)]+)\)\s*(.*)$/;
            const match = fatoText.match(regex);
            let fatoDetalhes = fatoText;

            if (match) {
                const codigo = match[1];
                const descricao = match[2].trim();
                fatoDetalhes = `no item ${codigo} - "${descricao}"`;
            }
            textoObservacao = textoObservacao.replace(/no item\.\.\./, `${fatoDetalhes};`);
        } else {
            // Se nenhum fato selecionado (ou se for CTSP no in√≠cio), remove a linha do item
            textoObservacao = textoObservacao.replace(/\nCom isso, incorreu no item\.\.\./, '');
        }
        
        observacaoTextarea.value = textoObservacao;
    }
    
    // --- L√≥gica de Toggle do Formul√°rio "Analisar" (MANTIDA) ---
    const botoesToggleForm = document.querySelectorAll('.js-toggle-analise-form');
    botoesToggleForm.forEach(function(botao) {
        botao.addEventListener('click', function(event) {
            event.preventDefault();
            const targetFormId = this.dataset.targetForm;
            const formElement = document.querySelector(targetFormId);
            const botaoPrincipal = this.closest('.card-body').querySelector('.btn-group .js-toggle-analise-form');
            const textoBotao = botaoPrincipal ? botaoPrincipal.querySelector('.js-toggle-text') : null;

            if (formElement) {
                if (formElement.style.display === 'none' || formElement.style.display === '') {
                    formElement.style.display = 'block';
                    if (textoBotao) textoBotao.textContent = 'Fechar';
                } else {
                    formElement.style.display = 'none';
                    if (textoBotao) textoBotao.textContent = 'Analisar';
                }
            }
        });
    });

});
</script>
{% endblock %}