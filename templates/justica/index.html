{% extends "base.html" %}

{% block title %}Justiça e Disciplina{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

{% set school_type = 'ctsp' %}
{% if g.active_school and g.active_school.npccal_type %}
    {% set school_type = g.active_school.npccal_type|lower %}
{% endif %}
{% set show_fada = (school_type in ['cbfpm', 'cspm']) %}

<div class="content-header">
    <h1>Justiça e Disciplina</h1>
    <p>Gestão de processos disciplinares e avaliação atitudinal.</p>
</div>

<div class="justice-page-layout">
    <div class="justice-main-content">
        <div class="justice-container">

            <div class="justice-options">
                <button class="btn btn-primary justice-option-btn active" data-target="inProgressContent">Em Andamento</button>
                <button class="btn btn-warning justice-option-btn" data-target="finalizadosContent">Finalizados</button>

                {% if current_user.role != 'aluno' %}
                    <button class="btn btn-danger justice-option-btn" data-target="newInfracaoContent">
                        <i class="fas fa-exclamation-triangle me-1"></i>Nova Infração
                    </button>
                    <button class="btn btn-success justice-option-btn" data-target="newElogioContent">
                        <i class="fas fa-star me-1"></i>Novo Elogio
                    </button>

                    {% if show_fada %}
                    <a href="{{ url_for('justica.fada_boletim') }}" class="btn btn-info text-white justice-option-btn">
                        <i class="fas fa-clipboard-list me-1"></i> Boletim / Avaliar (FADA)
                    </a>
                    {% endif %}
                {% endif %}
            </div>

            <div class="justice-content active" id="inProgressContent">
                <h3 class="justice-content-title">Processos em Andamento</h3>
                {% if em_andamento %}
                    {% for processo in em_andamento %}
                        {% include 'partials/_processo_card_admin.html' if current_user.role != 'aluno' else 'partials/_processo_card_aluno.html' %}
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">Nenhum processo em andamento.</div>
                {% endif %}
            </div>

            <div class="justice-content" id="finalizadosContent">
                <div class="d-flex justify-content-end mb-3">
                    {% if current_user.role != 'aluno' %}
                        <a href="{{ url_for('justica.exportar_selecao') }}" class="btn btn-sm btn-outline-dark">
                            <i class="fas fa-file-export"></i> Exportar Termos
                        </a>
                    {% endif %}
                </div>

                {% if finalizados %}
                    {% for processo in finalizados %}
                        {% include 'partials/_processo_card_admin.html' if current_user.role != 'aluno' else 'partials/_processo_card_aluno.html' %}
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">Nenhum processo finalizado.</div>
                {% endif %}
            </div>

            <div class="justice-content" id="newInfracaoContent">
                <div class="card border-danger shadow-sm">
                    <div class="card-header bg-danger text-white"><h4 class="mb-0">Registrar Infração</h4></div>
                    <div class="card-body">
                         <form method="POST" action="{{ url_for('justica.registrar_em_massa') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="tipo_registro" value="infracao">

                            <input type="hidden" name="origem_punicao" id="hidden_origem_punicao" value="NPCCAL">
                            <input type="hidden" name="is_crime" id="hidden_is_crime" value="false">

                             <div class="row">
                                <div class="col-md-5 mb-3 border-end">
                                    <label class="form-label fw-bold">1. Turma</label>
                                    <select class="form-select mb-2" onchange="carregarAlunos(this.value, 'listaAlunosInfracao')">
                                        <option value="">-- Escolha --</option>
                                        {% for turma in turmas %}
                                        <option value="{{ turma.id }}">{{ turma.nome }}</option>
                                        {% endfor %}
                                    </select>
                                    <a href="#" onclick="toggleTodos('listaAlunosInfracao'); return false;" class="small text-danger">Marcar Todos</a>
                                    <div id="listaAlunosInfracao" class="border rounded bg-light p-2" style="max-height: 350px; overflow-y: auto;">
                                        <div class="text-center text-muted small py-3">Selecione uma turma.</div>
                                    </div>
                                </div>
                                <div class="col-md-7 mb-3">
                                    <label class="form-label fw-bold">2. Detalhes</label>

                                    <div class="mb-3 p-2 border rounded bg-white">
                                        <label class="small fw-bold d-block mb-1">Tipo de Enquadramento</label>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="tipo_visual" id="rad_npccal" value="NPCCAL" checked onchange="toggleTiposInfracao()">
                                            <label class="form-check-label small" for="rad_npccal">Falta NPCCAL</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="tipo_visual" id="rad_rdbm" value="RDBM" onchange="toggleTiposInfracao()">
                                            <label class="form-check-label small text-warning fw-bold" for="rad_rdbm">Transgressão RDBM</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="tipo_visual" id="rad_crime" value="CRIME" onchange="toggleTiposInfracao()">
                                            <label class="form-check-label small text-danger fw-bold" for="rad_crime">Crime Militar/Comum</label>
                                        </div>
                                    </div>

                                    <div class="mb-2" id="box_regras_npccal">
                                        <label class="small">Pesquisar Falta (Código ou Descrição)</label>
                                        <select id="regraSelect" name="regra_id" class="form-select" onchange="atualizarTextoInteligente()" placeholder="Digite para pesquisar a regra...">
                                            <option value="">-- Selecione a Falta --</option>
                                            {% for regra in fatos_predefinidos %}
                                            <option value="{{ regra.id }}" data-desc="no item {{ regra.codigo }} '{{ regra.descricao }}'">{{ regra.codigo }} - {{ regra.descricao }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="mb-2" id="box_regras_manual" style="display: none;">
                                        <label class="small">Descrição da Transgressão / Crime</label>
                                        <input type="text" id="inputManualDesc" name="codigo_infracao" class="form-control" placeholder="Ex: Art. 15 do RDBM ou Art. 290 do CPM..." oninput="atualizarTextoInteligente()">
                                    </div>

                                    <div class="row mb-2">
                                        <div class="col-md-7">
                                            <label class="small">Data do Fato</label>
                                            <input type="date" name="data_fato" id="dataFatoInput" class="form-control" value="{{ hoje }}" onchange="atualizarTextoInteligente()">
                                        </div>
                                        <div class="col-md-5">
                                            <label class="small">Hora</label>
                                            <input type="time" name="hora_fato" class="form-control" value="{{ agora_hora or '12:00' }}">
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <label class="small">Fato Constatado (Descrição detalhada da conduta)</label>
                                        <textarea name="descricao" id="descricaoFatoInput" class="form-control" rows="2" placeholder="Ex: deixou a parte de cima do seu armário fora dos padrões exigidos." required oninput="atualizarTextoInteligente()"></textarea>
                                    </div>
                                    <div class="mb-2">
                                        <label class="small">Termo de Justificação (Gerado Automaticamente)</label>
                                        <textarea id="campoObservacao" name="observacao" class="form-control" rows="15"></textarea>
                                    </div>
                                    <div class="text-end"><button type="submit" class="btn btn-danger">Registrar</button></div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="justice-content" id="newElogioContent">
                <div class="card border-success shadow-sm">
                    <div class="card-header bg-success text-white"><h4 class="mb-0">Registrar Elogio</h4></div>
                    <div class="card-body">
                         <form method="POST" action="{{ url_for('justica.registrar_em_massa') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="tipo_registro" value="elogio">
                            <div class="row">
                                <div class="col-md-5 border-end">
                                    <label class="form-label">Turma</label>
                                    <select class="form-select mb-2" onchange="carregarAlunos(this.value, 'listaAlunosElogio')">
                                        <option value="">-- Escolha --</option>
                                        {% for turma in turmas %}
                                        <option value="{{ turma.id }}">{{ turma.nome }}</option>
                                        {% endfor %}
                                    </select>
                                    <div id="listaAlunosElogio" class="border rounded p-2" style="max-height:300px; overflow-y:auto;"></div>
                                </div>
                                <div class="col-md-7">
                                    <label class="form-label">Motivo</label>
                                    <textarea name="descricao" class="form-control" rows="5" required></textarea>
                                    <div class="text-end mt-3"><button type="submit" class="btn btn-success">Registrar Elogio</button></div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    .justice-page-layout { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    @media (min-width: 992px) { .justice-page-layout { grid-template-columns: 3fr 1fr; } }
    .justice-options { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .justice-content { display: none; }
    .justice-content.active { display: block; }
    /* Ajuste para o Tom Select não ficar cortado */
    .ts-control { min-height: 38px; border-radius: 0.375rem; }
</style>

<div class="modal fade" id="modalAnalise" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formAnaliseProcesso" method="POST" action="">
          <div class="modal-header">
            <h5 class="modal-title">Analisar Processo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p><strong>Aluno:</strong> <span id="modalAlunoNome"></span></p>
            <p><strong>Fato:</strong> <span id="modalFatoDesc" class="text-muted fst-italic"></span></p>
            <hr>
            <div class="mb-3">
                <label class="form-label">Decisão</label>
                <select name="decisao" class="form-select" required onchange="togglePontos(this.value)">
                    <option value="">-- Selecione --</option>
                    <option value="justificar">Justificar (Sem punição)</option>
                    <option value="punir">Punir (Com perda de pontos)</option>
                    <option value="absolver">Absolver (Arquivar)</option>
                </select>
            </div>
            <div class="mb-3" id="divPontos" style="display:none;">
                <label class="form-label">Pontos Perdidos</label>
                <input type="number" step="0.1" name="pontos_finais" class="form-control">
            </div>
            <div class="mb-3">
                <label class="form-label">Observação da Decisão</label>
                <textarea name="observacao_decisao" class="form-control" rows="3"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Salvar Decisão</button>
          </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- INICIALIZAÇÃO DO BUSCADOR (Tom Select) ---
    var controlRegra = new TomSelect("#regraSelect", {
        create: false,
        sortField: { field: "text", direction: "asc" },
        allowEmptyOption: true,
        maxOptions: 1000
    });

    // --- LÓGICA DAS ABAS (TABS) ---
    document.querySelectorAll('.justice-option-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            if(this.tagName.toLowerCase() === 'a') return;
            document.querySelectorAll('.justice-option-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.justice-content').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            const target = document.getElementById(this.dataset.target);
            if(target) target.classList.add('active');
        });
    });

    // --- LÓGICA CORRETA PARA EXPANDIR O FORMULÁRIO DE ANÁLISE (INLINE) ---
    document.body.addEventListener('click', function(event) {
        const btn = event.target.closest('.js-toggle-analise-form');
        if (btn) {
            const targetId = btn.getAttribute('data-target-form');
            const formContainer = document.querySelector(targetId);
            if (formContainer) {
                if (formContainer.style.display === 'none' || formContainer.style.display === '') {
                    formContainer.style.display = 'block';
                    btn.querySelector('.js-toggle-text').textContent = 'Ocultar';
                    btn.classList.replace('btn-success', 'btn-secondary');
                } else {
                    formContainer.style.display = 'none';
                    btn.querySelector('.js-toggle-text').textContent = 'Analisar';
                    btn.classList.replace('btn-secondary', 'btn-success');
                }
            }
        }
    });

    window.togglePontos = function(val) {
        document.getElementById('divPontos').style.display = (val === 'punir') ? 'block' : 'none';
    };

    window.toggleTiposInfracao = function() {
        const isNPCCAL = document.getElementById('rad_npccal').checked;
        const isRDBM = document.getElementById('rad_rdbm').checked;
        const isCrime = document.getElementById('rad_crime').checked;
        const boxRegras = document.getElementById('box_regras_npccal');
        const boxManual = document.getElementById('box_regras_manual');
        const selectRegra = document.getElementById('regraSelect');
        const inputManual = document.getElementById('inputManualDesc');
        const hiddenOrigem = document.getElementById('hidden_origem_punicao');
        const hiddenCrime = document.getElementById('hidden_is_crime');

        if (isNPCCAL) {
            boxRegras.style.display = 'block';
            boxManual.style.display = 'none';
            // Para Tom Select, habilitar o elemento original
            if (controlRegra) controlRegra.enable();
            inputManual.removeAttribute('required');
            inputManual.value = '';
            hiddenOrigem.value = 'NPCCAL';
            hiddenCrime.value = 'false';
        } else {
            boxRegras.style.display = 'none';
            boxManual.style.display = 'block';
            if (controlRegra) {
                controlRegra.clear();
                controlRegra.disable();
            }
            inputManual.setAttribute('required', 'required');
            if (isRDBM) { hiddenOrigem.value = 'RDBM'; hiddenCrime.value = 'false'; }
            else { hiddenOrigem.value = 'NPCCAL'; hiddenCrime.value = 'true'; }
        }
        atualizarTextoInteligente();
    };

    window.carregarAlunos = function(turmaId, containerId) {
        const container = document.getElementById(containerId);
        if(!turmaId) return;
        container.innerHTML = 'Carregando...';
        fetch(`/justica-e-disciplina/api/alunos-por-turma/${turmaId}`)
            .then(r => r.json())
            .then(data => {
                if (container.tagName === 'SELECT') {
                    let html = '<option value="">-- Selecione o Aluno --</option>';
                    data.forEach(a => {
                        html += `<option value="${a.id}">${a.numero ? a.numero + ' - ' : ''}${a.graduacao} ${a.nome}</option>`;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = data.map(a => `
                        <div class="form-check border-bottom py-1">
                            <input class="form-check-input aluno-check-${containerId}" type="checkbox" name="alunos_selecionados" value="${a.id}" id="chk_${containerId}_${a.id}" onchange="if('${containerId}'=='listaAlunosInfracao') atualizarTextoInteligente()">
                            <label class="form-check-label" for="chk_${containerId}_${a.id}">
                                ${a.numero ? a.numero + ' - ' : ''}${a.nome}
                            </label>
                        </div>
                    `).join('');
                }
            });
    };

    window.toggleTodos = function(cId) {
        const checks = document.querySelectorAll(`.aluno-check-${cId}`);
        const status = Array.from(checks).some(c => !c.checked);
        checks.forEach(c => c.checked = status);
        if(cId === 'listaAlunosInfracao') atualizarTextoInteligente();
    };

    function getDataPorExtenso(dateString) {
        if (!dateString) return "data não informada";
        const parts = dateString.split('-');
        if (parts.length !== 3) return dateString;
        const meses = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
        const dia = parts[2];
        const mes = meses[parseInt(parts[1]) - 1];
        const ano = parts[0];
        return `${dia} de ${mes} de ${ano}`;
    }

    window.atualizarTextoInteligente = function() {
        const checks = document.querySelectorAll('.aluno-check-listaAlunosInfracao:checked');
        const regSel = document.getElementById('regraSelect');
        const isNPCCAL = document.getElementById('rad_npccal').checked;
        const isRDBM = document.getElementById('rad_rdbm').checked;
        const isCrime = document.getElementById('rad_crime').checked;

        let regraDesc = "";
        if (isNPCCAL) {
            if (regSel.selectedIndex >= 0) {
                 regraDesc = regSel.options[regSel.selectedIndex].getAttribute('data-desc') || "";
            }
        } else {
            const manualText = document.getElementById('inputManualDesc').value.trim();
            if (manualText) {
                if (isRDBM) regraDesc = "em transgressão disciplinar: " + manualText;
                if (isCrime) regraDesc = "em fato tipificado como crime: " + manualText;
            } else {
                regraDesc = isRDBM ? "em transgressão disciplinar (descrever)" : "em crime (descrever)";
            }
        }

        const box = document.getElementById('campoObservacao');
        let descFato = document.getElementById('descricaoFatoInput').value.trim();
        if (!descFato) descFato = "[DESCREVER A CONDUTA AQUI]";
        if (descFato.endsWith('.')) descFato = descFato.slice(0, -1);

        const dataInput = document.getElementById('dataFatoInput').value;
        const dataExtenso = getDataPorExtenso(dataInput);
        const anoAtual = new Date().getFullYear();

        if(checks.length === 1) {
            box.value = "Carregando dados...";
            fetch(`/justica-e-disciplina/api/aluno-details/${checks[0].value}`)
                .then(r => r.json())
                .then(d => {
                    const idFunc = `Id Func. ${d.matricula}`;
                    const nomeCompleto = `${d.posto_graduacao} ${d.nome_completo}, ${idFunc}`;
                    const termo = `Termo de Justificação:\nTendo em vista as informações constantes na Parte Nº ___/___Pel/CAl/EsFAS/${anoAtual}, evidenciando a existência, em tese, de infração das Normas de Procedimentos e Condutas do Corpo de Alunos e proporcionando assegurar o direito de defesa, formulo o seguinte termo de justificação:\n\n1. Justificante: ${nomeCompleto}.\n\n2. Descrição da conduta infracional: O ${nomeCompleto}, no dia ${dataExtenso}, ${descFato}. Com isso, incorreu ${regraDesc}.\n\n3. Cientifico-lhe que a contar do recebimento da presente, abre-se o prazo de 24 horas, para que, querendo, apresente resposta escrita com as provas que entender cabíveis. Fica advertido o acusado que a não entrega da justificação dentro do prazo estipulado, implicará em reconhecimento como verdadeiros os fatos imputados.\n\n[NOME, POSTO/GRADUAÇÃO E FUNÇÃO DO RESPONSÁVEL]`;
                    box.value = termo;
                });
        } else if(checks.length > 1) {
             const templateBase = `Termo de Justificação:\nTendo em vista as informações constantes na Parte Nº ___/___Pel/CAl/EsFAS/${anoAtual}, evidenciando a existência, em tese, de infração das Normas de Procedimentos e Condutas do Corpo de Alunos e proporcionando assegurar o direito de defesa, formulo o seguinte termo de justificação:\n\n1. Justificantes: Conforme lista de ${checks.length} alunos selecionados.\n\n2. Descrição da conduta infracional: Os militares selecionados, no dia ${dataExtenso}, ${descFato}. Com isso, incorreram ${regraDesc}.\n\n3. Cientifico-lhes que a contar do recebimento da presente, abre-se o prazo de 24 horas, para que, querendo, apresentem resposta escrita com as provas que entenderem cabíveis.\n\n[NOME, POSTO/GRADUAÇÃO E FUNÇÃO DO RESPONSÁVEL]`;
            box.value = templateBase;
        }
    };
});
</script>
{% endblock %}